<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TimuAnchi 銷售系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #0B4F7C;      /* 深藍色 - 主要按鈕、標題 */
            --secondary-color: #195A84;    /* 中藍色 - 次要元素 */
            --accent-color: #D4AF37;       /* 金黃色 - 強調、價格 */
            --highlight-color: #E89BA3;    /* 珊瑚粉紅 - 加購、特殊標記 */
            --text-dark: #2c3e50;
            --text-light: #6c757d;
            --bg-light: #f8f9fa;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --shadow: 0 2px 8px rgba(11, 79, 124, 0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #f8f4f1 100%);
            color: var(--text-dark);
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 5px 16px;
            box-shadow: 0 2px 12px rgba(11, 79, 124, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-color);  /* 金黃色標題 */
        }

        .menu-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid var(--accent-color);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            color: var(--accent-color);
            transition: all 0.3s;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .menu-icon {
            display: block;
        }

        /* 側邊選單 */
        .side-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 190px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1002;
            display: flex;
            flex-direction: column;
        }

        .side-menu.active {
            right: 0;
        }

        .side-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 2px solid var(--accent-color);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--accent-color);
        }

        .side-menu-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .menu-close {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .side-menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 7px 0px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark);
            transition: all 0.3s;
            margin-bottom: 8px;
            text-align: left;
        }

        .menu-item:hover {
            background: rgba(11, 79, 124, 0.08);
            border-left: 3px solid var(--accent-color);
            padding-left: 13px;
        }

        .menu-icon-text {
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
        }

        .menu-item-danger {
            color: #d32f2f;
        }

        .menu-item-danger:hover {
            background: #ffebee;
        }

        /* 遮罩層 */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1001;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Tab 導航列 */
        .tab-navigation {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .tab-nav-item {
            flex: 1;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
        }

        .tab-nav-item span:first-child {
            font-size: 16px;
        }

        .tab-nav-item span:last-child {
            font-size: 14px;
            font-weight: 500;
        }

        .tab-nav-item:hover {
            background: var(--bg-light);
        }

        .tab-nav-item.active {
            color: var(--primary-color);
            border-bottom: 4px solid var(--accent-color);
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
            font-weight: 600;
        }

        .tab-nav-item.active span:first-child {
            transform: scale(1.05);
        }

        .tab-nav-item.active span:last-child {
            font-weight: 600;
        }

        /* Tab 內容區 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 銷售記錄頁面 */
        .history-page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .time-filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .time-filter-btn {
            padding: 2px 6px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s;
        }

        .time-filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .date-range-picker {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
        }

        .date-range-picker input {
            border: 2px solid var(--border-color);
            border-radius: 6px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 5px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-icon {
            font-size: 30px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            border-radius: 12px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-light);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #d4af37;
        }

        .analysis-section {
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .analysis-section h3 {
            margin: 0 0 16px 0;
            font-size: 14px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-header h3 {
            margin: 0;
        }

        .top-list, .location-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .top-item, .location-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .top-rank {
            width: 32px;
            height: 32px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .top-rank.top1 { background: #FFD700; }
        .top-rank.top2 { background: #C0C0C0; }
        .top-rank.top3 { background: #CD7F32; }

        .top-info {
            flex: 1;
        }

        .top-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .top-details {
            font-size: 12px;
            color: var(--text-light);
        }

        .top-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .location-item {
            justify-content: space-between;
        }

        .location-name {
            font-size: 16px;
            font-weight: 600;
        }

        .location-stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
        }

        .location-stat-item {
            text-align: right;
        }

        .location-stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .location-stat-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* 折扣分析樣式 */
        .discount-list {
            margin-bottom: 24px;
        }

        .discount-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .discount-name {
            font-size: 12px;
            font-weight: 600;
        }

        .discount-stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
        }

        .discount-stat-item {
            text-align: right;
        }

        .discount-stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .discount-stat-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .history-header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .history-header h2 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 24px;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .history-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-bottom: 20px;
        }

        .history-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .history-action-btn:hover {
            background: #ffebee;
            border-color: #d32f2f;
            color: #d32f2f;
        }

        .history-list {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        /* 分頁樣式 */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            background: white;
            border-radius: 0 0 12px 12px;
            margin-top: -1px;
            flex-wrap: wrap;
        }

        .pagination-info {
            font-size: 11px;
            color: var(--text-light);
            margin: 0 4px;
            white-space: nowrap;
        }

        .pagination-btn {
            padding: 1px 4px;
            background: var(--bg-light);
            border: 1.5px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            color: var(--text-dark);
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-numbers {
            display: flex;
            gap: 4px;
        }

        .pagination-number {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            border: 1.5px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            color: var(--text-dark);
            transition: all 0.3s;
            font-weight: 500;
        }

        .pagination-number:hover {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination-number.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .file-controls {
            display: flex;
            gap: 8px;
        }

        .file-btn {
            padding: 2px 6px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .file-input {
            display: none;
        }

        .brand-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .brand-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: white;
            color: var(--text-light);
            transition: all 0.3s ease;
            position: relative;
        }

        .brand-tab.active {
            color: var(--primary-color);
            font-weight: 700;
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.12), transparent);
        }

        .brand-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--accent-color), transparent);
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
        }

        .category-section {
            background: white;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .category-scroll {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 12px;
        }

        .category-scroll::-webkit-scrollbar {
            display: none;
        }

        .category-buttons {
            display: flex;
            gap: 10px;
            min-width: min-content;
        }

        .category-btn {
            padding: 1px 6px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background: white;
            color: var(--text-dark);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .category-btn.active {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
        }

        .products-section {
            background: white;
            margin: 10px;
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
        }

        .products-scroll {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            margin: -8px;
            padding: 8px;
        }

        .products-grid {
            display: flex;
            gap: 6px;
            min-width: min-content;
        }

        .product-card {
            background: var(--bg-light);
            border-radius: 10px;
            padding: 7px;
            width: 150px;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: var(--secondary-color);
        }

        .product-card.sold-out {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f5f5f5;
            position: relative;
        }

        .product-card.sold-out:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--border-color);
        }

        .sold-out-label {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .product-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .product-sku {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .product-price {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .product-stock {
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
        }

        .product-variants {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            line-height: 1.3;
        }

        .order-section {
            background: white;
            margin: 10px;
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
            min-height: 250px;
        }

        .order-info-section {
            background: white;
            margin: 10px;
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
        }

        .order-info-form {
            margin-top: 16px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        .order-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .order-info-field {
            display: flex;
            flex-direction: column;
        }

        .order-info-field label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        .order-info-field input,
        .order-info-field select,
        .order-info-field textarea {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .order-info-field input:focus,
        .order-info-field select:focus,
        .order-info-field textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .order-info-field input[readonly] {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .order-info-field textarea {
            resize: vertical;
            min-height: 60px;
        }

        .order-info-divider {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 16px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        .order-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .clear-btn {
            padding: 2px 6px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .order-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .order-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .order-item-price {
            font-size: 13px;
            color: var(--text-light);
        }

        .order-item-controls {
            display: flex;
            align-items: center;
            gap: 1px;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 1px;
            background: white;
            border-radius: 6px;
            padding: 4px;
        }

        .qty-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: var(--secondary-color);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .qty-display {
            font-size: 15px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .delete-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: var(--danger-color);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .empty-order {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .discount-section {
            background: white;
            margin: 10px;
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
        }

        .addon-section {
            background: white;
            margin: 10px;
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
        }

        .addon-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--highlight-color);
        }

        .addon-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .addon-card {
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .addon-card:hover {
            border-color: var(--highlight-color);
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(232, 155, 163, 0.2);
        }

        .addon-card-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        .addon-card-price {
            font-size: 12px;
            font-weight: 600;
            color: var(--highlight-color);
        }

        .discount-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .discount-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .discount-btn {
            padding: 12px;
            background: linear-gradient(135deg, #E89BA3 0%, #DA7C88 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(232, 155, 163, 0.25);
            transition: all 0.3s;
        }

        .discount-btn:hover {
            background: linear-gradient(135deg, #DA7C88 0%, #D16775 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(232, 155, 163, 0.35);
        }

        .discount-btn:active {
            transform: translateY(0);
        }

        /* 贈品按鈕狀態 */
        .gift-btn-eligible {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.25);
        }

        .gift-btn-eligible:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.35);
        }

        .gift-btn-disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            box-shadow: 0 2px 6px rgba(153, 153, 153, 0.15);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .gift-btn-disabled:hover {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            transform: none;
            box-shadow: 0 2px 6px rgba(153, 153, 153, 0.15);
        }

        .gift-btn-applied {
            background: linear-gradient(135deg, #888 0%, #666 100%);
            box-shadow: 0 2px 6px rgba(102, 102, 102, 0.15);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .gift-btn-applied:hover {
            background: linear-gradient(135deg, #888 0%, #666 100%);
            transform: none;
            box-shadow: 0 2px 6px rgba(102, 102, 102, 0.15);
        }

        .total-section {
            background: white;
            margin: 10px;
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .total-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .total-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .final-total {
            display: flex;
            justify-content: space-between;
            padding-top: 16px;
            border-top: 2px solid var(--border-color);
            margin-top: 8px;
        }

        .final-total-label {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .final-total-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            background: var(--success-color);
            color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-light);
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 5px;
            overflow-y: auto;
        }

        .discount-list {
            margin-bottom: 24px;
        }

        .location-list {
            margin-bottom: 24px;
        }

        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .location-item-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .delete-location-btn {
            padding: 6px 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        .delete-location-btn:hover {
            background: #b71c1c;
        }

        .print-preview-content {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: "Noto Sans TC", "Microsoft JhengHei", "微軟正黑體", sans-serif;
            color: #000;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 1px solid #000;
        }

        .receipt-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
        }

        .receipt-shop-info {
            font-size: 10px;
            color: #000;
            line-height: 1.6;
        }

        .receipt-section {
            margin-bottom: 10px;
        }

        .receipt-section-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            padding: 6px 0;
            border-top: 1px solid #000;
            border-bottom: 1px solid #000;
            color: #000;
        }

        .receipt-info-row {
            display: flex;
            justify-content: flex-start;
            font-size: 10px;
            color: #000;
        }

        .receipt-info-label {
            color: #000;
        }

        .receipt-info-value {
            font-weight: 500;
            color: #000;
        }

        .receipt-items {
            border-top: 1px solid #000;
            border-bottom: 1px dashed #000;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 10px;
            color: #000;
        }

        .receipt-item-name {
            flex: 1;
            font-size: 12px;
            color: #000;
        }

        .receipt-item-qty {
            width: 35px;
            text-align: center;
            font-size: 12px;
            color: #000;
        }

        .receipt-item-price {
            width: 65px;
            text-align: right;
            font-size: 12px;
            color: #000;
        }

        .receipt-totals {
        }

        .receipt-total-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 10px;
            color: #000;
        }

        .receipt-total-row.final {
            font-size: 12px;
            font-weight: bold;
            border-top: 1px dashed #000;
            color: #000;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #000;
            font-size: 10px;
            color: #000;
        }

        @media print {
            /* 頁面設定 - 隱藏頁首頁尾 */
            @page {
                margin: 1cm;
                size: A4 portrait;
            }
            
            /* 移除瀏覽器預設的頁首頁尾 */
            html {
                margin: 0 !important;
            }
            
            body {
                margin: 0 !important;
            }
            
            /* 隱藏整個頁面 */
            body > * {
                display: none !important;
            }
            
            /* 只顯示列印預覽 modal */
            #printPreviewModal {
                display: block !important;
                position: static !important;
                background: none !important;
            }
            
            /* 移除 modal 樣式 */
            #printPreviewModal .modal-content {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background: none !important;
            }
            
            /* 隱藏 modal 的 header 和按鈕 */
            #printPreviewModal .modal-header,
            #printPreviewModal button,
            #printPreviewModal .modal-body > div:last-child {
                display: none !important;
            }
            
            /* 只顯示收據內容 */
            #printPreviewContent {
                display: block !important;
                margin: 0 !important;
            }
        }

        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .settings-section:last-of-type {
            border-bottom: none;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .social-link-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .social-link-item select {
            width: 140px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .social-link-item input {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .social-link-item button {
            padding: 8px 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .social-link-item button:hover {
            background: #b71c1c;
        }

        .sales-record-item {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 12px;
            border-left: 4px solid var(--secondary-color);
        }

        .sales-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        .delete-order-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .delete-order-btn:hover {
            opacity: 1;
        }

        .view-receipt-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .view-receipt-btn:hover {
            opacity: 1;
        }

        .cancelled-order-btn {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            cursor: default;
            opacity: 0.8;
        }

        .cancel-order-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cancel-order-btn:hover {
            background: #f57c00;
        }

        .order-cancelled-notice {
            color: #d32f2f;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
            padding: 5px;
            background: #ffebee;
        }

        .sales-detail {
            margin-top: 12px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                max-height: 500px;
                transform: translateY(0);
            }
        }

        .sales-record-order-number {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .sales-record-total {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .sales-record-info {
            font-size: 10px;
            color: #666;
            margin-bottom: 8px;
        }

        .sales-record-items {
        }

        .sales-record-item-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 4px 0;
            color: #666;
        }

        .discount-item-manage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .discount-item-info-manage {
            flex: 1;
        }

        .discount-item-name-manage {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .discount-item-desc {
            font-size: 13px;
            color: var(--text-light);
        }

        .delete-discount-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }

        .add-discount-form {
            background: var(--bg-light);
            padding: 16px;
            border-radius: 8px;
        }

        .add-discount-form h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .add-discount-form select,
        .add-discount-form input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .add-discount-form label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .add-discount-btn {
            width: 100%;
            padding: 12px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .variant-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            overflow-y: auto;
        }

        .variant-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .variant-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .variant-header {
            margin-bottom: 20px;
        }

        .variant-product-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .variant-product-sku {
            font-size: 13px;
            color: var(--text-light);
        }

        .variant-group {
            margin-bottom: 20px;
        }

        .variant-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .variant-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .variant-option {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-dark);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .variant-option:hover {
            border-color: var(--secondary-color);
        }

        .variant-option.selected {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
            font-weight: 600;
        }

        .variant-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .variant-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .variant-cancel {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .variant-confirm {
            background: var(--success-color);
            color: white;
        }

        .variant-group-builder {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .variant-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .variant-group-header input {
            flex: 1;
            margin-right: 10px;
            margin-bottom: 0;
        }

        .remove-variant-group-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .variant-options-builder {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .variant-option-builder {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-light);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .variant-option-builder input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            margin: 0;
        }

        .variant-sku-section {
            margin-top: 16px;
            padding: 12px;
            background: white;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .variant-sku-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .variant-sku-item {
            display: grid;
            grid-template-columns: 150px 150px 70px 70px;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-light);
            border-radius: 6px;
        }

        .variant-sku-label {
            font-size: 13px;
            color: var(--text-dark);
        }

        .variant-sku-input {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
        }
        
        .variant-price-input {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        .variant-stock-input {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        .remove-option-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-option-btn {
            padding: 6px 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 6px;
        }

        .empty-variants {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            font-size: 13px;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-light);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .category-item-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .product-edit-item {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .product-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .product-edit-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .product-edit-info {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .product-edit-actions {
            display: flex;
            gap: 6px;
        }

        .edit-product-btn {
            padding: 6px 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .delete-product-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        /* === 新增：搜尋框樣式 === */
        .search-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin: 10px 10px 10px 10px;
        }
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input {
            flex: 1;
            padding: 12px 70px 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(11, 79, 124, 0.1);
        }
        .search-icon {
            position: absolute;
            right: 12px;
            font-size: 18px;
            color: var(--text-light);
            pointer-events: none;
        }
        .search-clear {
            position: absolute;
            right: 40px;
            background: var(--text-light);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 16px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .search-clear.show {
            display: flex;
        }
        .search-results-count {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 8px;
            text-align: center;
        }

        /* === 新增：品牌管理樣式 === */
        .brand-manage-grid {
            display: grid;
            gap: 12px;
        }
        .brand-item-manage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        .brand-name-manage {
            font-weight: 600;
            color: var(--text-dark);
        }
        /* === 手機響應式樣式 === */
        @media (max-width: 768px) {
            .order-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <!-- html2pdf.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1 id="systemTitle">銷售系統</h1>
            <button class="menu-toggle" onclick="toggleMenu();">
                <span class="menu-icon">☰</span>
            </button>
        </div>
    </div>

    <!-- 側邊選單 -->
    <div id="sideMenu" class="side-menu">
        <div class="side-menu-header">
            <h3>系統選單</h3>
            <button class="menu-close" onclick="toggleMenu()">×</button>
        </div>
        <div class="side-menu-content">
            <button class="menu-item" onclick="openSystemConfig(); toggleMenu();">
                <span class="menu-icon-text">⚙️</span>
                <span>系統設定</span>
            </button>
            <button class="menu-item" onclick="openSystemSettings(); toggleMenu();">
                <span class="menu-icon-text">🏢</span>
                <span>基本資訊</span>
            </button>
            <button class="menu-item" onclick="openBrandManager(); toggleMenu();">
                <span class="menu-icon-text">🏷️</span>
                <span>品牌管理</span>
            </button>
            <div class="menu-divider"></div>
            <button class="menu-item" onclick="openImportModal(); toggleMenu();">
                <span class="menu-icon-text">📥</span>
                <span>匯入資料</span>
            </button>
            <button class="menu-item" onclick="openExportModal(); toggleMenu();">
                <span class="menu-icon-text">📤</span>
                <span>匯出資料</span>
            </button>
            <div class="menu-divider"></div>
            <button class="menu-item menu-item-danger" onclick="openClearDataModal(); toggleMenu();">
                <span class="menu-icon-text">🗑️</span>
                <span>清除資料</span>
            </button>
            <button class="menu-item menu-item-danger" onclick="confirmResetSystem(); toggleMenu();">
                <span class="menu-icon-text">🚨</span>
                <span>重置系統</span>
            </button>
        </div>
    </div>

    <!-- 遮罩層 -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>

    <!-- Tab 導航列 -->
    <div class="tab-navigation">
        <div class="tab-nav-item active" onclick="switchTab('sales')">
            <span>💰</span>
            <span>銷售</span>
        </div>
        <div class="tab-nav-item" onclick="switchTab('history')">
            <span>📊</span>
            <span>銷售記錄</span>
        </div>
    </div>

    <!-- 銷售頁面 -->
    <div id="salesTab" class="tab-content active">

    <!-- === 新增：商品搜尋框 === -->
    <div class="search-container">
        <div class="search-box">
            <input 
                type="text" 
                id="productSearch" 
                class="search-input" 
                placeholder="搜尋商品名稱或貨號..."
                oninput="searchProducts(this.value)"
            >
            <button class="search-clear" id="searchClear" onclick="clearSearch()">×</button>
            <span class="search-icon">🔍</span>
        </div>
        <div class="search-results-count" id="searchResultsCount"></div>
    </div>

    <div class="brand-tabs">
        <button class="brand-tab active" data-brand="ta">T&A選品</button>
        <button class="brand-tab" data-brand="ald">ALd.輕手作</button>
    </div>

    <div class="category-section">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 12px 8px 12px;">
            <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">大分類</div>
            <button class="file-btn" onclick="openCategoryManager()">⚙️ 管理</button>
        </div>
        <div class="category-scroll">
            <div class="category-buttons" id="categoryButtons"></div>
        </div>
    </div>

    <!-- 子分類 -->
    <div class="category-section" style="background: #fafafa;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 12px 8px 12px;">
            <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">小分類</div>
        </div>
        <div class="category-scroll">
            <div class="category-buttons" id="subCategoryButtons"></div>
        </div>
    </div>

    <div class="products-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
            <div style="font-size: 15px; font-weight: 600; color: var(--primary-color);">商品列表</div>
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <!-- 主畫面商品分頁控制（縮小版） -->
                <div id="mainProductPaginationContainer" class="pagination-container" style="display: none; padding: 2px 6px; margin: 0; background: white; border-radius: 4px;">
                    <button class="pagination-btn" id="mainProductPrevPageBtn" onclick="changeMainProductPage('prev')" style="padding: 0 3px; font-size: 9px; min-width: 16px; height: 18px;">←</button>
                    <div class="pagination-numbers" id="mainProductPageNumbers" style="gap: 2px;"></div>
                    <button class="pagination-btn" id="mainProductNextPageBtn" onclick="changeMainProductPage('next')" style="padding: 0 3px; font-size: 9px; min-width: 16px; height: 18px;">→</button>
                    <span class="pagination-info" id="mainProductPaginationInfo" style="font-size: 9px; margin: 0 2px;"></span>
                    <div style="display: flex; align-items: center; gap: 2px; margin-left: 4px;">
                        <span style="font-size: 9px; color: var(--text-light);">跳至</span>
                        <input type="number" id="mainProductPageJumpInput" min="1" style="width: 32px; height: 18px; padding: 1px 2px; font-size: 9px; border: 1px solid var(--border-color); border-radius: 3px; text-align: center;" onkeypress="if(event.key === 'Enter') jumpToMainProductPage()">
                        <button onclick="jumpToMainProductPage()" style="height: 18px; padding: 1px 6px; font-size: 9px; background: var(--primary-color); color: white; border: none; border-radius: 3px; cursor: pointer;">GO</button>
                    </div>
                </div>
                <button class="file-btn" onclick="openProductListManager()">📝 編輯</button>
                <button class="file-btn" onclick="openAddProductModal()">➕ 新增</button>
            </div>
        </div>
        <div class="products-scroll">
            <div class="products-grid" id="productsGrid"></div>
        </div>
    </div>

    <!-- 訂單資訊區 -->
    <div class="order-info-section">
        <div class="order-header">
            <div class="order-title">📝 訂單資訊</div>
            <button class="clear-btn" onclick="toggleOrderInfoForm()" style="background: var(--secondary-color);">
                <span id="orderInfoToggleIcon">▼</span> 顯示
            </button>
        </div>
        
        <div id="orderInfoForm" class="order-info-form" style="display: none;">
            <div class="order-info-grid">
                <div class="order-info-field">
                    <label>訂單編號</label>
                    <input type="text" id="orderNumber" placeholder="自動生成" readonly />
                </div>
                <div class="order-info-field">
                    <label>銷售日期</label>
                    <input type="text" id="orderDate" readonly />
                </div>
                <div class="order-info-field">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <span>銷售地點 *</span>
                        <button type="button" onclick="openLocationManager()" style="padding: 2px 8px; font-size: 11px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">⚙️ 管理</button>
                    </label>
                    <select id="saleLocation">
                        <option value="">請選擇</option>
                    </select>
                </div>
                <div class="order-info-field">
                    <label>銷售人員</label>
                    <input type="text" id="salesPerson" placeholder="請輸入姓名" />
                </div>
            </div>
            
            <div class="order-info-divider">👤 顧客資訊</div>
            
            <div class="order-info-grid">
                <div class="order-info-field">
                    <label>會員帳號</label>
                    <input type="text" id="memberAccount" placeholder="會員ID或帳號" />
                </div>
                <div class="order-info-field">
                    <label>會員名稱</label>
                    <input type="text" id="memberName" placeholder="請輸入姓名" />
                </div>
                <div class="order-info-field">
                    <label>聯絡電話</label>
                    <input type="tel" id="memberPhone" placeholder="09XX-XXX-XXX" />
                </div>
                <div class="order-info-field">
                    <label>電子信箱</label>
                    <input type="email" id="memberEmail" placeholder="example@email.com" />
                </div>
            </div>
            
            <div class="order-info-field">
                <label>備註</label>
                <textarea id="orderNote" placeholder="訂單備註說明..." rows="2"></textarea>
            </div>
        </div>
    </div>

    <div class="order-section">
        <div class="order-header">
            <div class="order-title">📋 訂單明細</div>
            <button class="clear-btn" onclick="clearOrder()">清空</button>
        </div>
        <div class="order-list" id="orderList">
            <div class="empty-order">
                <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;">🛍️</div>
                <div>尚無商品，請選擇商品加入訂單</div>
            </div>
        </div>
    </div>

    <!-- 加購項目 -->
    <div class="addon-section">
        <div class="order-header">
            <div class="addon-title">🎁 加購項目</div>
            <div style="display: flex; gap: 8px;">
                <button class="file-btn" onclick="openAddonManager()">📝 編輯</button>
                <button class="file-btn" onclick="openAddAddonModal()">➕ 新增</button>
            </div>
        </div>
        <div class="addon-grid" id="addonGrid"></div>
    </div>

    <div class="discount-section">
        <div class="order-header">
            <div class="discount-title">🎁 優惠折扣</div>
            <div style="display: flex; gap: 8px;">
                <button class="file-btn" onclick="openDiscountManager()">✏️ 編輯</button>
                <button class="file-btn" onclick="openAddDiscountModal()">➕ 新增</button>
            </div>
        </div>
        <div class="discount-grid" id="discountButtons"></div>
    </div>

    <!-- 滿額贈品 -->
    <div class="discount-section">
        <div class="order-header">
            <div class="discount-title">🎁 滿額贈品</div>
            <div style="display: flex; gap: 8px;">
                <button class="file-btn" onclick="openGiftManager()">✏️ 編輯</button>
                <button class="file-btn" onclick="openAddGiftModal()">➕ 新增</button>
            </div>
        </div>
        <div class="discount-grid" id="giftButtons"></div>
    </div>

    <!-- 小計總計 -->
    <div class="total-section">
        <div class="total-row">
            <span class="total-label">小計：</span>
            <span class="total-value" id="subtotal">NT$ 0</span>
        </div>
        <div class="total-row">
            <span class="total-label">折扣：</span>
            <span class="total-value" id="discount">NT$ 0</span>
        </div>
        <div class="final-total">
            <span class="final-total-label">總計：</span>
            <span class="final-total-value" id="total">NT$ 0</span>
        </div>
        <div style="display: flex; gap: 8px;">
            <button class="checkout-btn" id="checkoutBtn" onclick="checkout()" disabled style="flex: 1;">💳 結帳</button>
            <button class="checkout-btn" id="printPreviewBtn" onclick="openPrintPreview()" disabled style="flex: 1; background: var(--secondary-color);">🖨️ 列印預覽</button>
        </div>
    </div>

    </div>
    <!-- 銷售頁面結束 -->

    <!-- 折扣管理彈窗 -->
    <div id="discountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯折扣</h3>
                <button class="modal-close" onclick="closeDiscountManager()">×</button>
            </div>
            <div class="modal-body">
                <div class="discount-list" id="discountList"></div>
            </div>
        </div>
    </div>

    <!-- 新增折扣彈窗 -->
    <div id="addDiscountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增折扣</h3>
                <button class="modal-close" onclick="closeAddDiscountModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-discount-form">
                    <select id="addDiscountType" onchange="updateAddDiscountForm()">
                        <option value="percent">百分比折扣</option>
                        <option value="fixed">固定金額折扣</option>
                        <option value="minAmountPercent">滿額百分比折扣</option>
                        <option value="minAmountFixed">滿額固定金額折扣</option>
                        <option value="buyNPercent">任選N件百分比折扣</option>
                        <option value="buyNFixed">任選N件固定金額折扣</option>
                    </select>
                    <div id="addDiscountFormFields"></div>
                    <button class="add-discount-btn" onclick="addNewDiscountFromModal()">➕ 新增折扣</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯折扣表單彈窗 -->
    <div id="editDiscountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯折扣</h3>
                <button class="modal-close" onclick="closeEditDiscountModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-discount-form">
                    <select id="editDiscountType" onchange="updateEditDiscountForm()">
                        <option value="percent">百分比折扣</option>
                        <option value="fixed">固定金額折扣</option>
                        <option value="minAmountPercent">滿額百分比折扣</option>
                        <option value="minAmountFixed">滿額固定金額折扣</option>
                        <option value="buyNPercent">任選N件百分比折扣</option>
                        <option value="buyNFixed">任選N件固定金額折扣</option>
                    </select>
                    <div id="editDiscountFormFields"></div>
                    <button class="add-discount-btn" onclick="updateDiscount()">💾 更新折扣</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 贈品管理彈窗 -->
    <div id="giftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>管理贈品</h3>
                <button class="modal-close" onclick="closeGiftManager()">×</button>
            </div>
            <div class="modal-body">
                <div class="discount-list" id="giftList"></div>
            </div>
        </div>
    </div>

    <!-- 編輯贈品彈窗 -->
    <div id="editGiftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯贈品</h3>
                <button class="modal-close" onclick="closeEditGiftModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-discount-form">
                    <div class="form-group">
                        <label>活動名稱</label>
                        <input type="text" id="editGiftName" placeholder="例如：滿500送面膜" />
                    </div>
                    <div class="form-group">
                        <label>條件類型</label>
                        <select id="editGiftConditionType" onchange="updateEditGiftForm()">
                            <option value="minAmount">滿額贈送</option>
                            <option value="minItems">滿件贈送</option>
                        </select>
                    </div>
                    <div id="editGiftConditionField"></div>
                    <div class="form-group">
                        <label>贈品名稱</label>
                        <input type="text" id="editGiftItemName" placeholder="例如：保濕面膜" />
                    </div>
                    <div class="form-group">
                        <label>贈品貨號(選填)</label>
                        <input type="text" id="editGiftItemSku" placeholder="例如：GIFT001" />
                    </div>
                    <div class="form-group">
                        <label>贈品數量</label>
                        <input type="number" id="editGiftItemQty" min="1" value="1" placeholder="例如：1" />
                    </div>
                    <div class="form-group">
                        <label>庫存數量(選填)</label>
                        <input type="number" id="editGiftItemStock" min="0" placeholder="例如：100" />
                    </div>
                    <button class="add-discount-btn" onclick="updateGift()">💾 更新贈品</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增贈品彈窗 -->
    <div id="addGiftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增贈品</h3>
                <button class="modal-close" onclick="closeAddGiftModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-discount-form">
                    <div class="form-group">
                        <label>贈品活動名稱</label>
                        <input type="text" id="addGiftName" placeholder="例如：滿500送面膜" />
                    </div>
                    <div class="form-group">
                        <label>條件類型</label>
                        <select id="addGiftConditionType" onchange="updateAddGiftForm()">
                            <option value="minAmount">滿額贈送</option>
                            <option value="minItems">滿件贈送</option>
                        </select>
                    </div>
                    <div id="addGiftConditionField"></div>
                    <div class="form-group">
                        <label>贈品名稱</label>
                        <input type="text" id="addGiftItemName" placeholder="例如：保濕面膜" />
                    </div>
                    <div class="form-group">
                        <label>贈品貨號(選填)</label>
                        <input type="text" id="addGiftItemSku" placeholder="例如：GIFT001" />
                    </div>
                    <div class="form-group">
                        <label>贈品數量</label>
                        <input type="number" id="addGiftItemQty" min="1" value="1" placeholder="例如：1" />
                    </div>
                    <div class="form-group">
                        <label>贈品庫存數量(選填)</label>
                        <input type="number" id="addGiftItemStock" min="0" placeholder="例如：100" />
                    </div>
                    <button class="add-discount-btn" onclick="addNewGift()">➕ 新增贈品</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加購項目管理彈窗 -->
    <div id="addonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>加購項目編輯</h3>
                <button class="modal-close" onclick="closeAddonManager()">×</button>
            </div>
            <div class="modal-body">
                <div class="discount-list" id="addonList"></div>
            </div>
        </div>
    </div>

    <!-- 新增加購項目彈窗 -->
    <div id="addAddonModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="addonModalTitle">新增加購項目</h3>
                <button class="modal-close" onclick="closeAddAddonModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-discount-form">
                    <div class="form-group">
                        <label>項目名稱 *</label>
                        <input type="text" id="newAddonName" placeholder="例如：精美禮盒" />
                    </div>

                    <div class="form-group">
                        <label>項目主貨號</label>
                        <input type="text" id="newAddonSku" placeholder="例如：GIFT-001" />
                    </div>

                    <div class="form-group" id="addonTotalPriceDisplay" style="display: none;">
                        <label>項目價格區間（由各規格價格自動計算）</label>
                        <input type="text" id="addonDisplayTotalPrice" readonly style="background: #f5f5f5; cursor: not-allowed;" />
                    </div>

                    <div class="form-group" id="addonSimplePriceSection">
                        <label>項目價格 *</label>
                        <input type="number" id="newAddonPrice" min="0" placeholder="例如：80" />
                    </div>

                    <div class="form-group" id="addonTotalStockDisplay" style="display: none;">
                        <label>庫存總和（由各規格庫存自動計算）</label>
                        <input type="text" id="addonDisplayTotalStock" readonly style="background: #f5f5f5; cursor: not-allowed;" />
                    </div>

                    <div class="form-group" id="addonSimpleStockSection">
                        <label>項目庫存</label>
                        <input type="number" id="newAddonStock" min="0" placeholder="例如：20" />
                    </div>

                    <div class="form-group">
                        <label style="display: flex; justify-content: space-between; align-items: center;">
                            <span>項目規格</span>
                            <button type="button" class="file-btn" onclick="addAddonVariantGroup()">➕ 新增規格</button>
                        </label>
                        <div id="addonVariantGroupsContainer"></div>
                        <button type="button" class="file-btn" onclick="generateAddonVariantCombinations()" style="width: 100%; margin-top: 8px;">🔄 產生規格組合</button>
                        <div id="addonVariantSkuSection" style="display: none;">
                            <div class="variant-sku-section">
                                <div class="variant-sku-title">📦 規格貨號、價格、庫存設定</div>
                                <div id="addonVariantSkuList"></div>
                            </div>
                        </div>
                    </div>

                    <button class="add-discount-btn" onclick="saveNewAddon()">💾 儲存項目</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 銷售地點管理彈窗 -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>銷售地點管理</h3>
                <button class="modal-close" onclick="closeLocationManager()">×</button>
            </div>
            <div class="modal-body">
                <div class="location-list" id="locationList"></div>
                <div class="add-discount-form">
                    <h4>新增銷售地點</h4>
                    <input type="text" id="newLocationName" placeholder="例如：新竹門市" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; margin-bottom: 12px;" />
                    <button class="add-discount-btn" onclick="addNewLocation()">➕ 新增地點</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 銷售記錄頁面 -->
    <div id="historyTab" class="tab-content">
        <div class="history-page-container">
            <!-- 時間篩選 -->
            <div class="time-filter-bar">
                <button class="time-filter-btn active" data-filter="all" onclick="filterByTime('all')">全部</button>
                <button class="time-filter-btn" data-filter="today" onclick="filterByTime('today')">今日</button>
                <button class="time-filter-btn" data-filter="yesterday" onclick="filterByTime('yesterday')">昨天</button>
                <button class="time-filter-btn" data-filter="dayBeforeYesterday" onclick="filterByTime('dayBeforeYesterday')">前天</button>
                <button class="time-filter-btn" data-filter="week" onclick="filterByTime('week')">本週</button>
                <button class="time-filter-btn" data-filter="month" onclick="filterByTime('month')">本月</button>
                <button class="time-filter-btn" data-filter="year" onclick="filterByTime('year')">本年</button>
                <div class="date-range-picker">
                    <input type="date" id="filterStartDate" onchange="filterByTime('custom')">
                    <span>~</span>
                    <input type="date" id="filterEndDate" onchange="filterByTime('custom')">
                </div>
            </div>

            <!-- 統計卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-info">
                        <div class="stat-label">總銷售額</div>
                        <div class="stat-value" id="statRevenue">NT$ 0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📦</div>
                    <div class="stat-info">
                        <div class="stat-label">訂單數量</div>
                        <div class="stat-value" id="statOrders">0 筆</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-info">
                        <div class="stat-label">平均客單價</div>
                        <div class="stat-value" id="statAvg">NT$ 0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🎁</div>
                    <div class="stat-info">
                        <div class="stat-label">商品銷量</div>
                        <div class="stat-value" id="statItems">0 件</div>
                    </div>
                </div>
            </div>

            <!-- 訂單列表 -->
            <div class="analysis-section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <h3>📋 歷史訂單</h3>
                    <div id="paginationContainer" class="pagination-container" style="display: none; padding: 0; margin: 0; background: transparent; border-radius: 0;">
                        <button class="pagination-btn" id="prevPageBtn" onclick="changePage('prev')">←</button>
                        <div class="pagination-numbers" id="pageNumbers"></div>
                        <button class="pagination-btn" id="nextPageBtn" onclick="changePage('next')">→</button>
                        <span class="pagination-info" id="paginationInfo" style="font-size: 10px;"></span>
                    </div>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>

            <!-- 熱賣商品 -->
            <div class="analysis-section">
                <h3>🔥 熱賣商品 TOP 10</h3>
                <div id="topProductsList" class="top-list"></div>
            </div>

            <!-- 折扣使用 -->
            <div class="analysis-section">
                <h3>🎟️ 折扣使用分析</h3>
                <div id="discountAnalysis" class="discount-list"></div>
            </div>
            
            <!-- 銷售地點 -->
            <div class="analysis-section">
                <h3>📍 銷售地點分析</h3>
                <div id="locationAnalysis" class="location-list"></div>
            </div>
        </div>
    </div>
    <!-- 銷售記錄頁面結束 -->

    <!-- 匯入資料彈窗 -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>📥 匯入資料</h3>
                <button class="modal-close" onclick="closeImportModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">請選擇要匯入的資料類型：</p>
                <input type="file" id="importProductFile" class="file-input" accept=".xlsx,.xls" style="display: none;">
                <input type="file" id="importAddonFile" class="file-input" accept=".xlsx,.xls" style="display: none;">
                <input type="file" id="importGiftFile" class="file-input" accept=".xlsx,.xls" style="display: none;">
                <input type="file" id="importGiftFile" class="file-input" accept=".xlsx,.xls" style="display: none;">
                <button class="add-discount-btn" onclick="openProductImportOptionsModal()" style="width: 100%; margin-bottom: 12px;">
                    📦 匯入商品資料
                </button>
                <button class="add-discount-btn" onclick="openAddonImportOptionsModal()" style="width: 100%; margin-bottom: 12px; background: var(--highlight-color);">
                    🎁 匯入加購項目
                </button>
                <button class="add-discount-btn" onclick="openGiftImportOptionsModal()" style="width: 100%; margin-bottom: 12px; background: var(--success-color);">
                    🎁 匯入贈品資料
                </button>
            </div>
        </div>
    </div>

    <!-- 商品匯入選項彈窗 -->
    <div id="productImportOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>📥 匯入商品資料</h3>
                <button class="modal-close" onclick="closeProductImportOptionsModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="file" id="importProductFile" class="file-input" accept=".xlsx,.xls" style="display: none;">
                
                <button class="add-discount-btn" onclick="downloadProductExample()" style="width: 100%; margin-bottom: 12px; background: var(--highlight-color); font-size: 12px;">
                    📄 下載商品資料欄位說明(副檔名為.xlsx)
                </button>
                
                <button class="add-discount-btn" onclick="downloadProductTemplate()" style="width: 100%; margin-bottom: 12px; background: var(--success-color); font-size: 12px;">
                    📋 下載商品資料空白檔(副檔名為.xlsx)
                </button>
                
                <button class="add-discount-btn" onclick="document.getElementById('importProductFile').click()" style="width: 100%; background: var(--primary-color); font-size: 12px;">
                    📁 匯入商品資料(副檔名為.xlsx)
                </button>
            </div>
        </div>
    </div>

    <!-- 加購項目匯入選項彈窗 -->
    <div id="addonImportOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>📥 匯入加購項目</h3>
                <button class="modal-close" onclick="closeAddonImportOptionsModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="file" id="importAddonFile" class="file-input" accept=".xlsx,.xls" style="display: none;">
                
                <button class="add-discount-btn" onclick="downloadAddonExample()" style="width: 100%; margin-bottom: 12px; background: var(--highlight-color); font-size: 12px;">
                    📄 下載加購項目資料欄位說明(副檔名為.xlsx)
                </button>
                
                <button class="add-discount-btn" onclick="downloadAddonTemplate()" style="width: 100%; margin-bottom: 12px; background: var(--success-color); font-size: 12px;">
                    📋 下載加購項目資料空白檔(副檔名為.xlsx)
                </button>
                
                <button class="add-discount-btn" onclick="document.getElementById('importAddonFile').click()" style="width: 100%; background: var(--primary-color); font-size: 12px;">
                    📁 匯入加購項目資料(副檔名為.xlsx)
                </button>
            </div>
        </div>
    </div>

    <!-- 贈品匯入選項彈窗 -->
    <div id="giftImportOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>📥 匯入贈品資料</h3>
                <button class="modal-close" onclick="closeGiftImportOptionsModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="file" id="importGiftFile" class="file-input" accept=".xlsx,.xls" style="display: none;">
                
                <button class="add-discount-btn" onclick="downloadGiftExample()" style="width: 100%; margin-bottom: 12px; background: var(--highlight-color); font-size: 12px;">
                    📄 下載贈品資料欄位說明(副檔名為.xlsx)
                </button>
                
                <button class="add-discount-btn" onclick="downloadGiftTemplate()" style="width: 100%; margin-bottom: 12px; background: var(--success-color); font-size: 12px;">
                    📋 下載贈品資料空白檔(副檔名為.xlsx)
                </button>
                
                <button class="add-discount-btn" onclick="document.getElementById('importGiftFile').click()" style="width: 100%; background: var(--primary-color); font-size: 12px;">
                    📁 匯入贈品資料(副檔名為.xlsx)
                </button>
            </div>
        </div>
    </div>

    <!-- 匯出資料彈窗 -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>📤 匯出資料</h3>
                <button class="modal-close" onclick="closeExportModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">請選擇要匯出的資料類型：</p>
                <button class="add-discount-btn" onclick="confirmExportProducts()" style="width: 100%; margin-bottom: 12px;">
                    📦 匯出商品資料
                </button>
                <button class="add-discount-btn" onclick="confirmExportAddons()" style="width: 100%; margin-bottom: 12px; background: var(--highlight-color);">
                    🎁 匯出加購項目
                </button>
                <button class="add-discount-btn" onclick="confirmExportGifts()" style="width: 100%; margin-bottom: 12px; background: var(--success-color);">
                    🎁 匯出贈品資料
                </button>
                <button class="add-discount-btn" onclick="confirmExportSales()" style="width: 100%; background: var(--secondary-color);">
                    📊 匯出銷售記錄
                </button>
            </div>
        </div>
    </div>

    <!-- 品牌選擇彈窗（用於商品匯出） -->
    <div id="brandSelectModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>📦 選擇匯出品牌</h3>
                <button class="modal-close" onclick="closeBrandSelectModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">請選擇要匯出的品牌：</p>
                
                <div id="brandSelectOptions" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- 品牌選項將動態生成在這裡 -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="add-discount-btn" onclick="executeBrandExport()" style="flex: 1; background: var(--primary-color);">
                        確認匯出
                    </button>
                    <button class="add-discount-btn" onclick="closeBrandSelectModal()" style="flex: 1; background: #999;">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 清除資料彈窗 -->
    <div id="clearDataModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>🗑️ 清除資料</h3>
                <button class="modal-close" onclick="closeClearDataModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: #d32f2f; margin-bottom: 20px; font-size: 14px; font-weight: 600;">⚠️ 此操作無法復原，請謹慎選擇！</p>
                <button class="add-discount-btn" onclick="confirmClearProducts()" style="width: 100%; margin-bottom: 12px; background: #ff9800;">
                    📦 清除商品資料
                </button>
                <button class="add-discount-btn" onclick="confirmClearSales()" style="width: 100%; margin-bottom: 12px; background: var(--danger-color);">
                    📊 清除銷售記錄
                </button>
                <button class="add-discount-btn" onclick="confirmClearAddons()" style="width: 100%; margin-bottom: 12px; background: #ffc107;">
                    🛒 清除加購項目
                </button>
                <button class="add-discount-btn" onclick="confirmClearGifts()" style="width: 100%; margin-bottom: 12px; background: #ffc107;">
                    🎁 清除贈品規則
                </button>
                <button class="add-discount-btn" onclick="confirmClearDiscounts()" style="width: 100%; background: #ffc107;">
                    💰 清除折扣設定
                </button>
            </div>
        </div>
    </div>

    <!-- 列印預覽彈窗 -->
    <div id="printPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>🖨️ 列印預覽</h3>
                <button class="modal-close" onclick="closePrintPreview()">×</button>
            </div>
            <div class="modal-body">
                <div id="printPreviewContent" class="print-preview-content"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                    <button class="add-discount-btn" onclick="printReceipt()" style="flex: 1;">🖨️ 列印</button>
                    <button class="add-discount-btn" onclick="downloadPDF()" style="flex: 1; background: #2E8B57;">📄 轉成PDF</button>
                    <button class="add-discount-btn" onclick="closePrintPreview()" style="flex: 1; background: #666;">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 系統配置彈窗 -->
    <div id="systemConfigModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>⚙️ 系統設定</h3>
                <button class="modal-close" onclick="closeSystemConfig()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>系統名稱</label>
                    <input type="text" id="config_systemName" placeholder="例如：TimuAnchi 銷售系統" />
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">顯示在標題列</div>
                </div>
                
                <div class="form-group">
                    <label>配色主題</label>
                    <div class="theme-selector" onclick="openThemeModal()" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: white;">
                        <span id="currentThemeDisplay" style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #0B4F7C; font-size: 20px;">●</span>
                            <span>經典藍</span>
                        </span>
                        <span style="color: #999;">▼</span>
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">點擊可更換配色</div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="add-discount-btn" onclick="saveSystemConfig()" style="flex: 1;">💾 儲存設定</button>
                    <button class="add-discount-btn" onclick="closeSystemConfig()" style="flex: 1; background: #666;">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 配色選擇彈窗 -->
    <div id="themeModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3>🎨 選擇配色主題</h3>
                <button class="modal-close" onclick="closeThemeModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="themeOptions" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- 配色選項將由 JavaScript 動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 系統設定彈窗 -->
    <div id="systemSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>🏢 基本資訊</h3>
                <button class="modal-close" onclick="closeSystemSettings()">×</button>
            </div>
            <div class="modal-body">
                <!-- 店家資訊 -->
                <div class="settings-section">
                    <h4 class="settings-section-title">🏢 店家資訊</h4>
                    <div class="form-group">
                        <label>店家名稱</label>
                        <input type="text" id="setting_shopName" placeholder="例如：TimuAnchi" />
                    </div>
                    <div class="form-group">
                        <label>統一編號</label>
                        <input type="text" id="setting_taxId" placeholder="例如：12345678" />
                    </div>
                    <div class="form-group">
                        <label>聯絡電話</label>
                        <input type="text" id="setting_phone" placeholder="例如：(02) 1234-5678" />
                    </div>
                    <div class="form-group">
                        <label>店家地址</label>
                        <input type="text" id="setting_address" placeholder="例如：台北市XX區XX路XX號" />
                    </div>
                    <div class="form-group">
                        <label>官方網站</label>
                        <input type="text" id="setting_website" placeholder="例如：www.timuanchi.com" />
                    </div>
                </div>

                <!-- 社群連結 -->
                <div class="settings-section">
                    <h4 class="settings-section-title">📱 社群連結</h4>
                    <div id="socialLinksList"></div>
                    <div style="margin-top: 12px;">
                        <button class="add-discount-btn" onclick="addSocialLinkInput()" style="padding: 8px 16px; font-size: 13px;">➕ 新增社群</button>
                    </div>
                </div>

                <!-- 收據設定 -->
                <div class="settings-section">
                    <h4 class="settings-section-title">🧾 收據設定</h4>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="setting_showTaxId" checked />
                            顯示統一編號
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="setting_showPhone" checked />
                            顯示聯絡電話
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="setting_showAddress" checked />
                            顯示店家地址
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="setting_showWebsite" checked />
                            顯示官方網站
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="setting_showSocial" checked />
                            顯示社群連結
                        </label>
                    </div>
                    <div class="form-group">
                        <label>收據頁尾文字</label>
                        <textarea id="setting_footerText" rows="3" placeholder="例如：感謝您的購買！&#10;歡迎再次光臨">感謝您的購買！
歡迎再次光臨</textarea>
                    </div>
                </div>

                <!-- 儲存按鈕 -->
                <div style="display: flex; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                    <button class="add-discount-btn" onclick="saveSystemSettings()" style="flex: 1;">💾 儲存設定</button>
                    <button class="add-discount-btn" onclick="closeSystemSettings()" style="flex: 1; background: #666;">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 規格選擇彈窗 -->
    <div id="variantModal" class="variant-modal">
        <div class="variant-content">
            <div class="variant-header">
                <div class="variant-product-name" id="variantProductName"></div>
                <div class="variant-product-sku" id="variantProductSku"></div>
                <div style="font-size: 18px; font-weight: 700; color: var(--accent-color); margin-top: 8px;" id="variantProductPrice"></div>
                <div style="font-size: 14px; color: #666; margin-top: 4px;" id="variantProductStock"></div>
            </div>
            <div id="variantGroups"></div>
            <div class="variant-actions">
                <button class="variant-btn variant-cancel" onclick="closeVariantModal()">取消</button>
                <button class="variant-btn variant-confirm" id="variantConfirmBtn" onclick="confirmAddToOrder()">加到訂單明細</button>
            </div>
        </div>
    </div>

    <!-- 新增商品彈窗 -->
    <div id="addProductModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="productModalTitle">新增商品</h3>
                <button class="modal-close" onclick="closeAddProductModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-discount-form">
                    <div class="form-group">
                        <label>品牌 *</label>
                        <select id="newProductBrand">
                            <!-- 品牌選項將由 JavaScript 動態生成 -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>大分類</label>
                        <select id="newProductMainCategory" onchange="updateSubCategoryDropdown()"></select>
                    </div>

                    <div class="form-group">
                        <label>小分類</label>
                        <select id="newProductSubCategory"></select>
                    </div>

                    <div class="form-group">
                        <label>商品名稱 *</label>
                        <input type="text" id="newProductName" placeholder="例如：珍珠耳環" />
                    </div>

                    <div class="form-group">
                        <label>商品主貨號</label>
                        <input type="text" id="newProductSku" placeholder="例如：ZALD00001" />
                    </div>

                    <div class="form-group" id="totalPriceDisplay" style="display: none;">
                        <label>價格區間（由各規格價格自動計算）</label>
                        <input type="text" id="displayTotalPrice" readonly style="background: #f5f5f5; cursor: not-allowed;" />
                    </div>

                    <div class="form-group" id="simplePriceSection">
                        <label>價格 *</label>
                        <input type="number" id="newProductPrice" min="0" placeholder="例如：380" />
                    </div>

                    <div class="form-group" id="totalStockDisplay" style="display: none;">
                        <label>庫存總和（由各規格庫存自動計算）</label>
                        <input type="text" id="displayTotalStock" readonly style="background: #f5f5f5; cursor: not-allowed;" />
                    </div>

                    <div class="form-group" id="simpleStockSection">
                        <label>庫存數量</label>
                        <input type="number" id="newProductStock" min="0" placeholder="例如：10" />
                    </div>

                    <div class="form-group">
                        <label style="display: flex; justify-content: space-between; align-items: center;">
                            <span>商品規格</span>
                            <button type="button" class="file-btn" onclick="addVariantGroup()">➕ 新增規格</button>
                        </label>
                        <div id="variantGroupsContainer"></div>
                        <button type="button" class="file-btn" onclick="generateVariantCombinations()" style="width: 100%; margin-top: 8px;">🔄 產生規格組合</button>
                        <div id="variantSkuSection" style="display: none;">
                            <div class="variant-sku-section">
                                <div class="variant-sku-title">📦 規格貨號、價格、庫存設定</div>
                                <div id="variantSkuList"></div>
                            </div>
                        </div>
                    </div>

                    <button class="add-discount-btn" onclick="saveNewProduct()">💾 儲存商品</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 分類管理彈窗 -->
    <div id="categoryManagerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>分類管理</h3>
                <button class="modal-close" onclick="closeCategoryManager()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-discount-form">
                    <div class="form-group">
                        <label>選擇品牌</label>
                        <select id="categoryBrand" onchange="loadCategoryList()">
                            <option value="ta">T&A選品</option>
                            <option value="ald">ALd.輕手作</option>
                        </select>
                    </div>

                    <h4 style="margin: 20px 0 12px 0; color: var(--primary-color);">大分類列表</h4>
                    <div id="mainCategoryList" style="margin-bottom: 20px;"></div>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 24px;">
                        <input type="text" id="newMainCategoryName" placeholder="輸入新的大分類名稱" style="flex: 1; margin: 0;" />
                        <button class="file-btn" onclick="addMainCategory()">新增</button>
                    </div>

                    <h4 style="margin: 20px 0 12px 0; color: var(--primary-color);">小分類列表</h4>
                    <div class="form-group">
                        <label>選擇大分類</label>
                        <select id="selectedMainCategoryForSub" onchange="loadSubCategoryList()"></select>
                    </div>
                    <div id="subCategoryList" style="margin-bottom: 20px;"></div>
                    
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newSubCategoryName" placeholder="輸入新的小分類名稱" style="flex: 1; margin: 0;" />
                        <button class="file-btn" onclick="addSubCategory()">新增</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === 新增：品牌管理模態框 === -->
    <div id="brandManagerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>🏷️ 品牌管理</h3>
                <button class="modal-close" onclick="closeBrandManager()">×</button>
            </div>
            <div class="modal-body">
                <div class="brand-manage-grid" id="brandManageList">
                    <!-- 品牌列表動態生成 -->
                </div>
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <input 
                        type="text" 
                        id="newBrandInput" 
                        placeholder="輸入新品牌名稱"
                        style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                    >
                    <button 
                        class="file-btn" 
                        onclick="addNewBrand()"
                        style="padding: 12px 24px;"
                    >
                        新增
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 商品列表管理彈窗 -->
    <div id="productListModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>📦 商品編輯</h3>
                <button class="modal-close" onclick="closeProductListManager()">×</button>
            </div>
            <div class="modal-body">
                <!-- 篩選區域 -->
                <div style="background: var(--bg-light); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="font-size: 13px; color: #666; margin-bottom: 4px; display: block;">品牌</label>
                            <select id="filterBrand" onchange="filterProductList()" style="width: 100%; padding: 8px; border: 2px solid var(--border-color); border-radius: 6px;">
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 13px; color: #666; margin-bottom: 4px; display: block;">大分類</label>
                            <select id="filterMainCategory" onchange="filterProductList()" style="width: 100%; padding: 8px; border: 2px solid var(--border-color); border-radius: 6px;">
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 13px; color: #666; margin-bottom: 4px; display: block;">小分類</label>
                            <select id="filterSubCategory" onchange="filterProductList()" style="width: 100%; padding: 8px; border: 2px solid var(--border-color); border-radius: 6px;">
                                <option value="">全部</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <input type="text" id="searchProduct" placeholder="🔍 搜尋商品名稱或貨號..." onkeyup="filterProductList()" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <!-- 商品列表分頁控制（移到搜尋欄下方） -->
                    <div id="productPaginationContainer" class="pagination-container" style="display: none; padding: 8px 0; margin: 12px 0 0 0; background: transparent; border-radius: 0;">
                        <button class="pagination-btn" id="productPrevPageBtn" onclick="changeProductPage('prev')">←</button>
                        <div class="pagination-numbers" id="productPageNumbers"></div>
                        <button class="pagination-btn" id="productNextPageBtn" onclick="changeProductPage('next')">→</button>
                        <span class="pagination-info" id="productPaginationInfo" style="font-size: 10px;"></span>
                        <div style="display: flex; align-items: center; gap: 4px; margin-left: 8px;">
                            <span style="font-size: 10px; color: var(--text-light);">跳至</span>
                            <input type="number" id="productPageJumpInput" min="1" style="width: 40px; height: 22px; padding: 2px 4px; font-size: 10px; border: 1.5px solid var(--border-color); border-radius: 4px; text-align: center;" onkeypress="if(event.key === 'Enter') jumpToProductPage()">
                            <button onclick="jumpToProductPage()" style="height: 22px; padding: 2px 8px; font-size: 10px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">GO</button>
                        </div>
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div id="productListContent" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // 新資料結構：平面式商品陣列
        let products = [];  // 所有商品的陣列
        let nextProductId = 1;  // 商品ID計數器
        
        // 品牌對照表（簡稱 → 全稱）
        let brandFullNames = {};
        
        // 分類資訊（僅用於篩選）
        let categories = {
            brands: [],              // 改為空陣列
            mainCategories: {},      // {brand: [categories]}
            subCategories: {}        // {brand: {mainCat: [subCategories]}}
        };
        
        // 向下相容：保留舊的資料結構變數（用於資料遷移）
        let productData = {};  // 改為空物件
        
        let currentBrand = '';
        let currentMainCategory = '';
        let currentSubCategory = '';
        let orderItems = [];
        let discounts = [];
        let salesHistory = [];
        let discountButtons = [];
        
        // 滿額贈品規則
        let giftRules = [];
        
        // 銷售地點清單
        let saleLocations = [];

        // 商品列表分頁變數
        let productListCurrentPage = 1;
        const productListItemsPerPage = 20;  // 改為 20
        
        // 主畫面商品列表分頁變數
        let mainProductCurrentPage = 1;
        const mainProductItemsPerPage = 20;  // 改為 20

        // 配色主題資料
        const colorThemes = {
            red: {
                name: '熱情紅',
                emoji: '🔴',
                primary: '#DC143C',
                secondary: '#B22222',
                accent: '#FFD700'
            },
            orange: {
                name: '活力橘',
                emoji: '🟠',
                primary: '#FF8C00',
                secondary: '#FF6347',
                accent: '#FFD700'
            },
            yellow: {
                name: '陽光黃',
                emoji: '🟡',
                primary: '#FFB900',
                secondary: '#FFA500',
                accent: '#FF6347'
            },
            green: {
                name: '清新綠',
                emoji: '🟢',
                primary: '#2E8B57',
                secondary: '#228B22',
                accent: '#FFD700'
            },
            blue: {
                name: '經典藍',
                emoji: '🔵',
                primary: '#0B4F7C',
                secondary: '#195A84',
                accent: '#D4AF37'
            },
            purple: {
                name: '優雅紫',
                emoji: '🟣',
                primary: '#8B00FF',
                secondary: '#6A0DAD',
                accent: '#FFD700'
            },
            indigo: {
                name: '低調靛',
                emoji: '🟤',
                primary: '#4B0082',
                secondary: '#3A006F',
                accent: '#D4AF37'
            },
            brown: {
                name: '溫暖棕',
                emoji: '🟤',
                primary: '#8B4513',
                secondary: '#654321',
                accent: '#D4AF37'
            }
        };

        // 系統配置
        let systemConfig = {
            systemName: '',      // 系統名稱
            theme: 'blue'       // 預設主題：blue
        };

        // 系統設定
        let systemSettings = {
            shopName: '',  // 改為空字串
            taxId: '',
            phone: '',
            address: '',
            website: '',
            socialLinks: [], // { platform: 'instagram', value: '@timuanchi' }
            showTaxId: true,
            showPhone: true,
            showAddress: true,
            showWebsite: true,
            showSocial: true,
            footerText: '感謝您的購買！\n歡迎再次光臨'
        };

        // 加購項目清單
        let addOnItems = [];

        // === 選單功能 ===
        
        // 切換側邊選單
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // === Tab 切換功能 ===
        
        let currentTab = 'sales';
        
        function switchTab(tabName) {
            // 隱藏所有 tab 內容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有 tab 的 active 狀態
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 顯示選中的 tab
            if (tabName === 'sales') {
                document.getElementById('salesTab').classList.add('active');
                document.querySelector('.tab-nav-item:nth-child(1)').classList.add('active');
            } else if (tabName === 'history') {
                document.getElementById('historyTab').classList.add('active');
                document.querySelector('.tab-nav-item:nth-child(2)').classList.add('active');
                loadHistoryPage();
            }
            
            currentTab = tabName;
        }

        // 載入銷售記錄頁面
        function loadHistoryPage() {
            filterByTime('all');
        }

        let currentTimeFilter = 'all';
        let filteredSales = [];
        
        // 分頁相關變數
        let currentPage = 1;
        const itemsPerPage = 10;  // 每頁10筆
        const maxDisplayRecords = 50;  // 最多顯示50筆

        function filterByTime(filter) {
            currentTimeFilter = filter;
            currentPage = 1;  // 重置到第一頁
            
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            const now = new Date();
            let startDate, endDate;

            if (filter === 'custom') {
                const start = document.getElementById('filterStartDate').value;
                const end = document.getElementById('filterEndDate').value;
                if (!start || !end) return;
                startDate = new Date(start);
                endDate = new Date(end + ' 23:59:59');
            } else {
                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                
                if (filter === 'today') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (filter === 'yesterday') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
                } else if (filter === 'dayBeforeYesterday') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 2);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 2, 23, 59, 59);
                } else if (filter === 'week') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 7);
                } else if (filter === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (filter === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                } else {
                    startDate = new Date(2000, 0, 1);
                }
            }

            // 用於統計的篩選 (排除已取消)
            filteredSales = salesHistory.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                const isInDateRange = saleDate >= startDate && saleDate <= endDate;
                const isNotCancelled = sale.status !== 'cancelled';
                return isInDateRange && isNotCancelled;
            });
            
            // 用於顯示列表的篩選 (包含已取消)
            const filteredSalesForList = salesHistory.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                const isInDateRange = saleDate >= startDate && saleDate <= endDate;
                return isInDateRange;
            });

            updateStatistics();
            updateTopProducts();
            updateDiscountAnalysis();
            updateLocationAnalysis();
            updateOrdersList(filteredSalesForList);
        }

        function updateStatistics() {
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalOrders = filteredSales.length;
            const avgValue = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;
            const totalItems = filteredSales.reduce((sum, sale) => {
                return sum + sale.items.reduce((itemSum, item) => itemSum + item.quantity, 0);
            }, 0);

            document.getElementById('statRevenue').textContent = `NT$ ${totalRevenue.toLocaleString()}`;
            document.getElementById('statOrders').textContent = `${totalOrders} 筆`;
            document.getElementById('statAvg').textContent = `NT$ ${avgValue.toLocaleString()}`;
            document.getElementById('statItems').textContent = `${totalItems} 件`;
        }

        function updateTopProducts() {
            const productStats = {};
            
            filteredSales.forEach(sale => {
                sale.items.forEach(item => {
                    const key = item.displayName || item.name;
                    if (!productStats[key]) {
                        productStats[key] = { 
                            name: item.name, // 基礎名稱
                            displayName: key, // 完整顯示名稱
                            selectedVariants: item.selectedVariants, // 規格資訊
                            sku: item.sku, // 貨號
                            quantity: 0, 
                            revenue: 0 
                        };
                    }
                    productStats[key].quantity += item.quantity;
                    productStats[key].revenue += item.price * item.quantity;
                });
            });

            const topProducts = Object.values(productStats).sort((a, b) => b.revenue - a.revenue).slice(0, 10);
            const container = document.getElementById('topProductsList');
            
            if (topProducts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暫無銷售資料</div>';
                return;
            }

            container.innerHTML = topProducts.map((product, index) => {
                const rankClass = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : '';
                
                // 處理規格顯示
                let variantInfo = '';
                if (product.selectedVariants && Object.keys(product.selectedVariants).length > 0) {
                    const variantText = Object.entries(product.selectedVariants)
                        .map(([key, value]) => `${key}: ${value}`)
                        .join(' | ');
                    variantInfo = `<div style="font-size: 11px; color: #999; margin-top: 2px;">${variantText}</div>`;
                }
                
                // 處理貨號顯示
                const skuInfo = product.sku ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">${product.sku}</div>` : '';
                
                return `
                    <div class="top-item">
                        <div class="top-rank ${rankClass}">${index + 1}</div>
                        <div class="top-info">
                            <div class="top-name">${product.name}</div>
                            ${variantInfo}
                            ${skuInfo}
                            <div class="top-details">銷量：${product.quantity} 件</div>
                        </div>
                        <div class="top-value">NT$ ${product.revenue.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }

        function updateDiscountAnalysis() {
            const discountStats = {};
            
            filteredSales.forEach(sale => {
                if (sale.discounts && sale.discounts.length > 0) {
                    sale.discounts.forEach(discount => {
                        const name = discount.name || '未命名折扣';
                        if (!discountStats[name]) {
                            discountStats[name] = { count: 0, totalAmount: 0 };
                        }
                        discountStats[name].count++;
                        // 計算折扣金額
                        if (discount.amount) {
                            discountStats[name].totalAmount += discount.amount;
                        }
                    });
                }
            });

            const discounts = Object.entries(discountStats).sort((a, b) => b[1].count - a[1].count);
            const container = document.getElementById('discountAnalysis');
            
            if (discounts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暫無折扣使用資料</div>';
                return;
            }

            container.innerHTML = discounts.map(([name, stats]) => `
                <div class="discount-item">
                    <div class="discount-name">${name}</div>
                    <div class="discount-stats">
                        <div class="discount-stat-item">
                            <div class="discount-stat-label">使用次數</div>
                            <div class="discount-stat-value">${stats.count} 次</div>
                        </div>
                        <div class="discount-stat-item">
                            <div class="discount-stat-label">折扣金額</div>
                            <div class="discount-stat-value" style="color: #e74c3c;">-NT$ ${stats.totalAmount.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateLocationAnalysis() {
            const locationStats = {};
            
            filteredSales.forEach(sale => {
                const location = sale.saleLocation || '未指定';
                if (!locationStats[location]) locationStats[location] = { orders: 0, revenue: 0 };
                locationStats[location].orders++;
                locationStats[location].revenue += sale.total || 0;
            });

            const locations = Object.entries(locationStats).sort((a, b) => b[1].revenue - a[1].revenue);
            const container = document.getElementById('locationAnalysis');
            
            if (locations.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暫無銷售資料</div>';
                return;
            }

            container.innerHTML = locations.map(([name, stats]) => `
                <div class="location-item">
                    <div class="location-name">${name}</div>
                    <div class="location-stats">
                        <div class="location-stat-item">
                            <div class="location-stat-label">訂單數</div>
                            <div class="location-stat-value">${stats.orders} 筆</div>
                        </div>
                        <div class="location-stat-item">
                            <div class="location-stat-label">銷售額</div>
                            <div class="location-stat-value">NT$ ${stats.revenue.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateOrdersList(salesToDisplay = filteredSales) {
            const container = document.getElementById('historyList');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (salesToDisplay.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">暫無訂單記錄</div>';
                paginationContainer.style.display = 'none';
                return;
            }

            // 只取最新的 50 筆記錄
            const reversedSales = [...salesToDisplay].reverse().slice(0, maxDisplayRecords);
            
            // 計算總頁數
            const totalPages = Math.ceil(reversedSales.length / itemsPerPage);
            
            // 確保當前頁數在有效範圍內
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }
            
            // 計算當前頁的起始和結束索引
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, reversedSales.length);
            
            // 取得當前頁的資料
            const currentPageData = reversedSales.slice(startIndex, endIndex);
            
            // 顯示訂單列表
            container.innerHTML = currentPageData.map(sale => {
                const actualIndex = salesHistory.indexOf(sale);
                const displayTime = sale.timestampDisplay || new Date(sale.timestamp).toLocaleString('zh-TW');
                return `
                    <div class="sales-record-item">
                        <div class="sales-record-header">
                            <div onclick="toggleSalesDetail(${actualIndex})" style="cursor: pointer; flex: 1;">
                                <div class="sales-record-order-number" style="color: var(--primary-color); text-decoration: underline;">
                                    ${sale.orderNumber || '無'} <span style="font-size: 12px; color: #999;">▼</span>
                                </div>
                                <div class="sales-record-info">
                                    ${displayTime} ${sale.saleLocation ? `｜ ${sale.saleLocation}` : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="sales-record-total">NT$ ${(sale.total || 0).toLocaleString()}</div>
                                ${sale.status === 'cancelled' 
                                    ? '<button class="cancelled-order-btn">已取消</button>' 
                                    : `<button class="cancel-order-btn" onclick="cancelSalesOrder(${actualIndex})" title="取消訂單">取消</button>`
                                }
                                <button class="view-receipt-btn" onclick="viewReceipt(${actualIndex})" title="查看單據">🖨️</button>
                                <button class="delete-order-btn" onclick="deleteSalesRecord(${actualIndex})" title="刪除記錄">🗑️</button>
                            </div>
                        </div>
                        
                        <div id="salesDetail_${actualIndex}" class="sales-detail" style="display: none;">
                            ${sale.status === 'cancelled' ? '<div class="order-cancelled-notice">❌ 此訂單已取消</div>' : ''}
                            ${sale.memberName || sale.memberPhone ? `
                            <div class="sales-record-info" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                顧客：${sale.memberName || ''} ${sale.memberPhone ? `(${sale.memberPhone})` : ''}
                            </div>
                            ` : ''}
                            
                            <div class="sales-record-items">
                                ${(() => {
                                    // 分類並排序:商品 → 加購 → 贈品
                                    const products = sale.items.filter(item => !item.isAddon && !item.isGift);
                                    const addons = sale.items.filter(item => item.isAddon);
                                    const gifts = sale.items.filter(item => item.isGift);
                                    const sortedItems = [...products, ...addons, ...gifts];
                                    
                                    return sortedItems.map(item => {
                                        const displayName = item.displayName || item.name;
                                        const itemTotal = item.price * item.quantity;
                                        
                                        // 加上標籤
                                        let label = '';
                                        if (item.isGift) {
                                            label = '【贈品】';
                                        } else if (item.isAddon) {
                                            label = '【加購】';
                                        }
                                        
                                        return `<div class="sales-record-item-row"><span>${label}${displayName} × ${item.quantity}</span><span>NT$ ${itemTotal}</span></div>`;
                                    }).join('');
                                })()}
                                
                                ${sale.discountAmount > 0 ? `<div class="sales-record-item-row" style="color: #d32f2f;"><span>${sale.discountName}</span><span>- NT$ ${sale.discountAmount}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 更新分頁控制
            updatePagination(totalPages, reversedSales.length);
        }
        
        // 更新分頁控制
        function updatePagination(totalPages, totalRecords) {
            const paginationContainer = document.getElementById('paginationContainer');
            const pageNumbers = document.getElementById('pageNumbers');
            const paginationInfo = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            // 如果只有一頁或沒有資料，隱藏分頁
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            // 更新上一頁/下一頁按鈕狀態
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            // 顯示分頁資訊
            const startNum = (currentPage - 1) * itemsPerPage + 1;
            const endNum = Math.min(currentPage * itemsPerPage, totalRecords);
            paginationInfo.textContent = `(${startNum}-${endNum}/${totalRecords})`;
            
            // 生成頁碼按鈕
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // 調整起始頁，確保顯示足夠的頁碼
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一頁
            if (startPage > 1) {
                pageNumbersHTML += `<div class="pagination-number" onclick="goToPage(1)">1</div>`;
                if (startPage > 2) {
                    pageNumbersHTML += `<span style="padding: 0 4px; color: var(--text-light);">...</span>`;
                }
            }
            
            // 中間頁碼
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                pageNumbersHTML += `<div class="pagination-number ${activeClass}" onclick="goToPage(${i})">${i}</div>`;
            }
            
            // 最後一頁
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbersHTML += `<span style="padding: 0 4px; color: var(--text-light);">...</span>`;
                }
                pageNumbersHTML += `<div class="pagination-number" onclick="goToPage(${totalPages})">${totalPages}</div>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHTML;
        }
        
        // 換頁功能
        function changePage(direction) {
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next') {
                const reversedSales = [...filteredSales].reverse().slice(0, maxDisplayRecords);
                const totalPages = Math.ceil(reversedSales.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                }
            }
            updateOrdersList();
        }
        
        // 跳到指定頁面
        function goToPage(page) {
            currentPage = page;
            updateOrdersList();
        }

        function toggleSalesDetail(index) {
            const detailElement = document.getElementById(`salesDetail_${index}`);
            if (!detailElement) return;
            
            const isVisible = detailElement.style.display !== 'none';
            detailElement.style.display = isVisible ? 'none' : 'block';
        }

        // 載入折扣按鈕
        function loadDiscountButtons() {
            const container = document.getElementById('discountButtons');
            container.innerHTML = discountButtons.map((btn, index) => {
                let onclick = '';
                if (btn.type === 'percent') {
                    onclick = `applyPercentDiscount('${btn.id}', '${btn.name}', ${btn.value})`;
                } else if (btn.type === 'fixed') {
                    onclick = `applyFixedDiscount('${btn.id}', '${btn.name}', ${btn.value})`;
                } else if (btn.type === 'minAmountPercent') {
                    onclick = `applyMinAmountPercentDiscount('${btn.id}', '${btn.name}', ${btn.minAmount}, ${btn.value})`;
                } else if (btn.type === 'minAmountFixed') {
                    onclick = `applyMinAmountFixedDiscount('${btn.id}', '${btn.name}', ${btn.minAmount}, ${btn.value})`;
                } else if (btn.type === 'buyNPercent') {
                    onclick = `applyBuyNPercentDiscount('${btn.id}', '${btn.name}', ${btn.count}, ${btn.value})`;
                } else if (btn.type === 'buyNFixed') {
                    onclick = `applyBuyNFixedDiscount('${btn.id}', '${btn.name}', ${btn.count}, ${btn.discount})`;
                }
                return `<button class="discount-btn" onclick="${onclick}">${btn.name}</button>`;
            }).join('');
        }

        // 載入贈品按鈕
        function loadGiftButtons() {
            const container = document.getElementById('giftButtons');
            if (giftRules.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // 計算一般商品金額(排除加購品)
            const productSubtotal = orderItems
                .filter(item => !item.isAddon)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // 計算一般商品件數(排除加購品)
            const productCount = orderItems
                .filter(item => !item.isAddon)
                .reduce((sum, item) => sum + item.quantity, 0);
            
            container.innerHTML = giftRules.map((gift, index) => {
                let isEligible = false;
                let statusText = '';
                let buttonClass = 'discount-btn';
                
                // 檢查庫存是否為0
                const isOutOfStock = gift.giftStock !== undefined && gift.giftStock <= 0;
                
                // 檢查是否符合條件
                if (gift.conditionType === 'minAmount') {
                    isEligible = productSubtotal >= gift.conditionValue;
                    if (!isEligible) {
                        const diff = gift.conditionValue - productSubtotal;
                        statusText = ` 還差${diff}元`;
                    }
                } else if (gift.conditionType === 'minItems') {
                    isEligible = productCount >= gift.conditionValue;
                    if (!isEligible) {
                        const diff = gift.conditionValue - productCount;
                        statusText = ` 還差${diff}件`;
                    }
                }
                
                // 檢查是否已贈送
                const alreadyGifted = orderItems.some(item => item.isGift && item.giftId === gift.id);
                
                // 設定按鈕狀態(不在文字中顯示已贈完)
                if (isOutOfStock) {
                    buttonClass = 'discount-btn gift-btn-disabled';
                } else if (alreadyGifted) {
                    buttonClass = 'discount-btn gift-btn-applied';
                    statusText = ' ✓ 已贈送';
                } else if (isEligible) {
                    buttonClass = 'discount-btn gift-btn-eligible';
                } else {
                    buttonClass = 'discount-btn gift-btn-disabled';
                }
                
                // 已贈完標籤
                const outOfStockLabel = isOutOfStock ? '<div class="sold-out-label">已贈完</div>' : '';
                
                // 組合顯示文字
                let displayText = gift.name + statusText;
                const skuText = gift.giftSku ? `<br><span style="font-size: 10px; opacity: 0.8;">貨號: ${gift.giftSku}</span>` : '';
                const stockText = gift.giftStock !== undefined ? `<br><span style="font-size: 10px; opacity: 0.8;">庫存: ${gift.giftStock}</span>` : '';
                
                return `<button class="${buttonClass}" onclick="applyGift('${gift.id}')" id="gift-btn-${gift.id}" ${!isEligible || alreadyGifted || isOutOfStock ? 'disabled' : ''} style="position: relative;">${displayText}${skuText}${stockText}${outOfStockLabel}</button>`;
            }).join('');
        }

        // 臨時空函數(後續步驟實作)
        function openGiftManager() {
            document.getElementById('giftModal').classList.add('show');
            loadGiftList();
        }
        function closeGiftManager() {
            document.getElementById('giftModal').classList.remove('show');
        }
        function loadGiftList() {
            const container = document.getElementById('giftList');
            if (giftRules.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">尚無贈品設定</div>';
                return;
            }
            container.innerHTML = giftRules.map((gift, index) => {
                let description = '';
                if (gift.conditionType === 'minAmount') {
                    description = `滿 NT$ ${gift.conditionValue} 贈送 ${gift.giftName} x${gift.giftQty}`;
                } else if (gift.conditionType === 'minItems') {
                    description = `滿 ${gift.conditionValue} 件贈送 ${gift.giftName} x${gift.giftQty}`;
                }
                
                const skuInfo = gift.giftSku ? `<br><span style="font-size: 11px; color: #999;">貨號: ${gift.giftSku}</span>` : '';
                const stockInfo = gift.giftStock !== undefined ? `<br><span style="font-size: 11px; color: #999;">庫存: ${gift.giftStock}</span>` : '';
                
                return `
                    <div class="discount-item-manage">
                        <div class="discount-item-info-manage">
                            <div class="discount-item-name-manage">${gift.name}</div>
                            <div class="discount-item-desc">${description}${skuInfo}${stockInfo}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="file-btn" onclick="editGift(${index})">編輯</button>
                            <button class="delete-discount-btn" onclick="deleteGift(${index})">刪除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        function openAddGiftModal() {
            document.getElementById('addGiftModal').classList.add('show');
            updateAddGiftForm(); // 初始化表單
        }
        function closeAddGiftModal() {
            document.getElementById('addGiftModal').classList.remove('show');
        }
        function updateAddGiftForm() {
            const type = document.getElementById('addGiftConditionType').value;
            const container = document.getElementById('addGiftConditionField');
            
            if (type === 'minAmount') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>滿額數值</label>
                        <input type="number" id="addGiftConditionValue" min="1" placeholder="例如：500元" />
                    </div>
                `;
            } else if (type === 'minItems') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>滿件數值</label>
                        <input type="number" id="addGiftConditionValue" min="1" placeholder="例如：1件" />
                    </div>
                `;
            }
        }
        function updateEditGiftForm() {
            const type = document.getElementById('editGiftConditionType').value;
            const container = document.getElementById('editGiftConditionField');
            
            if (type === 'minAmount') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>滿額數值</label>
                        <input type="number" id="editGiftConditionValue" min="1" placeholder="例如：500元" />
                    </div>
                `;
            } else if (type === 'minItems') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>滿件數值</label>
                        <input type="number" id="editGiftConditionValue" min="1" placeholder="例如：1件" />
                    </div>
                `;
            }
        }
        function addNewGift() {
            const name = document.getElementById('addGiftName').value.trim();
            const conditionType = document.getElementById('addGiftConditionType').value;
            const conditionValue = parseInt(document.getElementById('addGiftConditionValue').value);
            const giftName = document.getElementById('addGiftItemName').value.trim();
            const giftSku = document.getElementById('addGiftItemSku').value.trim();
            const giftQty = parseInt(document.getElementById('addGiftItemQty').value);
            const giftStock = document.getElementById('addGiftItemStock').value.trim();
            
            if (!name) {
                alert('請輸入活動名稱');
                return;
            }
            if (!conditionValue || conditionValue <= 0) {
                alert('請輸入有效的條件數值');
                return;
            }
            if (!giftName) {
                alert('請輸入贈品名稱');
                return;
            }
            if (!giftQty || giftQty <= 0) {
                alert('請輸入有效的贈品數量');
                return;
            }
            
            const newId = 'gift_' + Date.now();
            const newGift = {
                id: newId,
                name,
                conditionType,
                conditionValue,
                giftName,
                giftQty
            };
            
            if (giftSku) newGift.giftSku = giftSku;
            if (giftStock) newGift.giftStock = parseInt(giftStock);
            
            giftRules.push(newGift);
            
            showNotification('✅ 贈品新增成功！');
            saveDataToLocalStorage();
            loadGiftButtons();
            closeAddGiftModal();
            
            // 清空表單
            document.getElementById('addGiftName').value = '';
            document.getElementById('addGiftConditionValue').value = '';
            document.getElementById('addGiftItemName').value = '';
            document.getElementById('addGiftItemSku').value = '';
            document.getElementById('addGiftItemQty').value = '1';
            document.getElementById('addGiftItemStock').value = '';
        }

        function applyGift(giftId) {
            const gift = giftRules.find(g => g.id === giftId);
            if (!gift) return;
            
            // 檢查庫存
            if (gift.giftStock !== undefined && gift.giftStock <= 0) {
                alert('此贈品已贈完！');
                return;
            }
            
            // 計算一般商品金額(排除加購品)
            const productSubtotal = orderItems
                .filter(item => !item.isAddon)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // 計算一般商品件數(排除加購品)
            const productCount = orderItems
                .filter(item => !item.isAddon)
                .reduce((sum, item) => sum + item.quantity, 0);
            
            // 檢查是否符合條件
            let isEligible = false;
            if (gift.conditionType === 'minAmount') {
                isEligible = productSubtotal >= gift.conditionValue;
            } else if (gift.conditionType === 'minItems') {
                isEligible = productCount >= gift.conditionValue;
            }
            
            if (!isEligible) {
                alert('尚未達到贈品條件！');
                return;
            }
            
            // 檢查是否已贈送
            const alreadyGifted = orderItems.some(item => item.isGift && item.giftId === giftId);
            if (alreadyGifted) {
                alert('此贈品已加入！');
                return;
            }
            
            // 加入贈品到訂單
            const giftItem = {
                name: gift.giftName,
                price: 0,
                quantity: gift.giftQty,
                isGift: true,
                giftId: giftId,  // 保留給檢查用
                giftRuleId: giftId,  // 給庫存扣除用
                giftRuleName: gift.name
            };
            
            if (gift.giftSku) giftItem.sku = gift.giftSku;
            if (gift.giftStock !== undefined) giftItem.stock = gift.giftStock;
            
            orderItems.push(giftItem);
            
            showNotification(`✅ 已加入贈品：${gift.giftName} x${gift.giftQty}`);
            updateOrder();
        }

        // 打開折扣管理
        function openDiscountManager() {
            document.getElementById('discountModal').classList.add('show');
            loadDiscountList();
            updateDiscountForm();
        }

        // 關閉折扣管理
        function closeDiscountManager() {
            document.getElementById('discountModal').classList.remove('show');
        }

        // 打開新增折扣彈窗
        function openAddDiscountModal() {
            document.getElementById('addDiscountModal').classList.add('show');
            updateAddDiscountForm();
        }

        // 關閉新增折扣彈窗
        function closeAddDiscountModal() {
            document.getElementById('addDiscountModal').classList.remove('show');
        }

        // 更新新增折扣表單
        function updateAddDiscountForm() {
            const type = document.getElementById('addDiscountType').value;
            const container = document.getElementById('addDiscountFormFields');
            
            if (type === 'percent') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="addDiscountName" placeholder="例如：9折" />
                    </div>
                    <div class="form-group">
                        <label>折扣率 (0.1 - 1.0)</label>
                        <input type="number" id="addDiscountValue" step="0.01" min="0.1" max="1" placeholder="例如：0.9 表示9折" />
                    </div>
                `;
            } else if (type === 'fixed') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="addDiscountName" placeholder="例如：折50元" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="addDiscountValue" min="1" placeholder="例如：50" />
                    </div>
                `;
            } else if (type === 'minAmountPercent') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="addDiscountName" placeholder="例如：滿500享9折" />
                    </div>
                    <div class="form-group">
                        <label>最低消費金額</label>
                        <input type="number" id="addMinAmount" min="1" placeholder="例如：500" />
                    </div>
                    <div class="form-group">
                        <label>折扣率 (0.1 - 1.0)</label>
                        <input type="number" id="addDiscountValue" step="0.01" min="0.1" max="1" placeholder="例如：0.9 表示9折" />
                    </div>
                `;
            } else if (type === 'minAmountFixed') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="addDiscountName" placeholder="例如：滿500折50" />
                    </div>
                    <div class="form-group">
                        <label>最低消費金額</label>
                        <input type="number" id="addMinAmount" min="1" placeholder="例如：500" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="addDiscountValue" min="1" placeholder="例如：50" />
                    </div>
                `;
            } else if (type === 'buyNPercent') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="addDiscountName" placeholder="例如：任2件享9折" />
                    </div>
                    <div class="form-group">
                        <label>購買件數</label>
                        <input type="number" id="addBuyCount" min="2" placeholder="例如：2" />
                    </div>
                    <div class="form-group">
                        <label>折扣率 (0.1 - 1.0)</label>
                        <input type="number" id="addDiscountValue" step="0.01" min="0.1" max="1" placeholder="例如：0.9 表示9折" />
                    </div>
                `;
            } else if (type === 'buyNFixed') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="addDiscountName" placeholder="例如：任2件折50" />
                    </div>
                    <div class="form-group">
                        <label>購買件數</label>
                        <input type="number" id="addBuyCount" min="2" placeholder="例如：2" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="addDiscountAmount" min="1" placeholder="例如：50" />
                    </div>
                `;
            }
        }

        // 從新增折扣 Modal 新增折扣
        function addNewDiscountFromModal() {
            const type = document.getElementById('addDiscountType').value;
            const name = document.getElementById('addDiscountName')?.value.trim();
            
            if (!name) {
                alert('請輸入折扣名稱');
                return;
            }

            if (discountButtons.find(btn => btn.name === name)) {
                alert('折扣名稱已存在');
                return;
            }

            // 生成唯一 ID
            const newId = 'discount_' + Date.now();

            if (type === 'percent') {
                const value = parseFloat(document.getElementById('addDiscountValue')?.value);
                if (!value || value <= 0 || value > 1) {
                    alert('請輸入有效的折扣率 (0.1 - 1.0)');
                    return;
                }
                discountButtons.push({ id: newId, name, type, value });
            } else if (type === 'fixed') {
                const value = parseInt(document.getElementById('addDiscountValue')?.value);
                if (!value || value <= 0) {
                    alert('請輸入有效的折扣金額');
                    return;
                }
                discountButtons.push({ id: newId, name, type, value });
            } else if (type === 'minAmountPercent') {
                const minAmount = parseInt(document.getElementById('addMinAmount')?.value);
                const value = parseFloat(document.getElementById('addDiscountValue')?.value);
                if (!minAmount || minAmount <= 0) {
                    alert('請輸入有效的最低消費金額');
                    return;
                }
                if (!value || value <= 0 || value > 1) {
                    alert('請輸入有效的折扣率 (0.1 - 1.0)');
                    return;
                }
                discountButtons.push({ id: newId, name, type, minAmount, value });
            } else if (type === 'minAmountFixed') {
                const minAmount = parseInt(document.getElementById('addMinAmount')?.value);
                const value = parseInt(document.getElementById('addDiscountValue')?.value);
                if (!minAmount || minAmount <= 0) {
                    alert('請輸入有效的最低消費金額');
                    return;
                }
                if (!value || value <= 0) {
                    alert('請輸入有效的折扣金額');
                    return;
                }
                discountButtons.push({ id: newId, name, type, minAmount, value });
            } else if (type === 'buyNPercent') {
                const count = parseInt(document.getElementById('addBuyCount')?.value);
                const value = parseFloat(document.getElementById('addDiscountValue')?.value);
                if (!count || count <= 0) {
                    alert('請輸入有效的購買件數');
                    return;
                }
                if (!value || value <= 0 || value > 1) {
                    alert('請輸入有效的折扣率 (0.1 - 1.0)');
                    return;
                }
                discountButtons.push({ id: newId, name, type, count, value });
            } else if (type === 'buyNFixed') {
                const count = parseInt(document.getElementById('addBuyCount')?.value);
                const discount = parseInt(document.getElementById('addDiscountAmount')?.value);
                if (!count || count <= 0 || !discount || discount <= 0) {
                    alert('請輸入有效的購買數量和折扣金額');
                    return;
                }
                discountButtons.push({ id: newId, name, type, count, discount });
            }

            showNotification('✅ 折扣新增成功！');
            saveDataToLocalStorage();
            loadDiscountButtons();
            closeAddDiscountModal();
            
            // 清空表單
            document.getElementById('addDiscountName').value = '';
            if (document.getElementById('addDiscountValue')) {
                document.getElementById('addDiscountValue').value = '';
            }
            if (document.getElementById('addBuyCount')) {
                document.getElementById('addBuyCount').value = '';
            }
            if (document.getElementById('addDiscountAmount')) {
                document.getElementById('addDiscountAmount').value = '';
            }
        }

        // 載入折扣清單
        function loadDiscountList() {
            const container = document.getElementById('discountList');
            if (discountButtons.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">尚無折扣設定</div>';
                return;
            }
            container.innerHTML = discountButtons.map((btn, index) => {
                let description = '';
                if (btn.type === 'percent') {
                    description = `全單${(btn.value * 100).toFixed(0)}折`;
                } else if (btn.type === 'fixed') {
                    description = `固定折扣 NT$ ${btn.value}`;
                } else if (btn.type === 'buyN') {
                    description = `購買${btn.count}件折${btn.discount}元`;
                }
                return `
                    <div class="discount-item-manage">
                        <div class="discount-item-info-manage">
                            <div class="discount-item-name-manage">${btn.name}</div>
                            <div class="discount-item-desc">${description}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="file-btn" onclick="editDiscount(${index})">編輯</button>
                            <button class="delete-discount-btn" onclick="deleteDiscountButton(${index})">刪除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 更新折扣表單
        function updateDiscountForm() {
            const type = document.getElementById('discountType').value;
            const container = document.getElementById('discountFormFields');
            
            if (type === 'percent') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="discountName" placeholder="例如：9折" />
                    </div>
                    <div class="form-group">
                        <label>折扣率 (0.1 - 1.0)</label>
                        <input type="number" id="discountValue" step="0.01" min="0.1" max="1" placeholder="例如：0.9 表示9折" />
                    </div>
                `;
            } else if (type === 'fixed') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="discountName" placeholder="例如：折50元" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="discountValue" min="1" placeholder="例如：50" />
                    </div>
                `;
            } else if (type === 'buyN') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="discountName" placeholder="例如：任選2件折50" />
                    </div>
                    <div class="form-group">
                        <label>購買數量</label>
                        <input type="number" id="buyCount" min="1" placeholder="例如：2" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="discountAmount" min="1" placeholder="例如：50" />
                    </div>
                `;
            }
        }

        // 新增折扣
        function addNewDiscount() {
            const type = document.getElementById('discountType').value;
            const name = document.getElementById('discountName')?.value.trim();
            
            if (!name) {
                alert('請輸入折扣名稱');
                return;
            }

            if (discountButtons.find(btn => btn.name === name)) {
                alert('折扣名稱已存在');
                return;
            }

            if (type === 'percent') {
                const value = parseFloat(document.getElementById('discountValue')?.value);
                if (!value || value <= 0 || value > 1) {
                    alert('請輸入有效的折扣率 (0.1 - 1.0)');
                    return;
                }
                discountButtons.push({ name, type, value });
            } else if (type === 'fixed') {
                const value = parseInt(document.getElementById('discountValue')?.value);
                if (!value || value <= 0) {
                    alert('請輸入有效的折扣金額');
                    return;
                }
                discountButtons.push({ name, type, value });
            } else if (type === 'buyN') {
                const count = parseInt(document.getElementById('buyCount')?.value);
                const discount = parseInt(document.getElementById('discountAmount')?.value);
                if (!count || count <= 0 || !discount || discount <= 0) {
                    alert('請輸入有效的購買數量和折扣金額');
                    return;
                }
                discountButtons.push({ name, type, count, discount });
            }

            showNotification('✅ 折扣新增成功！');
            saveDataToLocalStorage(); // 自動保存
            loadDiscountButtons();
            loadDiscountList();
        }

        // 刪除折扣按鈕
        function deleteDiscountButton(index) {
            if (confirm('確定要刪除此折扣嗎？')) {
                discountButtons.splice(index, 1);
                showNotification('✅ 折扣已刪除');
                saveDataToLocalStorage(); // 自動保存
                loadDiscountButtons();
                loadDiscountList();
            }
        }

        // 當前正在編輯的折扣索引
        let currentEditingDiscountIndex = null;
        let currentEditingGiftIndex = null;

        // 編輯贈品
        function editGift(index) {
            const gift = giftRules[index];
            currentEditingGiftIndex = index;
            
            closeGiftManager();
            document.getElementById('editGiftModal').classList.add('show');
            
            // 先設定類型並更新表單
            document.getElementById('editGiftConditionType').value = gift.conditionType;
            updateEditGiftForm();
            
            setTimeout(() => {
                document.getElementById('editGiftName').value = gift.name;
                document.getElementById('editGiftConditionValue').value = gift.conditionValue;
                document.getElementById('editGiftItemName').value = gift.giftName;
                document.getElementById('editGiftItemSku').value = gift.giftSku || '';
                document.getElementById('editGiftItemQty').value = gift.giftQty;
                document.getElementById('editGiftItemStock').value = gift.giftStock !== undefined ? gift.giftStock : '';
            }, 50);
        }

        function closeEditGiftModal() {
            document.getElementById('editGiftModal').classList.remove('show');
            currentEditingGiftIndex = null;
        }

        function updateGift() {
            if (currentEditingGiftIndex === null) return;
            
            const name = document.getElementById('editGiftName').value.trim();
            const conditionType = document.getElementById('editGiftConditionType').value;
            const conditionValue = parseInt(document.getElementById('editGiftConditionValue').value);
            const giftName = document.getElementById('editGiftItemName').value.trim();
            const giftSku = document.getElementById('editGiftItemSku').value.trim();
            const giftQty = parseInt(document.getElementById('editGiftItemQty').value);
            const giftStock = document.getElementById('editGiftItemStock').value.trim();
            
            if (!name || !conditionValue || conditionValue <= 0 || !giftName || !giftQty || giftQty <= 0) {
                alert('請填寫完整資訊');
                return;
            }
            
            const gift = giftRules[currentEditingGiftIndex];
            gift.name = name;
            gift.conditionType = conditionType;
            gift.conditionValue = conditionValue;
            gift.giftName = giftName;
            gift.giftQty = giftQty;
            
            if (giftSku) {
                gift.giftSku = giftSku;
            } else {
                delete gift.giftSku;
            }
            
            if (giftStock) {
                gift.giftStock = parseInt(giftStock);
            } else {
                delete gift.giftStock;
            }
            
            showNotification('✅ 贈品更新成功！');
            saveDataToLocalStorage();
            loadGiftButtons();
            closeEditGiftModal();
        }

        function deleteGift(index) {
            if (confirm('確定要刪除此贈品嗎？')) {
                giftRules.splice(index, 1);
                showNotification('✅ 贈品已刪除！');
                saveDataToLocalStorage();
                loadGiftButtons();
                loadGiftList();
            }
        }

        // 編輯折扣
        function editDiscount(index) {
            const discount = discountButtons[index];
            currentEditingDiscountIndex = index;
            
            // 關閉折扣列表 Modal
            closeDiscountManager();
            
            // 打開編輯表單 Modal
            document.getElementById('editDiscountModal').classList.add('show');
            
            // 設定折扣類型
            document.getElementById('editDiscountType').value = discount.type;
            
            // 先更新表單（生成對應的輸入欄位）
            updateEditDiscountForm();
            
            // 然後立即填入資料（不需要 setTimeout）
            document.getElementById('editDiscountName').value = discount.name;
            
            if (discount.type === 'percent') {
                document.getElementById('editDiscountValue').value = discount.value;
            } else if (discount.type === 'fixed') {
                document.getElementById('editDiscountValue').value = discount.value;
            } else if (discount.type === 'minAmountPercent') {
                document.getElementById('editMinAmount').value = discount.minAmount;
                document.getElementById('editDiscountValue').value = discount.value;
            } else if (discount.type === 'minAmountFixed') {
                document.getElementById('editMinAmount').value = discount.minAmount;
                document.getElementById('editDiscountValue').value = discount.value;
            } else if (discount.type === 'buyNPercent') {
                document.getElementById('editBuyCount').value = discount.count;
                document.getElementById('editDiscountValue').value = discount.value;
            } else if (discount.type === 'buyNFixed') {
                document.getElementById('editBuyCount').value = discount.count;
                document.getElementById('editDiscountAmount').value = discount.discount;
            }
        }

        // 關閉編輯折扣表單 Modal
        function closeEditDiscountModal() {
            document.getElementById('editDiscountModal').classList.remove('show');
            currentEditingDiscountIndex = null;
        }

        // 更新編輯折扣表單
        function updateEditDiscountForm() {
            const type = document.getElementById('editDiscountType').value;
            const container = document.getElementById('editDiscountFormFields');
            
            if (type === 'percent') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="editDiscountName" placeholder="例如：9折" />
                    </div>
                    <div class="form-group">
                        <label>折扣率 (0.1 - 1.0)</label>
                        <input type="number" id="editDiscountValue" step="0.01" min="0.1" max="1" placeholder="例如：0.9 表示9折" />
                    </div>
                `;
            } else if (type === 'fixed') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="editDiscountName" placeholder="例如：折50元" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="editDiscountValue" min="1" placeholder="例如：50" />
                    </div>
                `;
            } else if (type === 'minAmountPercent') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="editDiscountName" placeholder="例如：滿500享9折" />
                    </div>
                    <div class="form-group">
                        <label>最低消費金額</label>
                        <input type="number" id="editMinAmount" min="1" placeholder="例如：500" />
                    </div>
                    <div class="form-group">
                        <label>折扣率 (0.1 - 1.0)</label>
                        <input type="number" id="editDiscountValue" step="0.01" min="0.1" max="1" placeholder="例如：0.9 表示9折" />
                    </div>
                `;
            } else if (type === 'minAmountFixed') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="editDiscountName" placeholder="例如：滿500折50" />
                    </div>
                    <div class="form-group">
                        <label>最低消費金額</label>
                        <input type="number" id="editMinAmount" min="1" placeholder="例如：500" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="editDiscountValue" min="1" placeholder="例如：50" />
                    </div>
                `;
            } else if (type === 'buyNPercent') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="editDiscountName" placeholder="例如：任2件享9折" />
                    </div>
                    <div class="form-group">
                        <label>購買件數</label>
                        <input type="number" id="editBuyCount" min="2" placeholder="例如：2" />
                    </div>
                    <div class="form-group">
                        <label>折扣率 (0.1 - 1.0)</label>
                        <input type="number" id="editDiscountValue" step="0.01" min="0.1" max="1" placeholder="例如：0.9 表示9折" />
                    </div>
                `;
            } else if (type === 'buyNFixed') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>折扣名稱</label>
                        <input type="text" id="editDiscountName" placeholder="例如：任2件折50" />
                    </div>
                    <div class="form-group">
                        <label>購買件數</label>
                        <input type="number" id="editBuyCount" min="2" placeholder="例如：2" />
                    </div>
                    <div class="form-group">
                        <label>折扣金額</label>
                        <input type="number" id="editDiscountAmount" min="1" placeholder="例如：50" />
                    </div>
                `;
            }
        }

        // 更新折扣
        function updateDiscount() {
            const type = document.getElementById('editDiscountType').value;
            const name = document.getElementById('editDiscountName')?.value.trim();
            
            if (!name) {
                alert('請輸入折扣名稱');
                return;
            }

            // 檢查名稱是否與其他折扣重複（排除自己）
            const duplicateName = discountButtons.find((btn, idx) => 
                btn.name === name && idx !== currentEditingDiscountIndex
            );
            if (duplicateName) {
                alert('折扣名稱已存在');
                return;
            }

            // 保留原有的 ID
            const originalDiscount = discountButtons[currentEditingDiscountIndex];
            let updatedDiscount = { id: originalDiscount.id, name, type };

            if (type === 'percent') {
                const value = parseFloat(document.getElementById('editDiscountValue')?.value);
                if (!value || value <= 0 || value > 1) {
                    alert('請輸入有效的折扣率 (0.1 - 1.0)');
                    return;
                }
                updatedDiscount.value = value;
            } else if (type === 'fixed') {
                const value = parseInt(document.getElementById('editDiscountValue')?.value);
                if (!value || value <= 0) {
                    alert('請輸入有效的折扣金額');
                    return;
                }
                updatedDiscount.value = value;
            } else if (type === 'buyN') {
                const count = parseInt(document.getElementById('editBuyCount')?.value);
                const discount = parseInt(document.getElementById('editDiscountAmount')?.value);
                if (!count || count <= 0 || !discount || discount <= 0) {
                    alert('請輸入有效的購買數量和折扣金額');
                    return;
                }
                updatedDiscount.count = count;
                updatedDiscount.discount = discount;
            }

            // 更新折扣
            discountButtons[currentEditingDiscountIndex] = updatedDiscount;

            showNotification('✅ 折扣更新成功！');
            saveDataToLocalStorage();
            loadDiscountButtons();
            updateOrder(); // 觸發訂單明細更新
            closeEditDiscountModal();
        }

        // 重置折扣表單

        // 初始化預設商品資料
        function initDefaultProducts() {
            // 完全空白的初始化，不建立任何品牌
            productData = {};
            categories = {
                brands: [],
                mainCategories: {},
                subCategories: {}
            };
        }

        // === 匯入匯出功能 ===
        
        // 打開匯入彈窗
        function openImportModal() {
            document.getElementById('importModal').classList.add('show');
        }
        
        // 關閉匯入彈窗
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }
        
        // 開啟商品匯入選項彈窗
        function openProductImportOptionsModal() {
            document.getElementById('importModal').classList.remove('show');
            document.getElementById('productImportOptionsModal').classList.add('show');
        }
        
        // 關閉商品匯入選項彈窗
        function closeProductImportOptionsModal() {
            document.getElementById('productImportOptionsModal').classList.remove('show');
        }
        
        // 開啟加購項目匯入選項彈窗
        function openAddonImportOptionsModal() {
            document.getElementById('importModal').classList.remove('show');
            document.getElementById('addonImportOptionsModal').classList.add('show');
        }
        
        // 關閉加購項目匯入選項彈窗
        function closeAddonImportOptionsModal() {
            document.getElementById('addonImportOptionsModal').classList.remove('show');
        }
        
        // 開啟贈品匯入選項彈窗
        function openGiftImportOptionsModal() {
            document.getElementById('importModal').classList.remove('show');
            document.getElementById('giftImportOptionsModal').classList.add('show');
        }
        
        // 關閉贈品匯入選項彈窗
        function closeGiftImportOptionsModal() {
            document.getElementById('giftImportOptionsModal').classList.remove('show');
        }
        
        // 下載贈品填寫範例
        function downloadGiftExample() {
            // 欄位名稱
            const headers = ['贈品活動名稱', '條件類型', '條件值', '贈品名稱', '贈品數量', '贈品貨號', '贈品庫存數量'];
            
            // 說明行
            const explanations = [
                '必填',
                '請填 滿額贈送 或 滿件贈送',
                '請填數字，例如滿500元請填500，滿1件請填1',
                '必填',
                '必填',
                '選填',
                '0=庫存設為0，空白=不想覆蓋系統裡已有的庫存',
                '← 匯入資料前請把這行刪除以免出現錯誤'
            ];
            
            const ws_data = [headers, explanations];
            
            // 建立工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 20}, // 贈品活動名稱
                {wch: 25}, // 條件類型
                {wch: 40}, // 條件值
                {wch: 15}, // 贈品名稱
                {wch: 12}, // 贈品數量
                {wch: 15}, // 贈品貨號
                {wch: 40}, // 贈品庫存數量
                {wch: 35}  // 說明
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '贈品資料');
            
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `贈品資料欄位說明_${timestamp}.xlsx`, {cellStyles: true});
        }
        
        // 下載贈品空白範本
        function downloadGiftTemplate() {
            // 只有欄位名稱
            const headers = ['贈品活動名稱', '條件類型', '條件值', '贈品名稱', '贈品數量', '贈品貨號', '贈品庫存數量'];
            
            const ws_data = [headers];
            
            // 建立工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 20}, // 贈品活動名稱
                {wch: 12}, // 條件類型
                {wch: 10}, // 條件值
                {wch: 15}, // 贈品名稱
                {wch: 12}, // 贈品數量
                {wch: 15}, // 贈品貨號
                {wch: 15}  // 贈品庫存數量
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '贈品資料');
            
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `贈品資料空白檔_${timestamp}.xlsx`);
        }
        
        // 下載加購項目填寫範例
        function downloadAddonExample() {
            // 欄位名稱
            const headers = ['項目名稱', '主貨號', '規格1名稱', '規格1', '規格2名稱', '規格2', '規格3名稱', '規格3', '價格', '庫存', '規格貨號'];
            
            // 說明行
            const explanations = [
                '必填',
                '選填',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '必填，空白=不想覆蓋系統裡已有的價格',
                '0=庫存設為0，空白=不想覆蓋系統裡已有的庫存',
                '選填',
                '← 匯入資料前請把這行刪除以免出現錯誤'
            ];
            
            const ws_data = [headers, explanations];
            
            // 建立工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 15}, // 項目名稱
                {wch: 15}, // 主貨號
                {wch: 12}, // 規格1名稱
                {wch: 12}, // 規格1
                {wch: 12}, // 規格2名稱
                {wch: 12}, // 規格2
                {wch: 12}, // 規格3名稱
                {wch: 12}, // 規格3
                {wch: 35}, // 價格
                {wch: 40}, // 庫存
                {wch: 15}, // 規格貨號
                {wch: 35}  // 說明
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '加購項目');
            
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `加購項目資料欄位說明_${timestamp}.xlsx`, {cellStyles: true});
        }
        
        // 下載加購項目空白範本
        function downloadAddonTemplate() {
            // 只有欄位名稱
            const headers = ['項目名稱', '主貨號', '規格1名稱', '規格1', '規格2名稱', '規格2', '規格3名稱', '規格3', '價格', '庫存', '規格貨號'];
            
            const ws_data = [headers];
            
            // 建立工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 15}, // 項目名稱
                {wch: 15}, // 主貨號
                {wch: 12}, // 規格1名稱
                {wch: 12}, // 規格1
                {wch: 12}, // 規格2名稱
                {wch: 12}, // 規格2
                {wch: 12}, // 規格3名稱
                {wch: 12}, // 規格3
                {wch: 10}, // 價格
                {wch: 10}, // 庫存
                {wch: 15}  // 規格貨號
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '加購項目');
            
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `加購項目資料空白檔_${timestamp}.xlsx`);
        }
        
        // 下載商品填寫範例
        function downloadProductExample() {
            // 欄位名稱
            const headers = ['品牌', '大分類', '小分類', '商品名稱', '主貨號', '規格1名稱', '規格1', '規格2名稱', '規格2', '規格3名稱', '規格3', '價格', '庫存', '規格貨號'];
            
            // 紅色說明行
            const explanations = [
                '必填',
                '選填',
                '選填',
                '必填',
                '選填',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '空白=不需多規格',
                '必填，空白=不想覆蓋系統裡已有的價格',
                '0=庫存設為0，空白=不想覆蓋系統裡已有的庫存',
                '選填',
                '← 匯入資料前請把這行刪除以免出現錯誤'
            ];
            
            const ws_data = [headers, explanations];
            
            // 建立工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定第2行所有儲存格為紅色
            if (!ws['!rows']) ws['!rows'] = [];
            
            for (let col = 0; col < explanations.length; col++) {
                const cellAddress = XLSX.utils.encode_cell({r: 1, c: col});
                if (!ws[cellAddress]) continue;
                
                if (!ws[cellAddress].s) ws[cellAddress].s = {};
                ws[cellAddress].s = {
                    font: { 
                        color: { rgb: "FF0000" },
                        bold: false
                    }
                };
            }
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 12}, // 品牌
                {wch: 10}, // 大分類
                {wch: 10}, // 小分類
                {wch: 20}, // 商品名稱
                {wch: 15}, // 主貨號
                {wch: 12}, // 規格1名稱
                {wch: 12}, // 規格1
                {wch: 12}, // 規格2名稱
                {wch: 12}, // 規格2
                {wch: 12}, // 規格3名稱
                {wch: 12}, // 規格3
                {wch: 35}, // 價格
                {wch: 35}, // 庫存
                {wch: 15}, // 規格貨號
                {wch: 35}  // 說明
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '商品資料');
            
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `商品資料欄位說明_${timestamp}.xlsx`, {cellStyles: true});
        }
        
        // 下載商品空白範本
        function downloadProductTemplate() {
            // 只有欄位名稱
            const headers = ['品牌', '大分類', '小分類', '商品名稱', '主貨號', '規格1名稱', '規格1', '規格2名稱', '規格2', '規格3名稱', '規格3', '價格', '庫存', '規格貨號'];
            
            const ws_data = [headers];
            
            // 建立工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 12}, // 品牌
                {wch: 10}, // 大分類
                {wch: 10}, // 小分類
                {wch: 20}, // 商品名稱
                {wch: 15}, // 主貨號
                {wch: 12}, // 規格1名稱
                {wch: 12}, // 規格1
                {wch: 12}, // 規格2名稱
                {wch: 12}, // 規格2
                {wch: 12}, // 規格3名稱
                {wch: 12}, // 規格3
                {wch: 10}, // 價格
                {wch: 10}, // 庫存
                {wch: 15}  // 規格貨號
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '商品資料');
            
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `商品資料空白檔_${timestamp}.xlsx`);
        }
        
        // 打開匯出彈窗
        function openExportModal() {
            document.getElementById('exportModal').classList.add('show');
        }
        
        // 關閉匯出彈窗
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }
        
        // 打開清除資料彈窗
        function openClearDataModal() {
            document.getElementById('clearDataModal').classList.add('show');
        }
        
        // 關閉清除資料彈窗
        function closeClearDataModal() {
            document.getElementById('clearDataModal').classList.remove('show');
        }

        // 商品資料匯入
        document.getElementById('importProductFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // === 階段 1: 讀取 & 驗證 ===
                    console.log('=== 階段 1: 讀取 Excel ===');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 讀取第一個工作表
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    
                    console.log('工作表名稱:', sheetName);
                    
                    if (!sheet) {
                        alert('❌ 無法讀取工作表！\n請確認 Excel 檔案格式正確。');
                        return;
                    }
                    
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    console.log('讀取行數:', jsonData.length);
                    
                    if (jsonData.length === 0) {
                        alert('❌ Excel 檔案沒有資料！');
                        return;
                    }
                    
                    // 驗證資料
                    const errors = [];
                    const warnings = [];
                    
                    jsonData.forEach((row, index) => {
                        const rowNum = index + 2; // Excel 行號 (標題列 = 1)
                        
                        // 必填欄位檢查
                        if (!row['品牌']) {
                            errors.push(`第 ${rowNum} 行: 品牌為空`);
                        }
                        if (!row['商品名稱']) {
                            errors.push(`第 ${rowNum} 行: 商品名稱為空`);
                        }
                        // 價格改為非必填 (空白時保留原值)
                        // if (row['價格'] === undefined || row['價格'] === '') {
                        //     errors.push(`第 ${rowNum} 行: 價格為空`);
                        // }
                        
                        // 品牌存在性檢查 - 已移除,允許自動建立品牌
                        // if (row['品牌'] && !productData[row['品牌']]) {
                        //     errors.push(`第 ${rowNum} 行: 品牌「${row['品牌']}」不存在於系統中`);
                        // }
                        
                        // 規格邏輯檢查 (稍後在分組後檢查)
                    });
                    
                    // 顯示驗證結果
                    console.log('驗證完成:');
                    console.log('- 錯誤:', errors.length);
                    console.log('- 警告:', warnings.length);
                    
                    if (errors.length > 0) {
                        const errorMsg = '❌ 發現以下錯誤:\n\n' + errors.slice(0, 10).join('\n') + 
                                        (errors.length > 10 ? `\n\n...還有 ${errors.length - 10} 個錯誤` : '');
                        alert(errorMsg);
                        console.error('所有錯誤:', errors);
                        return;
                    }
                    
                    if (warnings.length > 0) {
                        console.warn('警告:', warnings);
                    }
                    
                    alert('✅ 階段 1 完成: 資料驗證通過！\n\n' +
                          `共 ${jsonData.length} 行資料\n` +
                          `錯誤: ${errors.length}\n` +
                          `警告: ${warnings.length}\n\n` +
                          '請查看 Console 以了解詳細資訊。');
                    
                    // === 階段 2: 資料預處理 ===
                    console.log('\n=== 階段 2: 資料預處理 ===');
                    
                    const productGroups = {};
                    
                    jsonData.forEach(row => {
                        const brand = row['品牌'];
                        const mainCategory = row['大分類'] || '';
                        const subCategory = row['小分類'] || '';
                        const productName = row['商品名稱'];
                        const mainSku = row['主貨號'] || '';
                        
                        // 建立分組 key
                        const groupKey = `${brand}|${mainCategory}|${subCategory}|${productName}|${mainSku}`;
                        
                        if (!productGroups[groupKey]) {
                            productGroups[groupKey] = {
                                brand,
                                mainCategory,
                                subCategory,
                                productName,
                                mainSku,
                                rows: []
                            };
                        }
                        
                        productGroups[groupKey].rows.push(row);
                    });
                    
                    console.log('商品群組數:', Object.keys(productGroups).length);
                    
                    // 處理每個商品群組
                    const processedProducts = [];
                    
                    Object.values(productGroups).forEach(group => {
                        const { brand, mainCategory, subCategory, productName, mainSku, rows } = group;
                        
                        // 檢查是否有規格
                        const hasVariants = rows.some(row => 
                            row['規格1'] || row['規格2'] || row['規格3']
                        );
                        
                        if (hasVariants && rows.length > 1) {
                            // 多規格商品
                            const product = {
                                brand,
                                mainCategory,
                                subCategory,
                                name: productName,
                                sku: mainSku,
                                price: rows[0]['價格'] || 0,
                                variants: {},
                                variantPrices: {},
                                variantStock: {},
                                variantSkus: {},
                                type: 'multi-variant',
                                rowCount: rows.length
                            };
                            
                            // 收集規格維度和名稱
                            const variantDimensions = [];
                            const variantNames = [];
                            
                            if (rows.some(r => r['規格1'])) {
                                variantDimensions.push('規格1');
                                // 從第一行讀取規格名稱
                                const variantName = rows[0]['規格1名稱'] || '規格1';
                                variantNames.push(variantName);
                            }
                            if (rows.some(r => r['規格2'])) {
                                variantDimensions.push('規格2');
                                const variantName = rows[0]['規格2名稱'] || '規格2';
                                variantNames.push(variantName);
                            }
                            if (rows.some(r => r['規格3'])) {
                                variantDimensions.push('規格3');
                                const variantName = rows[0]['規格3名稱'] || '規格3';
                                variantNames.push(variantName);
                            }
                            
                            // 使用規格名稱作為 key
                            variantDimensions.forEach((dim, index) => {
                                const options = [...new Set(rows.map(r => r[dim]).filter(v => v))];
                                const variantName = variantNames[index];
                                product.variants[variantName] = options;
                            });
                            
                            // 處理每個規格組合
                            rows.forEach(row => {
                                const variantValues = [];
                                if (row['規格1']) variantValues.push(row['規格1']);
                                if (row['規格2']) variantValues.push(row['規格2']);
                                if (row['規格3']) variantValues.push(row['規格3']);
                                
                                const comboKey = variantValues.join(',');
                                
                                if (comboKey) {
                                    // 價格: 有填才設定
                                    if (row['價格'] !== undefined && row['價格'] !== '') {
                                        product.variantPrices[comboKey] = row['價格'];
                                    }
                                    // 庫存: 有填才設定
                                    if (row['庫存'] !== undefined && row['庫存'] !== '') {
                                        product.variantStock[comboKey] = row['庫存'];
                                    }
                                    // 規格貨號
                                    if (row['規格貨號']) {
                                        product.variantSkus[comboKey] = row['規格貨號'];
                                    }
                                }
                            });
                            
                            processedProducts.push(product);
                            
                        } else if (hasVariants && rows.length === 1) {
                            console.warn(`商品「${productName}」只有1行但填了規格，視為單規格商品`);
                            
                            const product = {
                                brand,
                                mainCategory,
                                subCategory,
                                name: productName,
                                sku: mainSku,
                                type: 'single',
                                rowCount: 1
                            };
                            
                            // 價格: 有填才設定
                            if (rows[0]['價格'] !== undefined && rows[0]['價格'] !== '') {
                                product.price = rows[0]['價格'];
                            }
                            
                            // 庫存: 有填才設定
                            if (rows[0]['庫存'] !== undefined && rows[0]['庫存'] !== '') {
                                product.stock = rows[0]['庫存'];
                            }
                            
                            processedProducts.push(product);
                            
                        } else {
                            // 無規格商品
                            const product = {
                                brand,
                                mainCategory,
                                subCategory,
                                name: productName,
                                sku: mainSku,
                                type: 'single',
                                rowCount: 1
                            };
                            
                            // 價格: 有填才設定
                            if (rows[0]['價格'] !== undefined && rows[0]['價格'] !== '') {
                                product.price = rows[0]['價格'];
                            }
                            
                            // 庫存: 有填才設定
                            if (rows[0]['庫存'] !== undefined && rows[0]['庫存'] !== '') {
                                product.stock = rows[0]['庫存'];
                            }
                            
                            processedProducts.push(product);
                        }
                    });
                    
                    console.log('處理完成:');
                    console.log('- 總商品數:', processedProducts.length);
                    console.log('- 多規格商品:', processedProducts.filter(p => p.type === 'multi-variant').length);
                    console.log('- 單規格商品:', processedProducts.filter(p => p.type === 'single').length);
                    console.log('商品列表:', processedProducts);
                    
                    alert('✅ 階段 2 完成: 資料預處理完成！\n\n' +
                          `總商品數: ${processedProducts.length}\n` +
                          `多規格: ${processedProducts.filter(p => p.type === 'multi-variant').length}\n` +
                          `單規格: ${processedProducts.filter(p => p.type === 'single').length}\n\n` +
                          '請查看 Console 以了解詳細資訊。');
                    
                    // === 階段 3: 比對現有商品 ===
                    console.log('\n=== 階段 3: 比對現有商品 ===');
                    
                    // 先生成 products 陣列
                    migrateOldDataToNew();
                    console.log('系統中現有商品數:', products.length);
                    
                    const toUpdate = [];  // 要更新的
                    const toAdd = [];     // 要新增的
                    
                    processedProducts.forEach(newProduct => {
                        let found = false;
                        
                        if (newProduct.sku) {
                            // 有主貨號: 在整個系統中尋找相同「商品名稱+主貨號」
                            products.forEach(existingProduct => {
                                if (existingProduct.name === newProduct.name && 
                                    existingProduct.sku === newProduct.sku) {
                                    found = true;
                                    toUpdate.push({
                                        existing: existingProduct,
                                        new: newProduct,
                                        reason: '商品名稱+主貨號相同'
                                    });
                                }
                            });
                        } else {
                            // 無主貨號: 在相同「品牌+分類」下尋找相同「商品名稱」
                            products.forEach(existingProduct => {
                                if (existingProduct.brand === newProduct.brand &&
                                    existingProduct.mainCategory === newProduct.mainCategory &&
                                    existingProduct.subCategory === newProduct.subCategory &&
                                    existingProduct.name === newProduct.name) {
                                    found = true;
                                    toUpdate.push({
                                        existing: existingProduct,
                                        new: newProduct,
                                        reason: '品牌+分類+商品名稱相同'
                                    });
                                }
                            });
                        }
                        
                        if (!found) {
                            toAdd.push(newProduct);
                        }
                    });
                    
                    // 計算要保留的商品(系統中有但Excel沒有的)
                    const toKeep = products.filter(existing => {
                        return !toUpdate.some(u => u.existing.id === existing.id);
                    });
                    
                    console.log('比對結果:');
                    console.log('- 要更新:', toUpdate.length, toUpdate);
                    console.log('- 要新增:', toAdd.length, toAdd);
                    console.log('- 要保留:', toKeep.length);
                    
                    alert('✅ 階段 3 完成: 比對完成！\n\n' +
                          `要更新: ${toUpdate.length} 個商品\n` +
                          `要新增: ${toAdd.length} 個商品\n` +
                          `要保留: ${toKeep.length} 個商品\n\n` +
                          '請查看 Console 以了解詳細資訊。');
                    
                    // === 階段 4: 執行匯入 ===
                    console.log('\n=== 階段 4: 執行匯入 ===');
                    
                    // 詢問是否匯入
                    const confirmed = confirm(
                        '確定要匯入商品嗎？\n\n' +
                        `更新: ${toUpdate.length} 個商品\n` +
                        `新增: ${toAdd.length} 個商品\n` +
                        `保留: ${toKeep.length} 個商品\n\n` +
                        '【確定】匯入\n' +
                        '【取消】取消匯入'
                    );
                    
                    if (!confirmed) {
                        alert('❌ 已取消匯入');
                        return;
                    }
                    
                    console.log('開始匯入...');
                    
                    // 執行匯入
                    let updateCount = 0;
                    let addCount = 0;
                    
                    // 更新現有商品
                    toUpdate.forEach(item => {
                        const { existing, new: newProduct } = item;
                        
                        // 在 productData 中找到並更新
                        const brand = existing.brand;
                        const mainCat = existing.mainCategory;
                        const subCat = existing.subCategory;
                        
                        if (productData[brand] && 
                            productData[brand][mainCat] && 
                            productData[brand][mainCat][subCat]) {
                            
                            const index = productData[brand][mainCat][subCat].findIndex(
                                p => p.id === existing.id
                            );
                            
                            if (index !== -1) {
                                const oldProduct = productData[brand][mainCat][subCat][index];
                                
                                // 合併更新: Excel 有填的才更新,空白保留原值
                                const updatedProduct = {
                                    ...oldProduct,
                                    ...newProduct,
                                    id: existing.id  // 保留 ID
                                };
                                
                                // 多規格商品: 合併價格和庫存
                                if (oldProduct.variants && newProduct.variants) {
                                    // 保留舊的價格和庫存,再用新的覆蓋
                                    updatedProduct.variantPrices = {
                                        ...oldProduct.variantPrices,
                                        ...newProduct.variantPrices
                                    };
                                    updatedProduct.variantStock = {
                                        ...oldProduct.variantStock,
                                        ...newProduct.variantStock
                                    };
                                    updatedProduct.variantSkus = {
                                        ...oldProduct.variantSkus,
                                        ...newProduct.variantSkus
                                    };
                                }
                                
                                productData[brand][mainCat][subCat][index] = updatedProduct;
                                updateCount++;
                            }
                        }
                    });
                    
                    // 新增商品
                    toAdd.forEach(product => {
                        const { brand, mainCategory, subCategory } = product;
                        
                        // 確保結構存在
                        if (!productData[brand]) productData[brand] = {};
                        if (!productData[brand][mainCategory]) productData[brand][mainCategory] = {};
                        if (!productData[brand][mainCategory][subCategory]) {
                            productData[brand][mainCategory][subCategory] = [];
                        }
                        
                        // 分配 ID
                        product.id = nextProductId++;
                        
                        productData[brand][mainCategory][subCategory].push(product);
                        addCount++;
                    });
                    
                    console.log('匯入完成:');
                    console.log('- 已更新:', updateCount);
                    console.log('- 已新增:', addCount);
                    
                    // 儲存並重新載入
                    saveDataToLocalStorage();
                    
                    alert('✅ 匯入完成！\n\n' +
                          `已更新: ${updateCount} 個商品\n` +
                          `已新增: ${addCount} 個商品\n\n` +
                          '頁面即將重新載入...');
                    
                    // 重新初始化
                    init();
                    closeImportModal();
                    
                } catch (error) {
                    console.error('讀取錯誤:', error);
                    alert('❌ 檔案讀取失敗！\n請確認是否為正確的 Excel 格式。');
                }
            };
            
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
        
        // 加購項目匯入
        document.getElementById('importAddonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // === 階段 1: 讀取 & 驗證 ===
                    console.log('=== 加購項目匯入 - 階段 1: 讀取 Excel ===');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    
                    if (!sheet) {
                        alert('❌ 無法讀取工作表！');
                        return;
                    }
                    
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    console.log('讀取行數:', jsonData.length);
                    
                    if (jsonData.length === 0) {
                        alert('❌ Excel 檔案沒有資料！');
                        return;
                    }
                    
                    // 驗證資料
                    const errors = [];
                    
                    jsonData.forEach((row, index) => {
                        const rowNum = index + 2;
                        
                        if (!row['項目名稱']) {
                            errors.push(`第 ${rowNum} 行: 項目名稱為空`);
                        }
                    });
                    
                    console.log('驗證完成 - 錯誤:', errors.length);
                    
                    if (errors.length > 0) {
                        const errorMsg = '❌ 發現以下錯誤:\n\n' + errors.slice(0, 10).join('\n');
                        alert(errorMsg);
                        return;
                    }
                    
                    alert(`✅ 階段 1 完成: 資料驗證通過！\n\n共 ${jsonData.length} 行資料`);
                    
                    // === 階段 2: 資料預處理 ===
                    console.log('\n=== 階段 2: 資料預處理 ===');
                    
                    const addonGroups = {};
                    
                    jsonData.forEach(row => {
                        const itemName = row['項目名稱'];
                        const mainSku = row['主貨號'] || '';
                        const groupKey = `${itemName}|${mainSku}`;
                        
                        if (!addonGroups[groupKey]) {
                            addonGroups[groupKey] = {
                                itemName,
                                mainSku,
                                rows: []
                            };
                        }
                        
                        addonGroups[groupKey].rows.push(row);
                    });
                    
                    console.log('加購項目群組數:', Object.keys(addonGroups).length);
                    
                    const processedAddons = [];
                    
                    Object.values(addonGroups).forEach(group => {
                        const { itemName, mainSku, rows } = group;
                        
                        const hasVariants = rows.some(row => 
                            row['規格1'] || row['規格2'] || row['規格3']
                        );
                        
                        if (hasVariants && rows.length > 1) {
                            // 多規格
                            const addon = {
                                name: itemName,
                                sku: mainSku,
                                type: 'custom',
                                variants: {},
                                variantPrices: {},
                                variantStock: {},
                                variantSkus: {}
                            };
                            
                            // 收集規格維度和名稱
                            const variantDimensions = [];
                            const variantNames = [];
                            
                            if (rows.some(r => r['規格1'])) {
                                variantDimensions.push('規格1');
                                const variantName = rows[0]['規格1名稱'] || '規格1';
                                variantNames.push(variantName);
                            }
                            if (rows.some(r => r['規格2'])) {
                                variantDimensions.push('規格2');
                                const variantName = rows[0]['規格2名稱'] || '規格2';
                                variantNames.push(variantName);
                            }
                            if (rows.some(r => r['規格3'])) {
                                variantDimensions.push('規格3');
                                const variantName = rows[0]['規格3名稱'] || '規格3';
                                variantNames.push(variantName);
                            }
                            
                            // 使用規格名稱作為 key
                            variantDimensions.forEach((dim, index) => {
                                const options = [...new Set(rows.map(r => r[dim]).filter(v => v))];
                                const variantName = variantNames[index];
                                addon.variants[variantName] = options;
                            });
                            
                            rows.forEach(row => {
                                const variantValues = [];
                                if (row['規格1']) variantValues.push(row['規格1']);
                                if (row['規格2']) variantValues.push(row['規格2']);
                                if (row['規格3']) variantValues.push(row['規格3']);
                                
                                const comboKey = variantValues.join(',');
                                
                                if (comboKey) {
                                    if (row['價格'] !== undefined && row['價格'] !== '') {
                                        addon.variantPrices[comboKey] = row['價格'];
                                    }
                                    if (row['庫存'] !== undefined && row['庫存'] !== '') {
                                        addon.variantStock[comboKey] = row['庫存'];
                                    }
                                    if (row['規格貨號']) {
                                        addon.variantSkus[comboKey] = row['規格貨號'];
                                    }
                                }
                            });
                            
                            processedAddons.push(addon);
                        } else {
                            // 單規格
                            const addon = {
                                name: itemName,
                                sku: mainSku,
                                type: 'custom'
                            };
                            
                            if (rows[0]['價格'] !== undefined && rows[0]['價格'] !== '') {
                                addon.price = rows[0]['價格'];
                            }
                            if (rows[0]['庫存'] !== undefined && rows[0]['庫存'] !== '') {
                                addon.stock = rows[0]['庫存'];
                            }
                            
                            processedAddons.push(addon);
                        }
                    });
                    
                    console.log('處理完成 - 總數:', processedAddons.length);
                    
                    alert(`✅ 階段 2 完成: 資料預處理完成！\n\n總數: ${processedAddons.length}`);
                    
                    // === 階段 3: 比對現有項目 ===
                    console.log('\n=== 階段 3: 比對現有項目 ===');
                    
                    const toUpdate = [];
                    const toAdd = [];
                    
                    processedAddons.forEach(newAddon => {
                        let found = false;
                        
                        addOnItems.forEach(existing => {
                            if (newAddon.sku) {
                                if (existing.name === newAddon.name && existing.sku === newAddon.sku) {
                                    found = true;
                                    toUpdate.push({ existing, new: newAddon });
                                }
                            } else {
                                if (existing.name === newAddon.name) {
                                    found = true;
                                    toUpdate.push({ existing, new: newAddon });
                                }
                            }
                        });
                        
                        if (!found) {
                            toAdd.push(newAddon);
                        }
                    });
                    
                    console.log('比對結果 - 更新:', toUpdate.length, '新增:', toAdd.length);
                    
                    alert(`✅ 階段 3 完成: 比對完成！\n\n更新: ${toUpdate.length}\n新增: ${toAdd.length}`);
                    
                    // === 階段 4: 執行匯入 ===
                    console.log('\n=== 階段 4: 執行匯入 ===');
                    
                    const confirmed = confirm(
                        `確定要匯入加購項目嗎？\n\n` +
                        `更新: ${toUpdate.length}\n` +
                        `新增: ${toAdd.length}\n\n` +
                        `【確定】匯入\n【取消】取消`
                    );
                    
                    if (!confirmed) {
                        alert('❌ 已取消匯入');
                        return;
                    }
                    
                    let updateCount = 0;
                    let addCount = 0;
                    
                    // 更新
                    toUpdate.forEach(item => {
                        const { existing, new: newAddon } = item;
                        const index = addOnItems.findIndex(a => a.id === existing.id);
                        
                        if (index !== -1) {
                            const updated = {
                                ...addOnItems[index],
                                ...newAddon,
                                id: existing.id
                            };
                            
                            if (existing.variants && newAddon.variants) {
                                updated.variantPrices = {
                                    ...addOnItems[index].variantPrices,
                                    ...newAddon.variantPrices
                                };
                                updated.variantStock = {
                                    ...addOnItems[index].variantStock,
                                    ...newAddon.variantStock
                                };
                                updated.variantSkus = {
                                    ...addOnItems[index].variantSkus,
                                    ...newAddon.variantSkus
                                };
                            }
                            
                            addOnItems[index] = updated;
                            updateCount++;
                        }
                    });
                    
                    // 新增
                    toAdd.forEach(addon => {
                        addon.id = 'addon_' + Date.now() + '_' + Math.random();
                        addOnItems.push(addon);
                        addCount++;
                    });
                    
                    saveDataToLocalStorage();
                    loadAddonItems();
                    closeImportModal();
                    
                    alert(`✅ 匯入完成！\n\n已更新: ${updateCount}\n已新增: ${addCount}`);
                    
                } catch (error) {
                    console.error('匯入錯誤:', error);
                    alert('❌ 檔案讀取失敗！');
                }
            };
            
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
        
        
        // 加入或更新加購項目的輔助函數
        function addOrUpdateAddon(addon, importMode) {
            if (importMode === 'merge') {
                // 合併模式：尋找並更新現有項目
                let found = false;
                
                // 優先依 ID 查找
                if (addon.id) {
                    const index = addOnItems.findIndex(item => item.id === addon.id);
                    if (index !== -1) {
                        addOnItems[index] = addon;
                        found = true;
                    }
                }
                
                // 如果沒找到，依項目名稱+主貨號查找
                if (!found && addon.sku) {
                    const index = addOnItems.findIndex(item => 
                        item.name === addon.name && item.sku === addon.sku
                    );
                    if (index !== -1) {
                        addOnItems[index] = addon;
                        found = true;
                    }
                }
                
                // 如果沒找到，只依項目名稱查找（沒有貨號的情況）
                if (!found && !addon.sku) {
                    const index = addOnItems.findIndex(item => item.name === addon.name);
                    if (index !== -1) {
                        addOnItems[index] = addon;
                        found = true;
                    }
                }
                
                // 如果都沒找到，新增
                if (!found) {
                    addOnItems.push(addon);
                }
            } else {
                // 覆蓋模式：直接加入
                addOnItems.push(addon);
            }
        }

        // 贈品資料匯入
        document.getElementById('importGiftFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('=== 贈品匯入 - 階段 1 ===');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    
                    if (!sheet) {
                        alert('❌ 無法讀取工作表！');
                        return;
                    }
                    
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    if (jsonData.length === 0) {
                        alert('❌ Excel 檔案沒有資料！');
                        return;
                    }
                    
                    const errors = [];
                    jsonData.forEach((row, index) => {
                        const rowNum = index + 2;
                        if (!row['贈品活動名稱']) errors.push(`第 ${rowNum} 行: 贈品活動名稱為空`);
                        if (!row['條件類型']) {
                            errors.push(`第 ${rowNum} 行: 條件類型為空`);
                        } else if (row['條件類型'] !== '滿額贈送' && row['條件類型'] !== '滿件贈送') {
                            errors.push(`第 ${rowNum} 行: 條件類型錯誤，請填「滿額贈送」或「滿件贈送」`);
                        }
                        if (!row['條件值'] && row['條件值'] !== 0) errors.push(`第 ${rowNum} 行: 條件值為空`);
                        if (!row['贈品名稱']) errors.push(`第 ${rowNum} 行: 贈品名稱為空`);
                        if (!row['贈品數量'] && row['贈品數量'] !== 0) errors.push(`第 ${rowNum} 行: 贈品數量為空`);
                    });
                    
                    if (errors.length > 0) {
                        alert('❌ 發現錯誤:\n\n' + errors.slice(0, 10).join('\n'));
                        return;
                    }
                    
                    const toUpdate = [];
                    const toAdd = [];
                    
                    jsonData.forEach(row => {
                        const gift = {
                            name: row['贈品活動名稱'],
                            conditionType: row['條件類型'] === '滿額贈送' ? 'minAmount' : 'minItems',
                            conditionValue: row['條件值'],
                            giftName: row['贈品名稱'],
                            giftQty: row['贈品數量']
                        };
                        if (row['贈品貨號']) gift.giftSku = row['贈品貨號'];
                        if (row['贈品庫存數量'] !== undefined && row['贈品庫存數量'] !== '') gift.giftStock = row['贈品庫存數量'];
                        
                        const existing = giftRules.find(g => g.name === gift.name);
                        if (existing) {
                            toUpdate.push({ existing, new: gift });
                        } else {
                            toAdd.push(gift);
                        }
                    });
                    
                    const confirmed = confirm(`確定匯入？\n\n更新: ${toUpdate.length}\n新增: ${toAdd.length}`);
                    if (!confirmed) {
                        alert('❌ 已取消');
                        return;
                    }
                    
                    toUpdate.forEach(item => {
                        const index = giftRules.findIndex(g => g.id === item.existing.id);
                        if (index !== -1) {
                            giftRules[index] = { ...giftRules[index], ...item.new, id: item.existing.id };
                        }
                    });
                    
                    toAdd.forEach(gift => {
                        gift.id = 'gift_' + Date.now() + '_' + Math.random();
                        giftRules.push(gift);
                    });
                    
                    saveDataToLocalStorage();
                    loadGiftButtons();
                    closeImportModal();
                    alert(`✅ 完成！\n\n更新: ${toUpdate.length}\n新增: ${toAdd.length}`);
                    
                } catch (error) {
                    console.error(error);
                    alert('❌ 檔案讀取失敗！');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
        
        // 加入或更新贈品規則的輔助函數
        function addOrUpdateGift(gift, importMode) {
            if (importMode === 'merge') {
                // 合併模式：尋找並更新現有規則
                let found = false;
                
                // 優先依 ID 查找
                if (gift.id) {
                    const index = giftRules.findIndex(rule => rule.id === gift.id);
                    if (index !== -1) {
                        giftRules[index] = gift;
                        found = true;
                    }
                }
                
                // 如果沒找到，依規則名稱查找
                if (!found) {
                    const index = giftRules.findIndex(rule => rule.name === gift.name);
                    if (index !== -1) {
                        giftRules[index] = gift;
                        found = true;
                    }
                }
                
                // 如果都沒找到，新增
                if (!found) {
                    giftRules.push(gift);
                }
            } else {
                // 覆蓋模式：直接加入
                giftRules.push(gift);
            }
        }

        // 銷售記錄匯入

        // 確認匯出商品資料
        function confirmExportProducts() {
            // 檢查是否有商品
            if (products.length === 0) {
                alert('目前沒有商品資料可匯出');
                return;
            }
            
            // 關閉匯出彈窗，打開品牌選擇彈窗
            closeExportModal();
            openBrandSelectModal();
        }
        
        // 打開品牌選擇彈窗
        function openBrandSelectModal() {
            // 動態取得所有品牌（從 productData 抓取，按照品牌管理中的順序）
            const allBrands = Object.keys(productData);
            
            // 取得彈窗中的選項容器
            const container = document.querySelector('#brandSelectModal .modal-body > div:first-of-type');
            
            // 清空現有選項
            container.innerHTML = '';
            
            // 新增「全部品牌」選項
            container.innerHTML += `
                <label style="display: flex; align-items: center; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(11, 79, 124, 0.05)'" onmouseout="this.style.background='white'">
                    <input type="radio" name="brandSelect" value="all" checked style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 15px; font-weight: 500;">全部品牌</span>
                </label>
            `;
            
            // 動態生成每個品牌的選項
            allBrands.forEach(brand => {
                container.innerHTML += `
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(11, 79, 124, 0.05)'" onmouseout="this.style.background='white'">
                        <input type="radio" name="brandSelect" value="${brand}" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 15px; font-weight: 500;">${brand}</span>
                    </label>
                `;
            });
            
            document.getElementById('brandSelectModal').classList.add('show');
        }
        
        // 關閉品牌選擇彈窗
        function closeBrandSelectModal() {
            document.getElementById('brandSelectModal').classList.remove('show');
        }
        
        // 執行品牌匯出（從品牌選擇彈窗呼叫）
        function executeBrandExport() {
            // 取得選中的品牌
            const selectedBrand = document.querySelector('input[name="brandSelect"]:checked').value;
            
            // 關閉品牌選擇彈窗
            closeBrandSelectModal();
            
            // 執行匯出
            exportProducts(selectedBrand);
        }

        // 匯出商品資料
        function exportProducts(brandSelection = 'all') {
            // Debug: 顯示商品數量和品牌資訊
            console.log('=== 匯出商品 Debug ===');
            console.log('brandSelection:', brandSelection);
            console.log('總商品數:', products.length);
            console.log('商品範例:', products.slice(0, 2));
            
            // 檢查是否有商品
            if (products.length === 0) {
                alert('目前沒有商品資料可匯出\n\n請先新增商品後再匯出');
                return;
            }
            
            // 輔助函數：將品牌簡稱轉換為可能的品牌值（簡稱或全稱）
            function getBrandValues(brandCode) {
                if (brandCode === 'all') return null;
                // 返回簡稱和全稱都支援
                return [brandCode, brandFullNames[brandCode]];
            }
            
            // 輔助函數：檢查商品是否屬於指定品牌
            function matchesBrand(product, brandCode) {
                if (brandCode === 'all') return true;
                const brandValues = getBrandValues(brandCode);
                return brandValues.includes(product.brand);
            }
            
            // 輔助函數：取得商品的品牌全稱
            function getProductBrandFullName(product) {
                // 如果已經是全稱，直接返回
                if (product.brand === 'T&A選品' || product.brand === 'ALd.輕手作') {
                    return product.brand;
                }
                // 如果是簡稱，轉換為全稱
                return brandFullNames[product.brand] || product.brand;
            }
            
            // 輔助函數：生成規格組合
            function generateCombinations(arrays, prefix = []) {
                if (arrays.length === 0) return [prefix];
                const result = [];
                const firstArray = arrays[0];
                const restArrays = arrays.slice(1);
                firstArray.forEach(item => {
                    result.push(...generateCombinations(restArrays, [...prefix, item]));
                });
                return result;
            }
            
            // 輔助函數：將商品轉換為 Excel 行資料
            function productToRows(product) {
                const rows = [];
                const brandFullName = getProductBrandFullName(product);
                
                if (product.variants && Object.keys(product.variants).length > 0) {
                    // 多規格商品
                    const variantNames = Object.keys(product.variants);
                    const variantOptions = Object.values(product.variants);
                    const combinations = generateCombinations(variantOptions);
                    
                    combinations.forEach(combo => {
                        const comboKey = combo.join(',');
                        const variantPrice = product.variantPrices?.[comboKey] || product.price || 0;
                        const variantStock = product.variantStock?.[comboKey] || 0;
                        const variantSku = product.variantSkus?.[comboKey] || '';
                        
                        rows.push([
                            brandFullName,
                            product.mainCategory,
                            product.subCategory,
                            product.name,
                            product.sku || '',
                            variantNames[0] || '',  // 規格1名稱
                            combo[0] || '',         // 規格1
                            variantNames[1] || '',  // 規格2名稱
                            combo[1] || '',         // 規格2
                            variantNames[2] || '',  // 規格3名稱
                            combo[2] || '',         // 規格3
                            variantPrice,
                            variantStock,
                            variantSku
                        ]);
                    });
                } else {
                    // 無規格商品
                    rows.push([
                        brandFullName,
                        product.mainCategory,
                        product.subCategory,
                        product.name,
                        product.sku || '',
                        '', '', // 規格1名稱, 規格1
                        '', '', // 規格2名稱, 規格2
                        '', '', // 規格3名稱, 規格3
                        product.price || 0,
                        product.stock !== undefined ? product.stock : '',
                        ''
                    ]);
                }
                
                return rows;
            }
            
            // 建立 Excel 工作簿
            const wb = XLSX.utils.book_new();
            
            // 欄寬設定
            const colWidths = [
                {wch: 12}, // 品牌
                {wch: 12}, // 大分類
                {wch: 12}, // 小分類
                {wch: 25}, // 商品名稱
                {wch: 15}, // 主貨號
                {wch: 12}, // 規格1名稱
                {wch: 12}, // 規格1
                {wch: 12}, // 規格2名稱
                {wch: 12}, // 規格2
                {wch: 12}, // 規格3名稱
                {wch: 12}, // 規格3
                {wch: 10}, // 價格
                {wch: 8},  // 庫存
                {wch: 18}  // 規格貨號
            ];
            
            if (brandSelection === 'all') {
                // 匯出全部品牌 - 分成多個工作表
                // 動態取得所有品牌（從 productData 抓取，按照品牌管理中的順序）
                const allBrands = Object.keys(productData);
                
                allBrands.forEach(brand => {
                    const brandProducts = products.filter(p => p.brand === brand);
                    
                    console.log(`品牌 ${brand} 的商品數:`, brandProducts.length);
                    
                    if (brandProducts.length > 0) {
                        const ws_data = [['品牌', '大分類', '小分類', '商品名稱', '主貨號', '規格1名稱', '規格1', '規格2名稱', '規格2', '規格3名稱', '規格3', '價格', '庫存', '規格貨號']];
                        
                        brandProducts.forEach(product => {
                            const rows = productToRows(product);
                            rows.forEach(row => ws_data.push(row));
                        });
                        
                        const ws = XLSX.utils.aoa_to_sheet(ws_data);
                        ws['!cols'] = colWidths;
                        
                        // 工作表名稱直接使用品牌名稱（已經是全稱）
                        XLSX.utils.book_append_sheet(wb, ws, brand);
                    }
                });
                
                // 檔名
                XLSX.writeFile(wb, `商品清單_全部品牌_${new Date().toLocaleDateString()}.xlsx`);
                
            } else {
                // 匯出單一品牌
                const brandProducts = products.filter(p => p.brand === brandSelection);
                
                console.log(`品牌 ${brandSelection} 的商品數:`, brandProducts.length);
                
                if (brandProducts.length === 0) {
                    alert(`${brandSelection} 沒有商品資料`);
                    return;
                }
                
                const ws_data = [['品牌', '大分類', '小分類', '商品名稱', '主貨號', '規格1', '規格2', '規格3', '價格', '庫存', '規格貨號']];
                
                brandProducts.forEach(product => {
                    const rows = productToRows(product);
                    rows.forEach(row => ws_data.push(row));
                });
                
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, '商品清單');
                
                // 檔名直接使用品牌名稱（已經是全稱）
                XLSX.writeFile(wb, `商品清單_${brandSelection}_${new Date().toLocaleDateString()}.xlsx`);
            }
            
            showNotification('✅ 商品資料已匯出！');
        }

        // 確認匯出加購項目
        function confirmExportAddons() {
            if (addOnItems.length === 0) {
                alert('尚無加購項目可匯出');
                return;
            }
            if (!confirm('確定要匯出加購項目嗎？')) return;
            exportAddons();
            closeExportModal();
        }

        // 匯出加購項目
        function exportAddons() {
            if (addOnItems.length === 0) {
                alert('目前無加購項目可匯出');
                return;
            }

            // Excel 欄位標題 (加入規格名稱)
            const ws_data = [['項目名稱', '主貨號', '規格1名稱', '規格1', '規格2名稱', '規格2', '規格3名稱', '規格3', '價格', '庫存', '規格貨號']];
            
            addOnItems.forEach(item => {
                // 檢查是否有多規格
                const hasVariants = item.variants && Object.keys(item.variants).length > 0;
                
                if (hasVariants) {
                    // 多規格項目 - 展開所有規格組合
                    const variantNames = Object.keys(item.variants);
                    const variantOptions = Object.values(item.variants);
                    
                    // 生成所有規格組合的輔助函數
                    function generateCombinations(arrays, prefix = []) {
                        if (arrays.length === 0) return [prefix];
                        const result = [];
                        const firstArray = arrays[0];
                        const restArrays = arrays.slice(1);
                        firstArray.forEach(item => {
                            result.push(...generateCombinations(restArrays, [...prefix, item]));
                        });
                        return result;
                    }
                    
                    const combinations = generateCombinations(variantOptions);
                    
                    // 輸出每個規格組合 (加入規格名稱)
                    combinations.forEach(combo => {
                        const comboKey = combo.join(',');
                        const variantPrice = item.variantPrices?.[comboKey] || item.price || 0;
                        const variantStock = item.variantStock?.[comboKey] || 0;
                        const variantSku = item.variantSkus?.[comboKey] || '';
                        
                        ws_data.push([
                            item.name,
                            item.sku || '',
                            variantNames[0] || '',  // 規格1名稱
                            combo[0] || '',         // 規格1
                            variantNames[1] || '',  // 規格2名稱
                            combo[1] || '',         // 規格2
                            variantNames[2] || '',  // 規格3名稱
                            combo[2] || '',         // 規格3
                            variantPrice,
                            variantStock,
                            variantSku
                        ]);
                    });
                } else {
                    // 無規格項目
                    ws_data.push([
                        item.name,
                        item.sku || '',
                        '', '', // 規格1名稱, 規格1
                        '', '', // 規格2名稱, 規格2
                        '', '', // 規格3名稱, 規格3
                        item.price || 0,
                        item.stock !== undefined ? item.stock : '',
                        ''   // 規格貨號（無規格時為空）
                    ]);
                }
            });

            // 建立 Excel 工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 15}, // ID
                {wch: 25}, // 項目名稱
                {wch: 15}, // 主貨號
                {wch: 12}, // 規格1
                {wch: 12}, // 規格2
                {wch: 12}, // 規格3
                {wch: 10}, // 價格
                {wch: 8},  // 庫存
                {wch: 18}  // 規格貨號
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '加購項目');
            XLSX.writeFile(wb, `加購項目_${new Date().toLocaleDateString()}.xlsx`);
            
            showNotification('✅ 加購項目已匯出！');
        }

        // 確認匯出贈品資料
        function confirmExportGifts() {
            if (giftRules.length === 0) {
                alert('尚無贈品資料可匯出');
                return;
            }
            if (!confirm('確定要匯出贈品資料嗎？')) return;
            exportGifts();
            closeExportModal();
        }

        // 匯出贈品資料
        function exportGifts() {
            if (giftRules.length === 0) {
                alert('目前無贈品資料可匯出');
                return;
            }

            // Excel 欄位標題
            const ws_data = [['贈品活動名稱', '條件類型', '條件值', '贈品名稱', '贈品數量', '贈品貨號', '贈品庫存數量']];
            
            giftRules.forEach(gift => {
                // 條件類型轉換為中文
                let conditionTypeText = '';
                if (gift.conditionType === 'minAmount') {
                    conditionTypeText = '滿額贈送';
                } else if (gift.conditionType === 'minItems') {
                    conditionTypeText = '滿件贈送';
                } else {
                    conditionTypeText = gift.conditionType || '';
                }
                
                ws_data.push([
                    gift.name,
                    conditionTypeText,
                    gift.conditionValue || 0,
                    gift.giftName,
                    gift.giftQty || 1,
                    gift.giftSku || '',
                    gift.giftStock !== undefined ? gift.giftStock : ''
                ]);
            });

            // 建立 Excel 工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 20}, // 贈品活動名稱
                {wch: 12}, // 條件類型
                {wch: 10}, // 條件值
                {wch: 20}, // 贈品名稱
                {wch: 10}, // 贈品數量
                {wch: 15}, // 贈品貨號
                {wch: 15}  // 贈品庫存數量
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '贈品資料');
            XLSX.writeFile(wb, `贈品資料_${new Date().toLocaleDateString()}.xlsx`);
            
            showNotification('✅ 贈品資料已匯出！');
        }

        // 確認匯出銷售記錄
        function confirmExportSales() {
            if (salesHistory.length === 0) {
                alert('尚無銷售記錄可匯出');
                return;
            }
            if (!confirm('確定要匯出銷售記錄嗎？')) return;
            exportSales();
            closeExportModal();
        }

        // Excel 匯出 - 銷售記錄
        function exportSales() {
            if (filteredSales.length === 0) {
                alert('目前篩選條件下無銷售記錄可匯出');
                return;
            }

            const ws_data = [['訂單編號', '訂單日期', '結帳時間', '銷售地點', '銷售人員', '會員帳號', '會員姓名', '會員電話', '會員Email', '項目類型', '商品名稱', '貨號', '規格', '數量', '單價', '小計', '折扣名稱', '折扣類型', '折扣描述', '折扣比例', '折扣金額', '訂單總額', '訂單備註']];
            
            filteredSales.forEach(sale => {
                let isFirstRow = true;
                
                // 分類處理所有項目
                const products = sale.items.filter(item => !item.isGift) || [];
                const gifts = sale.items.filter(item => item.isGift) || [];
                const addons = sale.addOnItems || [];
                
                // 輸出一般商品
                products.forEach((item) => {
                    const variantText = item.selectedVariants ? 
                        Object.entries(item.selectedVariants).map(([k, v]) => `${k}:${v}`).join(', ') : '';
                    
                    // 處理折扣資訊（只在第一行顯示）
                    let discountName = '';
                    let discountType = '';
                    let discountDesc = '';
                    let discountRate = '';
                    let discountAmount = '';
                    
                    if (isFirstRow && sale.discounts && sale.discounts.length > 0) {
                        discountName = sale.discounts.map(d => d.name).join(', ');
                        discountType = sale.discounts.map(d => d.type === 'rate' ? '比例折扣' : '固定金額').join(', ');
                        discountDesc = sale.discounts.map(d => d.description || '').join(', ');
                        discountRate = sale.discounts.map(d => d.rate ? `${(d.rate * 100).toFixed(0)}%` : '').join(', ');
                        discountAmount = sale.discountAmount || 0;
                    }
                    
                    ws_data.push([
                        isFirstRow ? (sale.orderNumber || '') : '',
                        isFirstRow ? (sale.orderDate || '') : '',
                        isFirstRow ? (sale.timestampDisplay || '') : '',
                        isFirstRow ? (sale.saleLocation || '') : '',
                        isFirstRow ? (sale.salesPerson || '') : '',
                        isFirstRow ? (sale.memberAccount || '') : '',
                        isFirstRow ? (sale.memberName || '') : '',
                        isFirstRow ? (sale.memberPhone || '') : '',
                        isFirstRow ? (sale.memberEmail || '') : '',
                        '一般商品',
                        item.name,
                        item.sku || '',
                        variantText,
                        item.quantity,
                        item.price,
                        item.price * item.quantity,
                        discountName,
                        discountType,
                        discountDesc,
                        discountRate,
                        isFirstRow ? discountAmount : '',
                        isFirstRow ? sale.total : '',
                        isFirstRow ? (sale.orderNote || '') : ''
                    ]);
                    
                    isFirstRow = false;
                });
                
                // 輸出加購項目
                addons.forEach(addon => {
                    ws_data.push([
                        '', '', '', '', '', '', '', '', '',
                        '加購項目',
                        addon.name,
                        addon.sku || '',
                        '',
                        addon.quantity,
                        addon.price,
                        addon.price * addon.quantity,
                        '', '', '', '', '', '', ''
                    ]);
                });
                
                // 輸出贈品
                gifts.forEach(gift => {
                    ws_data.push([
                        '', '', '', '', '', '', '', '', '',
                        '贈品',
                        gift.name,
                        gift.sku || '',
                        '',
                        gift.quantity,
                        gift.price,
                        gift.price * gift.quantity,
                        gift.giftRuleName || '',  // 在折扣名稱欄位顯示贈品規則
                        '', '', '', '', '', ''
                    ]);
                });
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 15}, {wch: 12}, {wch: 18}, {wch: 12}, {wch: 10}, {wch: 12}, 
                {wch: 10}, {wch: 12}, {wch: 20}, {wch: 10}, {wch: 25}, {wch: 15}, 
                {wch: 20}, {wch: 8}, {wch: 10}, {wch: 10}, {wch: 18}, {wch: 12},
                {wch: 20}, {wch: 10}, {wch: 10}, {wch: 12}, {wch: 30}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '銷售記錄');
            XLSX.writeFile(wb, `銷售記錄_${new Date().toLocaleDateString()}.xlsx`);
            
            showNotification('✅ 銷售記錄已匯出！');
        }

        // 顯示通知
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // ============================================
        // 新增功能：商品搜尋
        // ============================================
        let searchQuery = '';
        let filteredProducts = [];

        function searchProducts(query) {
            searchQuery = query.trim().toLowerCase();
            const searchClear = document.getElementById('searchClear');
            const searchResultsCount = document.getElementById('searchResultsCount');
            
            if (searchQuery) {
                searchClear.classList.add('show');
                filteredProducts = [];
                Object.keys(productData).forEach(brand => {
                    Object.keys(productData[brand]).forEach(mainCat => {
                        Object.keys(productData[brand][mainCat]).forEach(subCat => {
                            productData[brand][mainCat][subCat].forEach(product => {
                                if (product.name.toLowerCase().includes(searchQuery) ||
                                    (product.code && product.code.toLowerCase().includes(searchQuery))) {
                                    filteredProducts.push({...product, brand, mainCat, subCat});
                                }
                            });
                        });
                    });
                });
                searchResultsCount.textContent = `找到 ${filteredProducts.length} 件商品`;
                displaySearchResults();
            } else {
                searchClear.classList.remove('show');
                searchResultsCount.textContent = '';
                filteredProducts = [];
                loadProducts();
            }
        }

        function clearSearch() {
            document.getElementById('productSearch').value = '';
            searchProducts('');
        }

        function displaySearchResults() {
            const container = document.querySelector('.products-grid');
            if (!container) return;
            
            if (filteredProducts.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">找不到相關商品</div>';
                return;
            }
            
            container.innerHTML = filteredProducts.map(product => {
                const variantInfo = product.variants ? '<div class="product-variants">有多規格</div>' : '';
                const skuInfo = product.sku ? `<div class="product-sku">${product.sku}</div>` : '';
                
                // 計算價格範圍
                let priceDisplay = '';
                if (product.variantPrices && Object.keys(product.variantPrices).length > 0) {
                    const prices = Object.values(product.variantPrices);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice !== maxPrice) {
                        priceDisplay = `NT$ ${minPrice}-${maxPrice}`;
                    } else {
                        priceDisplay = `NT$ ${minPrice}`;
                    }
                } else if (product.price && product.price > 0) {
                    priceDisplay = `NT$ ${product.price}`;
                } else {
                    priceDisplay = '請設定價格';
                }
                
                // 計算庫存總和
                let totalStock = 0;
                if (product.variantStock) {
                    totalStock = Object.values(product.variantStock).reduce((sum, stock) => sum + stock, 0);
                } else if (product.stock !== undefined) {
                    totalStock = product.stock;
                }
                
                // 庫存顯示
                let stockInfo = '';
                if (totalStock !== undefined && totalStock !== null) {
                    let stockColor = '#388e3c';
                    if (totalStock <= 0) {
                        stockColor = '#d32f2f';
                    } else if (totalStock <= 5) {
                        stockColor = '#f57c00';
                    }
                    stockInfo = `<div class="product-stock" style="color: ${stockColor};">庫存: ${totalStock}</div>`;
                }
                
                // 檢查是否售罄
                const isSoldOut = totalStock <= 0;
                const cardClass = isSoldOut ? 'product-card sold-out' : 'product-card';
                const clickEvent = isSoldOut ? 'onclick="alert(\'此商品已售罄\')"' : `onclick='selectProduct(${JSON.stringify(product)})'`;
                const soldOutLabel = isSoldOut ? '<div class="sold-out-label">售罄</div>' : '';
                
                return `
                    <div class="${cardClass}" ${clickEvent}>
                        <div class="product-name">${product.name}</div>
                        ${skuInfo}
                        <div class="product-price">${priceDisplay}</div>
                        ${stockInfo}
                        ${variantInfo}
                        
                        ${soldOutLabel}
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // 新增功能：熱銷商品
        // ============================================
        // ============================================
        // 新增功能：品牌管理
        // ============================================
        function openBrandManager() {
            loadBrandManageList();
            document.getElementById('brandManagerModal').classList.add('show');
        }

        function closeBrandManager() {
            document.getElementById('brandManagerModal').classList.remove('show');
        }

        function loadBrandManageList() {
            const container = document.getElementById('brandManageList');
            if (!container) return;
            
            const brands = Object.keys(productData);
            
            if (brands.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">尚未新增品牌</div>';
                return;
            }
            
            container.innerHTML = brands.map((brand, index) => {
                // 直接顯示品牌名稱，不做轉換
                return `
                <div class="brand-item-manage">
                    <div style="display: flex; gap: 8px; align-items: center; flex: 1;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <button 
                                onclick="moveBrandUp(${index})"
                                ${index === 0 ? 'disabled' : ''}
                                style="background: var(--primary-color); color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                            >▲</button>
                            <button 
                                onclick="moveBrandDown(${index})"
                                ${index === brands.length - 1 ? 'disabled' : ''}
                                style="background: var(--primary-color); color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                            >▼</button>
                        </div>
                        <div class="brand-name-manage">${brand}</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button 
                            class="edit-btn" 
                            onclick="editBrand('${brand.replace(/'/g, "\\'")}', ${index})"
                            style="background: var(--primary-color); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;"
                        >
                            編輯
                        </button>
                        <button 
                            class="remove-btn" 
                            onclick="removeBrand('${brand.replace(/'/g, "\\'")}')"
                            style="background: var(--danger-color); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;"
                        >
                            刪除
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // 編輯品牌名稱
        function editBrand(oldName, index) {
            const newName = prompt('請輸入新的品牌名稱：', oldName);
            
            if (!newName || newName === oldName) return;
            
            if (productData[newName]) {
                alert('此品牌名稱已存在');
                return;
            }
            
            // 更新 productData
            productData[newName] = productData[oldName];
            delete productData[oldName];
            
            // 更新 products 陣列
            products.forEach(p => {
                if (p.brand === oldName) p.brand = newName;
            });
            
            // 更新 categories
            if (categories.mainCategories && categories.mainCategories[oldName]) {
                categories.mainCategories[newName] = categories.mainCategories[oldName];
                delete categories.mainCategories[oldName];
            }
            if (categories.subCategories && categories.subCategories[oldName]) {
                categories.subCategories[newName] = categories.subCategories[oldName];
                delete categories.subCategories[oldName];
            }
            
            saveDataToLocalStorage();
            loadBrandManageList();
            renderBrandTabs();
            initProductFilters();
            showNotification('✅ 品牌名稱已更新');
        }

        // 上移品牌
        function moveBrandUp(index) {
            const brands = Object.keys(productData);
            if (index === 0) return;
            
            // 交換位置
            const temp = {};
            brands.forEach((brand, i) => {
                if (i === index - 1) {
                    temp[brands[index]] = productData[brands[index]];
                } else if (i === index) {
                    temp[brands[index - 1]] = productData[brands[index - 1]];
                } else {
                    temp[brand] = productData[brand];
                }
            });
            
            productData = temp;
            saveDataToLocalStorage();
            loadBrandManageList();
            renderBrandTabs();
            showNotification('✅ 品牌順序已調整');
        }

        // 下移品牌
        function moveBrandDown(index) {
            const brands = Object.keys(productData);
            if (index === brands.length - 1) return;
            
            // 交換位置
            const temp = {};
            brands.forEach((brand, i) => {
                if (i === index) {
                    temp[brands[index + 1]] = productData[brands[index + 1]];
                } else if (i === index + 1) {
                    temp[brands[index]] = productData[brands[index]];
                } else {
                    temp[brand] = productData[brand];
                }
            });
            
            productData = temp;
            saveDataToLocalStorage();
            loadBrandManageList();
            renderBrandTabs();
            showNotification('✅ 品牌順序已調整');
        }

        function addNewBrand() {
            const input = document.getElementById('newBrandInput');
            const brandName = input.value.trim();
            
            if (!brandName) {
                alert('請輸入品牌名稱');
                return;
            }
            
            // 直接用完整品牌名稱當 key（不轉小寫）
            if (productData[brandName]) {
                alert('此品牌已存在');
                return;
            }
            
            productData[brandName] = {};
            saveDataToLocalStorage();
            
            input.value = '';
            loadBrandManageList();
            renderBrandTabs();
            initProductFilters(); // 重新初始化篩選器
            showNotification('✅ 品牌已新增');
        }

        function removeBrand(brandKey) {
            // 直接使用品牌名稱，不做轉換
            if (!confirm(`確定要刪除品牌「${brandKey}」嗎？\n刪除後該品牌的所有商品都會被移除。`)) {
                return;
            }
            
            delete productData[brandKey];
            saveDataToLocalStorage();
            loadBrandManageList();
            renderBrandTabs();
            initProductFilters(); // 重新初始化篩選器
            showNotification('✅ 品牌已刪除');
        }

        // ============================================
        // 修改：在分類中加入「所有商品」選項（已整合到下方的 loadCategories 和 selectMainCategory 函數中）
        // ============================================

        function init() {
            // 先嘗試載入保存的資料
            const hasLoadedData = loadDataFromLocalStorage();
            
            // 遷移資料到新格式,生成 products 陣列
            migrateOldDataToNew();
            
            // 為沒有 ID 的折扣補上 ID
            let needsSaveDiscounts = false;
            discountButtons.forEach((discount, index) => {
                if (!discount.id) {
                    discount.id = 'discount_' + Date.now() + '_' + index;
                    needsSaveDiscounts = true;
                }
            });
            if (needsSaveDiscounts) {
                saveDataToLocalStorage();
            }
            
            // 自動遷移舊品牌名稱（只執行一次）
            migrateBrandNames();
            
            // 如果沒有保存的資料，使用預設資料
            if (!hasLoadedData && Object.keys(productData.ta || {}).length === 0) {
                initDefaultProducts();
                saveDataToLocalStorage(); // 保存預設資料
            }
            
            renderBrandTabs(); // 新增：動態渲染品牌標籤（會自動調用 loadCategories, loadSubCategories, loadProducts）
            loadDiscountButtons();
            loadGiftButtons();
            loadAddonItems(); // 載入加購項目
            loadSaleLocationOptions(); // 載入銷售地點選單
        }

        // 品牌名稱遷移函數（一次性執行）
        function migrateBrandNames() {
            let needsSave = false;
            
            // 將 ta 改名為 T&A選品
            if (productData['ta']) {
                productData['T&A選品'] = productData['ta'];
                delete productData['ta'];
                needsSave = true;
                
                // 同步更新 categories
                if (categories.mainCategories && categories.mainCategories['ta']) {
                    categories.mainCategories['T&A選品'] = categories.mainCategories['ta'];
                    delete categories.mainCategories['ta'];
                }
                if (categories.subCategories && categories.subCategories['ta']) {
                    categories.subCategories['T&A選品'] = categories.subCategories['ta'];
                    delete categories.subCategories['ta'];
                }
            }
            
            // 將 ald 改名為 ALd.輕手作
            if (productData['ald']) {
                productData['ALd.輕手作'] = productData['ald'];
                delete productData['ald'];
                needsSave = true;
                
                // 同步更新 categories
                if (categories.mainCategories && categories.mainCategories['ald']) {
                    categories.mainCategories['ALd.輕手作'] = categories.mainCategories['ald'];
                    delete categories.mainCategories['ald'];
                }
                if (categories.subCategories && categories.subCategories['ald']) {
                    categories.subCategories['ALd.輕手作'] = categories.subCategories['ald'];
                    delete categories.subCategories['ald'];
                }
            }
            
            // 更新 products 陣列中的品牌名稱
            if (needsSave) {
                products.forEach(p => {
                    if (p.brand === 'ta') p.brand = 'T&A選品';
                    if (p.brand === 'ald') p.brand = 'ALd.輕手作';
                });
                
                // 更新 categories.brands
                if (categories.brands) {
                    categories.brands = categories.brands.map(b => {
                        if (b === 'ta') return 'T&A選品';
                        if (b === 'ald') return 'ALd.輕手作';
                        return b;
                    });
                }
                
                saveDataToLocalStorage();
                console.log('✅ 品牌名稱已自動更新為完整名稱');
            }
        }

        function setupBrandTabs() {
            document.querySelectorAll('.brand-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentBrand = tab.dataset.brand;
                    document.querySelectorAll('.brand-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentMainCategory = '';  // 清空分類，顯示全部
                    currentSubCategory = '';
                    mainProductCurrentPage = 1;  // 重置到第一頁
                    loadCategories();
                    loadSubCategories();
                    loadProducts();  // 會顯示全部商品
                });
            });
            
            // 更新系統標題
            updateSystemTitle();
            
            // 套用配色主題
            applyTheme(systemConfig.theme);
        }
        
        // 更新系統標題
        function updateSystemTitle() {
            const titleElement = document.getElementById('systemTitle');
            if (titleElement) {
                const systemName = systemConfig.systemName || '';
                titleElement.textContent = systemName || '銷售系統';
            }
        }
        
        // 套用配色主題
        function applyTheme(themeKey) {
            const theme = colorThemes[themeKey];
            if (!theme) return;
            
            const root = document.documentElement;
            root.style.setProperty('--primary-color', theme.primary);
            root.style.setProperty('--secondary-color', theme.secondary);
            root.style.setProperty('--accent-color', theme.accent);
        }
        
        // 打開系統配置彈窗
        function openSystemConfig() {
            document.getElementById('config_systemName').value = systemConfig.systemName || '';
            updateCurrentThemeDisplay();
            document.getElementById('systemConfigModal').classList.add('show');
        }
        
        // 關閉系統配置彈窗
        function closeSystemConfig() {
            document.getElementById('systemConfigModal').classList.remove('show');
        }
        
        // 儲存系統配置
        function saveSystemConfig() {
            systemConfig.systemName = document.getElementById('config_systemName').value.trim();
            
            saveDataToLocalStorage();
            updateSystemTitle();
            showNotification('✅ 系統設定已儲存');
            closeSystemConfig();
        }
        
        // 打開配色選擇彈窗
        function openThemeModal() {
            renderThemeOptions();
            document.getElementById('themeModal').classList.add('show');
        }
        
        // 關閉配色選擇彈窗
        function closeThemeModal() {
            document.getElementById('themeModal').classList.remove('show');
        }
        
        // 渲染配色選項
        function renderThemeOptions() {
            const container = document.getElementById('themeOptions');
            const themeKeys = Object.keys(colorThemes);
            
            container.innerHTML = themeKeys.map(key => {
                const theme = colorThemes[key];
                const isActive = systemConfig.theme === key;
                const radioIcon = isActive ? '●' : '○';
                const activeClass = isActive ? 'font-weight: 600;' : '';
                
                return `
                    <div onclick="selectTheme('${key}')" style="padding: 12px; cursor: pointer; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 12px; ${activeClass}" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                        <span style="font-size: 18px;">${radioIcon}</span>
                        <span style="color: ${theme.primary}; font-size: 20px;">●</span>
                        <span>${theme.name}</span>
                        ${isActive ? '<span style="color: #999; margin-left: auto;">(目前)</span>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        // 選擇配色主題
        function selectTheme(themeKey) {
            systemConfig.theme = themeKey;
            applyTheme(themeKey);
            updateCurrentThemeDisplay();
            closeThemeModal();
            showNotification(`✅ 已切換到「${colorThemes[themeKey].name}」`);
        }
        
        // 更新當前主題顯示
        function updateCurrentThemeDisplay() {
            const theme = colorThemes[systemConfig.theme];
            const display = document.getElementById('currentThemeDisplay');
            if (display && theme) {
                display.innerHTML = `
                    <span style="color: ${theme.primary}; font-size: 20px;">●</span>
                    <span>${theme.name}</span>
                `;
            }
        }
        
        // 新增：動態生成品牌標籤
        function renderBrandTabs() {
            const container = document.querySelector('.brand-tabs');
            if (!container) return;
            
            // 按照 productData 的順序顯示（物件的 key 順序）
            const brands = Object.keys(productData);
            
            container.innerHTML = brands.map((brandKey, index) => {
                const isActive = index === 0 ? 'active' : '';
                return `<button class="brand-tab ${isActive}" data-brand="${brandKey}">${brandKey}</button>`;
            }).join('');
            
            // 重新綁定事件
            setupBrandTabs();
            
            // 設定當前品牌
            if (brands.length > 0) {
                currentBrand = brands[0];
                loadCategories();
                loadSubCategories();
                loadProducts();
            }
        }

        // 載入大分類
        function loadCategories() {
            const container = document.getElementById('categoryButtons');
            
            // 從categories讀取大分類（獨立儲存）
            const mainCategories = categories.mainCategories[currentBrand] || [];
            
            if (mainCategories.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: #999;">此品牌尚無商品分類</div>';
                return;
            }
            
            // 加入分類按鈕
            const html = mainCategories.map((cat) => 
                `<button class="category-btn ${cat === currentMainCategory ? 'active' : ''}" onclick="selectMainCategory('${cat}')">${cat}</button>`
            ).join('');
            
            container.innerHTML = html;
        }

        // 選擇大分類
        function selectMainCategory(category) {
            // Toggle功能：如果點擊的是當前已選擇的分類，則取消選擇
            if (currentMainCategory === category) {
                currentMainCategory = '';
                currentSubCategory = '';
                document.getElementById('subCategoryButtons').style.display = 'none';
                document.querySelectorAll('#categoryButtons .category-btn').forEach(btn => btn.classList.remove('active'));
                mainProductCurrentPage = 1;  // 重置到第一頁
                loadProducts(); // 使用統一的loadProducts
                return;
            }
            
            // 選擇新的大分類
            currentMainCategory = category;
            currentSubCategory = '';
            document.querySelectorAll('#categoryButtons .category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            mainProductCurrentPage = 1;  // 重置到第一頁
            loadSubCategories();
            loadProducts(); // 使用統一的loadProducts
        }
        
        // 新增：渲染品牌所有商品
        function renderAllProductsForBrand() {
            const container = document.querySelector('.products-grid');
            if (!container) return;
            
            const allProducts = [];
            const brand = productData[currentBrand];
            
            Object.keys(brand).forEach(mainCat => {
                Object.keys(brand[mainCat]).forEach(subCat => {
                    brand[mainCat][subCat].forEach(product => {
                        allProducts.push({...product, mainCat, subCat});
                    });
                });
            });
            
            if (allProducts.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">此品牌尚無商品</div>';
                return;
            }
            
            container.innerHTML = allProducts.map(product => {
                const variantInfo = product.variants ? '<div class="product-variants">有多規格</div>' : '';
                const skuInfo = product.sku ? `<div class="product-sku">${product.sku}</div>` : '';
                
                // 計算價格範圍
                let priceDisplay = '';
                if (product.variantPrices && Object.keys(product.variantPrices).length > 0) {
                    const prices = Object.values(product.variantPrices);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice !== maxPrice) {
                        priceDisplay = `NT$ ${minPrice}-${maxPrice}`;
                    } else {
                        priceDisplay = `NT$ ${minPrice}`;
                    }
                } else if (product.price && product.price > 0) {
                    priceDisplay = `NT$ ${product.price}`;
                } else {
                    priceDisplay = '請設定價格';
                }
                
                // 計算庫存總和
                let totalStock = 0;
                if (product.variantStock) {
                    totalStock = Object.values(product.variantStock).reduce((sum, stock) => sum + stock, 0);
                } else if (product.stock !== undefined) {
                    totalStock = product.stock;
                }
                
                // 庫存顯示
                let stockInfo = '';
                if (totalStock !== undefined && totalStock !== null) {
                    let stockColor = '#388e3c';
                    if (totalStock <= 0) {
                        stockColor = '#d32f2f';
                    } else if (totalStock <= 5) {
                        stockColor = '#f57c00';
                    }
                    stockInfo = `<div class="product-stock" style="color: ${stockColor};">庫存: ${totalStock}</div>`;
                }
                
                // 檢查是否售罄
                const isSoldOut = totalStock <= 0;
                const cardClass = isSoldOut ? 'product-card sold-out' : 'product-card';
                const clickEvent = isSoldOut ? 'onclick="alert(\'此商品已售罄\')"' : `onclick='selectProduct(${JSON.stringify(product)})'`;
                const soldOutLabel = isSoldOut ? '<div class="sold-out-label">售罄</div>' : '';
                
                return `
                    <div class="${cardClass}" ${clickEvent}>
                        <div class="product-name">${product.name}</div>
                        ${skuInfo}
                        <div class="product-price">${priceDisplay}</div>
                        ${stockInfo}
                        ${variantInfo}
                        
                        ${soldOutLabel}
                    </div>
                `;
            }).join('');
        }

        // 新增：渲染大分類下所有商品
        function renderMainCategoryProducts() {
            const container = document.querySelector('.products-grid');
            if (!container) return;
            
            const allProducts = [];
            const mainCatData = productData[currentBrand][currentMainCategory];
            
            if (!mainCatData) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">此分類尚無商品</div>';
                return;
            }
            
            Object.keys(mainCatData).forEach(subCat => {
                mainCatData[subCat].forEach(product => {
                    allProducts.push({...product, subCat});
                });
            });
            
            if (allProducts.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">此分類尚無商品</div>';
                return;
            }
            
            container.innerHTML = allProducts.map(product => {
                const variantInfo = product.variants ? '<div class="product-variants">有多規格</div>' : '';
                const skuInfo = product.sku ? `<div class="product-sku">${product.sku}</div>` : '';
                
                let priceDisplay = '';
                if (product.variantPrices && Object.keys(product.variantPrices).length > 0) {
                    const prices = Object.values(product.variantPrices);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    priceDisplay = minPrice !== maxPrice ? `NT$ ${minPrice}-${maxPrice}` : `NT$ ${minPrice}`;
                } else if (product.price && product.price > 0) {
                    priceDisplay = `NT$ ${product.price}`;
                } else {
                    priceDisplay = '請設定價格';
                }
                
                let totalStock = 0;
                if (product.variantStock) {
                    totalStock = Object.values(product.variantStock).reduce((sum, stock) => sum + stock, 0);
                } else if (product.stock !== undefined) {
                    totalStock = product.stock;
                }
                
                let stockInfo = '';
                if (totalStock !== undefined && totalStock !== null) {
                    let stockColor = totalStock <= 0 ? '#d32f2f' : totalStock <= 5 ? '#f57c00' : '#388e3c';
                    stockInfo = `<div class="product-stock" style="color: ${stockColor};">庫存: ${totalStock}</div>`;
                }
                
                const isSoldOut = totalStock <= 0;
                const cardClass = isSoldOut ? 'product-card sold-out' : 'product-card';
                const clickEvent = isSoldOut ? 'onclick="alert(\'此商品已售罄\')"' : `onclick='selectProduct(${JSON.stringify(product)})'`;
                const soldOutLabel = isSoldOut ? '<div class="sold-out-label">售罄</div>' : '';
                
                return `
                    <div class="${cardClass}" ${clickEvent}>
                        <div class="product-name">${product.name}</div>
                        ${skuInfo}
                        <div class="product-price">${priceDisplay}</div>
                        ${stockInfo}
                        ${variantInfo}
                        
                        ${soldOutLabel}
                    </div>
                `;
            }).join('');
        }

        // 載入子分類
        function loadSubCategories() {
            const container = document.getElementById('subCategoryButtons');
            
            // 從categories讀取小分類（獨立儲存）
            const subCategories = (categories.subCategories[currentBrand]?.[currentMainCategory] || []).filter(cat => cat);
            
            if (subCategories.length === 0) {
                // 沒有小分類時，隱藏整個小分類區域
                container.style.display = 'none';
                currentSubCategory = '';
                return;
            }
            
            // 有小分類時，顯示小分類區域
            container.style.display = 'flex';
            container.innerHTML = subCategories.map((cat) => 
                `<button class="category-btn ${cat === currentSubCategory ? 'active' : ''}" onclick="selectSubCategory('${cat}')">${cat}</button>`
            ).join('');
        }

        // 選擇子分類
        function selectSubCategory(category) {
            // Toggle功能：如果點擊的是當前已選擇的分類，則取消選擇
            if (currentSubCategory === category) {
                currentSubCategory = '';
                document.querySelectorAll('#subCategoryButtons .category-btn').forEach(btn => btn.classList.remove('active'));
                mainProductCurrentPage = 1;  // 重置到第一頁
                loadProducts(); // 回到顯示大分類所有商品
                return;
            }
            
            // 選擇新的小分類
            currentSubCategory = category;
            document.querySelectorAll('#subCategoryButtons .category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            mainProductCurrentPage = 1;  // 重置到第一頁
            loadProducts();
        }

        function loadProducts() {
            const container = document.getElementById('productsGrid');
            
            // 使用新結構：依標籤篩選
            let filteredProducts;
            
            if (!currentMainCategory) {
                // 沒選大分類：顯示品牌所有商品
                filteredProducts = products.filter(p => p.brand === currentBrand);
            } else if (!currentSubCategory) {
                // 選了大分類但沒選小分類：顯示有大分類標籤的商品
                filteredProducts = products.filter(p => 
                    p.brand === currentBrand && p.mainCategory === currentMainCategory
                );
            } else {
                // 選了小分類：顯示有小分類標籤的商品
                filteredProducts = products.filter(p => 
                    p.brand === currentBrand && 
                    p.mainCategory === currentMainCategory && 
                    p.subCategory === currentSubCategory
                );
            }
            
            // 計算分頁
            const totalProducts = filteredProducts.length;
            const totalPages = Math.ceil(totalProducts / mainProductItemsPerPage);
            const startIndex = (mainProductCurrentPage - 1) * mainProductItemsPerPage;
            const endIndex = startIndex + mainProductItemsPerPage;
            const paginatedProducts = filteredProducts.slice(startIndex, endIndex);
            
            if (filteredProducts.length === 0) {
                container.innerHTML = '<div style="padding: 20px; color: #999;">此分類尚無商品</div>';
                updateMainProductPagination(0, 0);  // 隱藏分頁
                return;
            }
            
            container.innerHTML = paginatedProducts.map((product, index) => {
                const variantInfo = product.variants ? '<div class="product-variants">有多規格</div>' : '';
                const skuInfo = product.sku ? `<div class="product-sku">${product.sku}</div>` : '';
                
                // 計算價格範圍
                let priceDisplay = '';
                if (product.variantPrices && Object.keys(product.variantPrices).length > 0) {
                    const prices = Object.values(product.variantPrices);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice !== maxPrice) {
                        priceDisplay = `NT$ ${minPrice}-${maxPrice}`;
                    } else {
                        priceDisplay = `NT$ ${minPrice}`;
                    }
                } else if (product.price && product.price > 0) {
                    priceDisplay = `NT$ ${product.price}`;
                } else {
                    priceDisplay = '請設定價格';
                }
                
                // 計算庫存總和
                let totalStock = 0;
                if (product.variantStock) {
                    // 有規格：計算各規格庫存總和
                    totalStock = Object.values(product.variantStock).reduce((sum, stock) => sum + stock, 0);
                } else if (product.stock !== undefined) {
                    // 無規格：使用商品庫存
                    totalStock = product.stock;
                }
                
                // 庫存顯示
                let stockInfo = '';
                if (totalStock !== undefined && totalStock !== null) {
                    let stockColor = '#388e3c';
                    if (totalStock <= 0) {
                        stockColor = '#d32f2f';
                    } else if (totalStock <= 5) {
                        stockColor = '#f57c00';
                    }
                    stockInfo = `<div class="product-stock" style="color: ${stockColor};">庫存: ${totalStock}</div>`;
                }
                
                // 檢查是否售罄
                const isSoldOut = totalStock <= 0;
                const cardClass = isSoldOut ? 'product-card sold-out' : 'product-card';
                const clickEvent = isSoldOut ? 'onclick="alert(\'此商品已售罄\')"' : `onclick='selectProduct(${JSON.stringify(product)})'`;
                const soldOutLabel = isSoldOut ? '<div class="sold-out-label">售罄</div>' : '';
                
                return `
                    <div class="${cardClass}" ${clickEvent}>
                        <div class="product-name">${product.name}</div>
                        ${skuInfo}
                        <div class="product-price">${priceDisplay}</div>
                        <div style="font-size: 12px; color: var(--primary-color); margin-top: 4px;">${product.brandName || product.brand}</div>
                        ${stockInfo}
                        ${variantInfo}
                        ${soldOutLabel}
                    </div>
                `;
            }).join('');
            
            // 更新分頁控制
            updateMainProductPagination(totalPages, totalProducts);
        }
        
        // 更新主畫面商品分頁控制
        function updateMainProductPagination(totalPages, totalRecords) {
            const paginationContainer = document.getElementById('mainProductPaginationContainer');
            const pageNumbers = document.getElementById('mainProductPageNumbers');
            const paginationInfo = document.getElementById('mainProductPaginationInfo');
            const prevBtn = document.getElementById('mainProductPrevPageBtn');
            const nextBtn = document.getElementById('mainProductNextPageBtn');
            const jumpInput = document.getElementById('mainProductPageJumpInput');
            
            // 如果沒有資料，隱藏分頁
            if (totalRecords === 0) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            // 有資料就顯示分頁（即使只有一頁）
            paginationContainer.style.display = 'flex';
            
            // 更新上一頁/下一頁按鈕狀態
            prevBtn.disabled = mainProductCurrentPage === 1;
            nextBtn.disabled = mainProductCurrentPage === totalPages || totalPages === 0;
            
            // 更新跳頁輸入框
            jumpInput.max = totalPages;
            jumpInput.value = '';
            jumpInput.placeholder = totalPages > 0 ? `1-${totalPages}` : '1';
            
            // 顯示分頁資訊
            const startNum = (mainProductCurrentPage - 1) * mainProductItemsPerPage + 1;
            const endNum = Math.min(mainProductCurrentPage * mainProductItemsPerPage, totalRecords);
            paginationInfo.textContent = `(${startNum}-${endNum}/${totalRecords})`;
            
            // 生成頁碼按鈕
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, mainProductCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // 調整起始頁，確保顯示足夠的頁碼
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一頁
            if (startPage > 1) {
                pageNumbersHTML += `<div class="pagination-number" onclick="goToMainProductPage(1)" style="width: 16px; height: 16px; font-size: 9px; min-width: 16px;">1</div>`;
                if (startPage > 2) {
                    pageNumbersHTML += `<span style="padding: 0 2px; color: var(--text-light); font-size: 9px;">...</span>`;
                }
            }
            
            // 中間頁碼
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === mainProductCurrentPage ? 'active' : '';
                pageNumbersHTML += `<div class="pagination-number ${activeClass}" onclick="goToMainProductPage(${i})" style="width: 16px; height: 16px; font-size: 9px; min-width: 16px;">${i}</div>`;
            }
            
            // 最後一頁
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbersHTML += `<span style="padding: 0 2px; color: var(--text-light); font-size: 9px;">...</span>`;
                }
                pageNumbersHTML += `<div class="pagination-number" onclick="goToMainProductPage(${totalPages})" style="width: 16px; height: 16px; font-size: 9px; min-width: 16px;">${totalPages}</div>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHTML;
        }
        
        // 換頁功能（主畫面）
        function changeMainProductPage(direction) {
            if (direction === 'prev' && mainProductCurrentPage > 1) {
                mainProductCurrentPage--;
                loadProducts();
            } else if (direction === 'next') {
                // 計算總頁數
                let filteredProducts;
                if (!currentMainCategory) {
                    filteredProducts = products.filter(p => p.brand === currentBrand);
                } else if (!currentSubCategory) {
                    filteredProducts = products.filter(p => 
                        p.brand === currentBrand && p.mainCategory === currentMainCategory
                    );
                } else {
                    filteredProducts = products.filter(p => 
                        p.brand === currentBrand && 
                        p.mainCategory === currentMainCategory && 
                        p.subCategory === currentSubCategory
                    );
                }
                
                const totalPages = Math.ceil(filteredProducts.length / mainProductItemsPerPage);
                if (mainProductCurrentPage < totalPages) {
                    mainProductCurrentPage++;
                    loadProducts();
                }
            }
        }
        
        // 跳到指定頁面（主畫面）
        function goToMainProductPage(page) {
            mainProductCurrentPage = page;
            loadProducts();
        }
        
        // 快速跳頁（主畫面）
        function jumpToMainProductPage() {
            const jumpInput = document.getElementById('mainProductPageJumpInput');
            const targetPage = parseInt(jumpInput.value);
            
            if (!targetPage || targetPage < 1) {
                alert('請輸入有效的頁碼');
                return;
            }
            
            // 計算總頁數
            let filteredProducts;
            if (!currentMainCategory) {
                filteredProducts = products.filter(p => p.brand === currentBrand);
            } else if (!currentSubCategory) {
                filteredProducts = products.filter(p => 
                    p.brand === currentBrand && p.mainCategory === currentMainCategory
                );
            } else {
                filteredProducts = products.filter(p => 
                    p.brand === currentBrand && 
                    p.mainCategory === currentMainCategory && 
                    p.subCategory === currentSubCategory
                );
            }
            
            const totalPages = Math.ceil(filteredProducts.length / mainProductItemsPerPage);
            
            if (targetPage > totalPages) {
                alert(`頁碼超出範圍，目前共 ${totalPages} 頁`);
                return;
            }
            
            goToMainProductPage(targetPage);
        }

        let currentSelectedProduct = null;
        let selectedVariants = {};
        let currentSelectedAddon = null;  // 當前選擇的加購項目
        let variantGroupCounter = 0;
        let addonVariantGroupCounter = 0;  // 加購項目規格計數器
        let currentEditingProduct = null;
        let currentEditingProductPath = null;
        let currentEditingAddonIndex = null;  // 正在編輯的加購項目索引
        let orderInfoVisible = false;

        // === 訂單資訊功能 ===
        
        // 載入銷售地點選單
        function loadSaleLocationOptions() {
            const select = document.getElementById('saleLocation');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">請選擇</option>' + 
                saleLocations.map(location => 
                    `<option value="${location}">${location}</option>`
                ).join('');
            
            // 恢復之前的選擇
            if (currentValue && saleLocations.includes(currentValue)) {
                select.value = currentValue;
            }
        }
        
        // 打開銷售地點管理
        function openLocationManager() {
            document.getElementById('locationModal').classList.add('show');
            loadLocationList();
        }

        // 關閉銷售地點管理
        function closeLocationManager() {
            document.getElementById('locationModal').classList.remove('show');
        }

        // 載入地點列表
        function loadLocationList() {
            const container = document.getElementById('locationList');
            
            if (saleLocations.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">尚未設定銷售地點</div>';
                return;
            }
            
            container.innerHTML = saleLocations.map((location, index) => `
                <div class="location-item">
                    <div class="location-item-name">${location}</div>
                    <button class="delete-location-btn" onclick="deleteLocation(${index})">刪除</button>
                </div>
            `).join('');
        }

        // 新增銷售地點
        function addNewLocation() {
            const name = document.getElementById('newLocationName').value.trim();
            
            if (!name) {
                alert('請輸入地點名稱');
                return;
            }
            
            if (saleLocations.includes(name)) {
                alert('此地點已存在');
                return;
            }
            
            saleLocations.push(name);
            document.getElementById('newLocationName').value = '';
            showNotification('✅ 地點新增成功！');
            saveDataToLocalStorage();
            loadLocationList();
            loadSaleLocationOptions();
        }

        // 刪除銷售地點
        function deleteLocation(index) {
            if (confirm(`確定要刪除「${saleLocations[index]}」嗎？`)) {
                saleLocations.splice(index, 1);
                showNotification('✅ 地點已刪除');
                saveDataToLocalStorage();
                loadLocationList();
                loadSaleLocationOptions();
            }
        }
        
        // 切換訂單資訊表單顯示
        function toggleOrderInfoForm() {
            const form = document.getElementById('orderInfoForm');
            const icon = document.getElementById('orderInfoToggleIcon');
            
            orderInfoVisible = !orderInfoVisible;
            
            if (orderInfoVisible) {
                form.style.display = 'block';
                icon.textContent = '▲';
                generateOrderNumber();
                updateOrderDate();
            } else {
                form.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        // 生成訂單編號
        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const random = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            
            const orderNumber = `ORD${year}${month}${day}${hours}${minutes}${seconds}${random}`;
            document.getElementById('orderNumber').value = orderNumber;
        }

        // 更新訂單日期
        function updateOrderDate() {
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('orderDate').value = dateStr;
        }

        // 收集訂單資訊
        function getOrderInfo() {
            return {
                orderNumber: document.getElementById('orderNumber').value,
                orderDate: document.getElementById('orderDate').value,
                saleLocation: document.getElementById('saleLocation').value,
                salesPerson: document.getElementById('salesPerson').value,
                memberAccount: document.getElementById('memberAccount').value,
                memberName: document.getElementById('memberName').value,
                memberPhone: document.getElementById('memberPhone').value,
                memberEmail: document.getElementById('memberEmail').value,
                orderNote: document.getElementById('orderNote').value
            };
        }

        // 清空訂單資訊
        function clearOrderInfo() {
            document.getElementById('saleLocation').value = '';
            document.getElementById('salesPerson').value = '';
            document.getElementById('memberAccount').value = '';
            document.getElementById('memberName').value = '';
            document.getElementById('memberPhone').value = '';
            document.getElementById('memberEmail').value = '';
            document.getElementById('orderNote').value = '';
            generateOrderNumber();
            updateOrderDate();
        }

        // === 自動保存功能 ===
        
        // 儲存資料到 localStorage
        function saveDataToLocalStorage() {
            try {
                const dataToSave = {
                    productData,  // 直接儲存 productData（包含所有品牌，即使是空的）
                    products,  // 同時儲存新格式
                    categories,
                    brandFullNames,  // 加入品牌對照表
                    nextProductId,
                    discountButtons,
                    giftRules,
                    saleLocations,
                    addOnItems,
                    systemSettings,
                    systemConfig,  // 加入系統配置
                    salesHistory,
                    lastSaved: new Date().toISOString(),
                    version: 2  // 版本號
                };
                localStorage.setItem('jewelryPosData', JSON.stringify(dataToSave));
                console.log('資料已自動保存', dataToSave);
            } catch (error) {
                console.error('保存資料失敗:', error);
            }
        }

        // 從 localStorage 載入資料
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('jewelryPosData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // 檢查是否為新版資料
                    if (data.version === 2 && data.products) {
                        // 載入新格式
                        products = data.products;
                        productData = data.productData || {};  // 改為空物件
                        categories = data.categories || { brands: [], mainCategories: {}, subCategories: {} };  // brands 改為空陣列
                        nextProductId = data.nextProductId || 1;
                    } else {
                        // 舊格式資料，需要遷移
                        productData = data.productData || {};  // 改為空物件
                        migrateOldDataToNew();
                    }
                    
                    discountButtons = data.discountButtons || [];
                    giftRules = data.giftRules || [];
                    saleLocations = data.saleLocations || [];
                    addOnItems = data.addOnItems || [];
                    systemSettings = data.systemSettings || {
                        shopName: '',
                        taxId: '',
                        phone: '',
                        address: '',
                        website: '',
                        socialLinks: [],
                        showTaxId: true,
                        showPhone: true,
                        showAddress: true,
                        showWebsite: true,
                        showSocial: true,
                        footerText: '感謝您的購買！\n歡迎再次光臨'
                    };
                    systemConfig = data.systemConfig || {
                        systemName: '',
                        theme: 'blue'
                    };
                    salesHistory = data.salesHistory || [];
                    console.log('已載入保存的資料');
                    return true;
                }
            } catch (error) {
                console.error('載入資料失敗:', error);
            }
            return false;
        }
        
        // 遷移舊資料到新格式
        function migrateOldDataToNew() {
            products = [];
            let idCounter = 1;
            
            // 重建categories
            categories = {
                brands: [],  // 改為空陣列
                mainCategories: {},
                subCategories: {}
            };
            
            Object.keys(productData).forEach(brand => {
                // 動態添加品牌
                if (!categories.brands.includes(brand)) {
                    categories.brands.push(brand);
                }
                categories.mainCategories[brand] = Object.keys(productData[brand]);
                categories.subCategories[brand] = {};
                
                Object.keys(productData[brand]).forEach(mainCat => {
                    categories.subCategories[brand][mainCat] = Object.keys(productData[brand][mainCat]);
                    
                    Object.keys(productData[brand][mainCat]).forEach(subCat => {
                        productData[brand][mainCat][subCat].forEach(oldProduct => {
                            products.push({
                                id: idCounter++,
                                brand,
                                mainCategory: mainCat,
                                subCategory: subCat,
                                ...oldProduct
                            });
                        });
                    });
                });
            });
            
            nextProductId = idCounter;
            console.log(`已遷移 ${products.length} 個商品到新格式`);
        }
        
        // 轉換新格式回舊格式（向下相容）
        function convertToLegacyFormat() {
            // 從 productData 初始化，包含所有品牌
            const legacy = {};
            Object.keys(productData).forEach(brand => {
                legacy[brand] = {};
            });
            
            products.forEach(product => {
                const { id, brand, mainCategory, subCategory, ...productData } = product;
                
                if (!legacy[brand]) legacy[brand] = {};
                if (!legacy[brand][mainCategory]) legacy[brand][mainCategory] = {};
                if (!legacy[brand][mainCategory][subCategory]) legacy[brand][mainCategory][subCategory] = [];
                
                legacy[brand][mainCategory][subCategory].push(productData);
            });
            
            return legacy;
        }

        // 清除所有保存的資料
        // 確認清除商品資料
        function confirmClearProducts() {
            if (!confirm('⚠️ 確定要清除所有商品資料嗎？\n此操作無法復原！')) return;
            
            products = [];
            productData = {};  // 改為空物件
            categories = { brands: [], mainCategories: {}, subCategories: {} };  // brands 改為空陣列
            nextProductId = 1;
            saveDataToLocalStorage();
            showNotification('✅ 商品資料已清除');
            init();
            closeClearDataModal();
        }
        
        // 確認清除銷售記錄
        function confirmClearSales() {
            if (!confirm('⚠️ 確定要清除所有銷售記錄嗎？\n此操作無法復原！')) return;
            
            salesHistory = [];
            saveDataToLocalStorage();
            showNotification('✅ 銷售記錄已清除');
            filterByTime(currentTimeFilter);
            closeClearDataModal();
        }
        
        // 確認清除加購項目
        function confirmClearAddons() {
            if (!confirm('⚠️ 確定要清除所有加購項目嗎？\n此操作無法復原！')) return;
            
            addOnItems = [];
            saveDataToLocalStorage();
            showNotification('✅ 加購項目已清除');
            loadAddonList();  // 重新載入加購管理畫面
            loadAddonItems(); // 重新載入銷售頁面的加購選項
            closeClearDataModal();
        }
        
        // 確認清除贈品規則
        function confirmClearGifts() {
            if (!confirm('⚠️ 確定要清除所有贈品規則嗎？\n此操作無法復原！')) return;
            
            giftRules = [];
            saveDataToLocalStorage();
            showNotification('✅ 贈品規則已清除');
            loadGiftList();  // 重新載入贈品管理畫面
            closeClearDataModal();
        }
        
        // 確認清除折扣設定
        function confirmClearDiscounts() {
            if (!confirm('⚠️ 確定要清除所有折扣設定嗎？\n此操作無法復原！')) return;
            
            discountItems = [];
            saveDataToLocalStorage();
            showNotification('✅ 折扣設定已清除');
            loadDiscountList();  // 重新載入折扣管理畫面
            closeClearDataModal();
        }
        
        // 確認重置系統
        function confirmResetSystem() {
            // 第一次確認
            if (!confirm('⚠️⚠️⚠️ 警告 ⚠️⚠️⚠️\n\n即將清除所有資料並重置系統！\n\n包含：\n• 所有品牌\n• 所有商品（含分類）\n• 所有銷售記錄\n• 所有加購項目\n• 所有折扣設定\n• 所有贈品規則\n• 所有基本資訊\n\n🚨 此操作無法復原！\n🚨 建議先匯出資料備份！\n\n確定要繼續嗎？')) {
                return;
            }
            
            // 第二次確認（輸入文字確認）
            const confirmation = prompt('請輸入「重置系統」四個字來確認此操作：');
            if (confirmation !== '重置系統') {
                showNotification('❌ 取消重置');
                return;
            }
            
            // 執行重置：完全刪除 localStorage
            localStorage.removeItem('jewelryPosData');
            showNotification('✅ 系統已重置，頁面將重新載入');
            setTimeout(() => location.reload(), 1500);
        }
        
        function clearLocalStorage() {
            if (confirm('確定要清除所有保存的資料嗎？此操作無法復原！')) {
                localStorage.removeItem('jewelryPosData');
                showNotification('✅ 資料已清除，頁面將重新載入');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // === 分類管理功能 ===
        
        // 打開分類管理
        function openCategoryManager() {
            // 新增：動態生成品牌下拉選單
            const brandSelect = document.getElementById('categoryBrand');
            const brands = Object.keys(productData);
            const brandNames = {
                'ta': 'T&A選品',
                'ald': 'ALd.輕手作'
            };
            
            brandSelect.innerHTML = brands.map(brandKey => {
                const displayName = brandNames[brandKey] || brandKey;
                return `<option value="${brandKey}">${displayName}</option>`;
            }).join('');
            
            // 設定為當前品牌
            brandSelect.value = currentBrand;
            
            document.getElementById('categoryManagerModal').classList.add('show');
            loadCategoryList();
        }

        // 關閉分類管理
        function closeCategoryManager() {
            document.getElementById('categoryManagerModal').classList.remove('show');
        }

        // 載入分類列表
        function loadCategoryList() {
            const brand = document.getElementById('categoryBrand').value;
            
            // 從categories讀取大分類（獨立儲存）
            const mainCategories = categories.mainCategories[brand] || [];
            
            const mainCategoryList = document.getElementById('mainCategoryList');
            
            if (mainCategories.length === 0) {
                mainCategoryList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">尚無大分類</div>';
            } else {
                mainCategoryList.innerHTML = mainCategories.map(cat => `
                    <div class="category-item">
                        <div class="category-item-name">${cat}</div>
                        <button class="delete-discount-btn" onclick="deleteMainCategory('${cat}')">刪除</button>
                    </div>
                `).join('');
            }
            
            // 更新大分類選擇器
            const select = document.getElementById('selectedMainCategoryForSub');
            if (mainCategories.length === 0) {
                select.innerHTML = '<option value="">請先新增大分類</option>';
            } else {
                select.innerHTML = mainCategories.map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');
            }
            
            loadSubCategoryList();
        }

        // 載入小分類列表
        function loadSubCategoryList() {
            const brand = document.getElementById('categoryBrand').value;
            const mainCategory = document.getElementById('selectedMainCategoryForSub').value;
            const subCategoryList = document.getElementById('subCategoryList');
            
            if (!mainCategory) {
                subCategoryList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">請先選擇大分類</div>';
                return;
            }
            
            // 從categories讀取小分類（獨立儲存）
            const subCategories = (categories.subCategories[brand]?.[mainCategory] || []).filter(cat => cat); // 過濾空白
            
            if (subCategories.length === 0) {
                subCategoryList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">尚無小分類</div>';
            } else {
                subCategoryList.innerHTML = subCategories.map(cat => `
                    <div class="category-item">
                        <div class="category-item-name">${cat}</div>
                        <button class="delete-discount-btn" onclick="deleteSubCategory('${mainCategory}', '${cat}')">刪除</button>
                    </div>
                `).join('');
            }
        }

        // 新增大分類
        function addMainCategory() {
            const brand = document.getElementById('categoryBrand').value;
            const name = document.getElementById('newMainCategoryName').value.trim();
            
            if (!name) {
                alert('請輸入大分類名稱');
                return;
            }
            
            // 初始化categories結構
            if (!categories.mainCategories[brand]) {
                categories.mainCategories[brand] = [];
            }
            if (!categories.subCategories[brand]) {
                categories.subCategories[brand] = {};
            }
            
            // 檢查是否已存在
            if (categories.mainCategories[brand].includes(name)) {
                alert('此大分類已存在');
                return;
            }
            
            // 直接加到categories（獨立儲存）
            categories.mainCategories[brand].push(name);
            categories.subCategories[brand][name] = [];
            
            document.getElementById('newMainCategoryName').value = '';
            showNotification('✅ 大分類新增成功！');
            saveDataToLocalStorage();
            loadCategoryList();
            
            // 重新載入主畫面分類
            if (currentBrand === brand) {
                loadCategories();
            }
        }

        // 刪除大分類
        function deleteMainCategory(categoryName) {
            const brand = document.getElementById('categoryBrand').value;
            
            // 計算有多少商品有這個大分類標籤
            const affectedProducts = products.filter(p => 
                p.brand === brand && 
                p.mainCategory === categoryName
            );
            
            let confirmMsg = `確定要刪除大分類「${categoryName}」嗎？`;
            if (affectedProducts.length > 0) {
                confirmMsg += `\n\n有 ${affectedProducts.length} 個商品標記為此分類。`;
                confirmMsg += `\n刪除後這些商品仍會保留，只是移除此大分類標籤。`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // 從categories刪除
            if (categories.mainCategories[brand]) {
                const index = categories.mainCategories[brand].indexOf(categoryName);
                if (index > -1) {
                    categories.mainCategories[brand].splice(index, 1);
                }
            }
            if (categories.subCategories[brand]?.[categoryName]) {
                delete categories.subCategories[brand][categoryName];
            }
            
            // 從所有商品中移除這個大分類標籤
            products.forEach(p => {
                if (p.brand === brand && p.mainCategory === categoryName) {
                    p.mainCategory = '';
                    p.subCategory = '';
                }
            });
            
            showNotification('✅ 大分類已刪除');
            saveDataToLocalStorage();
            loadCategoryList();
            
            // 重新載入主畫面
            if (currentBrand === brand) {
                init();
            }
        }

        // 新增小分類
        function addSubCategory() {
            const brand = document.getElementById('categoryBrand').value;
            const mainCategory = document.getElementById('selectedMainCategoryForSub').value;
            const name = document.getElementById('newSubCategoryName').value.trim();
            
            if (!mainCategory) {
                alert('請先選擇大分類');
                return;
            }
            
            if (!name) {
                alert('請輸入小分類名稱');
                return;
            }
            
            // 初始化categories結構
            if (!categories.subCategories[brand]) {
                categories.subCategories[brand] = {};
            }
            if (!categories.subCategories[brand][mainCategory]) {
                categories.subCategories[brand][mainCategory] = [];
            }
            
            // 檢查是否已存在
            if (categories.subCategories[brand][mainCategory].includes(name)) {
                alert('此小分類已存在');
                return;
            }
            
            // 直接加到categories(獨立儲存)
            categories.subCategories[brand][mainCategory].push(name);
            
            document.getElementById('newSubCategoryName').value = '';
            showNotification('✅ 小分類新增成功！');
            saveDataToLocalStorage();
            
            // 強制重新載入小分類列表
            loadSubCategoryList();
            
            // 重新載入主畫面分類
            if (currentBrand === brand && currentMainCategory === mainCategory) {
                loadSubCategories();
            }
        }

        // 刪除小分類
        function deleteSubCategory(mainCategory, subCategory) {
            const brand = document.getElementById('categoryBrand').value;
            
            // 計算有多少商品有這個標籤
            const affectedProducts = products.filter(p => 
                p.brand === brand && 
                p.mainCategory === mainCategory && 
                p.subCategory === subCategory
            );
            
            let confirmMsg = `確定要刪除小分類「${subCategory}」嗎？`;
            if (affectedProducts.length > 0) {
                confirmMsg += `\n\n有 ${affectedProducts.length} 個商品標記為此分類。`;
                confirmMsg += `\n刪除後這些商品仍會保留，只是移除此分類標籤。`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // 從categories刪除
            if (categories.subCategories[brand]?.[mainCategory]) {
                const index = categories.subCategories[brand][mainCategory].indexOf(subCategory);
                if (index > -1) {
                    categories.subCategories[brand][mainCategory].splice(index, 1);
                }
            }
            
            // 從所有商品中移除這個小分類標籤
            products.forEach(p => {
                if (p.brand === brand && p.mainCategory === mainCategory && p.subCategory === subCategory) {
                    p.subCategory = '';
                }
            });
            
            showNotification('✅ 小分類已刪除，商品已保留');
            saveDataToLocalStorage();
            loadSubCategoryList();
            
            if (currentBrand === brand && currentMainCategory === mainCategory) {
                loadSubCategories();
                loadProducts();
            }
        }

        // === 商品編輯功能 ===
        
        // 打開商品列表管理
        function openProductListManager() {
            // 初始化篩選選項
            initProductFilters();
            
            document.getElementById('productListModal').classList.add('show');
            filterProductList(); // 直接載入全部商品
        }

        // 初始化篩選選項
        function initProductFilters() {
            // 品牌選項 - 從 productData 讀取（包含空品牌），直接顯示原始名稱
            const brandSelect = document.getElementById('filterBrand');
            const brands = Object.keys(productData);
            brandSelect.innerHTML = '<option value="">全部</option>' + 
                brands.map(brand => `<option value="${brand}">${brand}</option>`).join('');
            
            // 大分類選項
            updateMainCategoryFilter();
            
            // 清空搜尋
            document.getElementById('searchProduct').value = '';
        }
        
        // 更新大分類篩選選項
        function updateMainCategoryFilter() {
            const brand = document.getElementById('filterBrand').value;
            const mainCatSelect = document.getElementById('filterMainCategory');
            
            let mainCats = [];
            if (!brand) {
                // 顯示所有大分類
                mainCats = [...new Set(products.map(p => p.mainCategory).filter(cat => cat))];
            } else {
                // 顯示該品牌的大分類
                mainCats = [...new Set(products.filter(p => p.brand === brand).map(p => p.mainCategory).filter(cat => cat))];
            }
            
            mainCatSelect.innerHTML = '<option value="">全部</option>' + 
                mainCats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            updateSubCategoryFilter();
        }
        
        // 更新小分類篩選選項
        function updateSubCategoryFilter() {
            const brand = document.getElementById('filterBrand').value;
            const mainCat = document.getElementById('filterMainCategory').value;
            const subCatSelect = document.getElementById('filterSubCategory');
            
            let subCats = [];
            if (!brand && !mainCat) {
                // 顯示所有小分類
                subCats = [...new Set(products.map(p => p.subCategory).filter(cat => cat))];
            } else if (brand && !mainCat) {
                // 顯示該品牌的所有小分類
                subCats = [...new Set(products.filter(p => p.brand === brand).map(p => p.subCategory).filter(cat => cat))];
            } else if (!brand && mainCat) {
                // 顯示該大分類的所有小分類
                subCats = [...new Set(products.filter(p => p.mainCategory === mainCat).map(p => p.subCategory).filter(cat => cat))];
            } else {
                // 顯示該品牌+大分類的小分類
                subCats = [...new Set(products.filter(p => p.brand === brand && p.mainCategory === mainCat).map(p => p.subCategory).filter(cat => cat))];
            }
            
            subCatSelect.innerHTML = '<option value="">全部</option>' + 
                subCats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        // 篩選商品列表
        function filterProductList() {
            const filterBrand = document.getElementById('filterBrand').value;
            const filterMainCat = document.getElementById('filterMainCategory').value;
            const filterSubCat = document.getElementById('filterSubCategory').value;
            const searchText = document.getElementById('searchProduct').value.toLowerCase();
            
            // 如果品牌改變，更新分類選項
            if (event && event.target.id === 'filterBrand') {
                updateMainCategoryFilter();
                productListCurrentPage = 1;  // 重置到第一頁
            }
            if (event && event.target.id === 'filterMainCategory') {
                updateSubCategoryFilter();
                productListCurrentPage = 1;  // 重置到第一頁
            }
            
            // 如果是搜尋，重置到第一頁
            if (event && event.target.id === 'searchProduct') {
                productListCurrentPage = 1;
            }
            
            // 從 products 篩選商品
            const allProducts = products.filter(product => {
                // 篩選條件
                if (filterBrand && product.brand !== filterBrand) return false;
                if (filterMainCat && product.mainCategory !== filterMainCat) return false;
                if (filterSubCat && product.subCategory !== filterSubCat) return false;
                
                // 搜尋過濾
                if (searchText && 
                    !product.name.toLowerCase().includes(searchText) && 
                    !(product.sku && product.sku.toLowerCase().includes(searchText))) {
                    return false;
                }
                
                return true;
            }).map(product => ({
                ...product,
                brandKey: product.brand,
                brandName: product.brand,
                mainCat: product.mainCategory,
                subCat: product.subCategory
            }));
            
            // 計算分頁
            const totalProducts = allProducts.length;
            const totalPages = Math.ceil(totalProducts / productListItemsPerPage);
            const startIndex = (productListCurrentPage - 1) * productListItemsPerPage;
            const endIndex = startIndex + productListItemsPerPage;
            const paginatedProducts = allProducts.slice(startIndex, endIndex);
            
            // 顯示商品列表
            const container = document.getElementById('productListContent');
            
            if (allProducts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">找不到符合條件的商品</div>';
                updateProductPagination(0, 0);  // 隱藏分頁
                return;
            }
            
            container.innerHTML = paginatedProducts.map(product => {
                // 計算價格顯示
                let priceDisplay = '';
                if (product.variantPrices && Object.keys(product.variantPrices).length > 0) {
                    const prices = Object.values(product.variantPrices);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice !== maxPrice) {
                        priceDisplay = `NT$ ${minPrice}-${maxPrice}`;
                    } else {
                        priceDisplay = `NT$ ${minPrice}`;
                    }
                } else {
                    priceDisplay = `NT$ ${product.price}`;
                }
                
                const variantInfo = product.variants ? 
                    '<div style="font-size: 11px; color: #999; margin-top: 2px;">有多規格</div>' : '';
                    
                // 計算庫存總和
                let totalStock = 0;
                if (product.variantStock) {
                    totalStock = Object.values(product.variantStock).reduce((sum, stock) => sum + stock, 0);
                } else if (product.stock !== undefined) {
                    totalStock = product.stock;
                }
                
                const stockColor = totalStock <= 0 ? '#d32f2f' : totalStock <= 5 ? '#f57c00' : '#388e3c';
                
                return `
                    <div class="product-edit-item">
                        <div class="product-edit-header">
                            <div>
                                <div class="product-edit-name">${product.name}</div>
                                <div class="product-edit-info">
                                    貨號: ${product.sku || '無'}
                                </div>
                                <div style="font-size: 13px; color: #666; margin-top: 2px;">
                                    ${priceDisplay}
                                </div>
                                <div style="font-size: 12px; color: var(--primary-color); margin-top: 4px;">
                                    ${product.brandName}
                                </div>
                                <div style="font-size: 12px; color: ${stockColor}; margin-top: 4px;">
                                    庫存: ${totalStock}
                                </div>
                                ${variantInfo}
                            </div>
                            <div class="product-edit-actions">
                                <button class="edit-product-btn" onclick="editProductById('${product.id}')">編輯</button>
                                <button class="delete-product-btn" onclick="deleteProductById('${product.id}')">刪除</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 更新分頁控制
            updateProductPagination(totalPages, totalProducts);
        }

        // 更新商品列表分頁控制
        function updateProductPagination(totalPages, totalRecords) {
            const paginationContainer = document.getElementById('productPaginationContainer');
            const pageNumbers = document.getElementById('productPageNumbers');
            const paginationInfo = document.getElementById('productPaginationInfo');
            const prevBtn = document.getElementById('productPrevPageBtn');
            const nextBtn = document.getElementById('productNextPageBtn');
            const jumpInput = document.getElementById('productPageJumpInput');
            
            // 如果沒有資料，隱藏分頁
            if (totalRecords === 0) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            // 有資料就顯示分頁（即使只有一頁）
            paginationContainer.style.display = 'flex';
            
            // 更新上一頁/下一頁按鈕狀態
            prevBtn.disabled = productListCurrentPage === 1;
            nextBtn.disabled = productListCurrentPage === totalPages || totalPages === 0;
            
            // 更新跳頁輸入框
            jumpInput.max = totalPages;
            jumpInput.value = '';
            jumpInput.placeholder = totalPages > 0 ? `1-${totalPages}` : '1';
            
            // 顯示分頁資訊
            const startNum = (productListCurrentPage - 1) * productListItemsPerPage + 1;
            const endNum = Math.min(productListCurrentPage * productListItemsPerPage, totalRecords);
            paginationInfo.textContent = `(${startNum}-${endNum}/${totalRecords})`;
            
            // 生成頁碼按鈕
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, productListCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // 調整起始頁，確保顯示足夠的頁碼
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一頁
            if (startPage > 1) {
                pageNumbersHTML += `<div class="pagination-number" onclick="goToProductPage(1)">1</div>`;
                if (startPage > 2) {
                    pageNumbersHTML += `<span style="padding: 0 4px; color: var(--text-light);">...</span>`;
                }
            }
            
            // 中間頁碼
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === productListCurrentPage ? 'active' : '';
                pageNumbersHTML += `<div class="pagination-number ${activeClass}" onclick="goToProductPage(${i})">${i}</div>`;
            }
            
            // 最後一頁
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbersHTML += `<span style="padding: 0 4px; color: var(--text-light);">...</span>`;
                }
                pageNumbersHTML += `<div class="pagination-number" onclick="goToProductPage(${totalPages})">${totalPages}</div>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHTML;
        }
        
        // 換頁功能
        function changeProductPage(direction) {
            if (direction === 'prev' && productListCurrentPage > 1) {
                productListCurrentPage--;
                filterProductList();
            } else if (direction === 'next') {
                // 需要計算總頁數
                const filterBrand = document.getElementById('filterBrand').value;
                const filterMainCat = document.getElementById('filterMainCategory').value;
                const filterSubCat = document.getElementById('filterSubCategory').value;
                const searchText = document.getElementById('searchProduct').value.toLowerCase();
                
                const totalProducts = products.filter(product => {
                    if (filterBrand && product.brand !== filterBrand) return false;
                    if (filterMainCat && product.mainCategory !== filterMainCat) return false;
                    if (filterSubCat && product.subCategory !== filterSubCat) return false;
                    if (searchText && 
                        !product.name.toLowerCase().includes(searchText) && 
                        !(product.sku && product.sku.toLowerCase().includes(searchText))) {
                        return false;
                    }
                    return true;
                }).length;
                
                const totalPages = Math.ceil(totalProducts / productListItemsPerPage);
                if (productListCurrentPage < totalPages) {
                    productListCurrentPage++;
                    filterProductList();
                }
            }
        }
        
        // 跳到指定頁面
        function goToProductPage(page) {
            productListCurrentPage = page;
            filterProductList();
        }
        
        // 快速跳頁
        function jumpToProductPage() {
            const jumpInput = document.getElementById('productPageJumpInput');
            const targetPage = parseInt(jumpInput.value);
            
            if (!targetPage || targetPage < 1) {
                alert('請輸入有效的頁碼');
                return;
            }
            
            // 計算總頁數
            const filterBrand = document.getElementById('filterBrand').value;
            const filterMainCat = document.getElementById('filterMainCategory').value;
            const filterSubCat = document.getElementById('filterSubCategory').value;
            const searchText = document.getElementById('searchProduct').value.toLowerCase();
            
            const totalProducts = products.filter(product => {
                if (filterBrand && product.brand !== filterBrand) return false;
                if (filterMainCat && product.mainCategory !== filterMainCat) return false;
                if (filterSubCat && product.subCategory !== filterSubCat) return false;
                if (searchText && 
                    !product.name.toLowerCase().includes(searchText) && 
                    !(product.sku && product.sku.toLowerCase().includes(searchText))) {
                    return false;
                }
                return true;
            }).length;
            
            const totalPages = Math.ceil(totalProducts / productListItemsPerPage);
            
            if (targetPage > totalPages) {
                alert(`頁碼超出範圍，目前共 ${totalPages} 頁`);
                return;
            }
            
            goToProductPage(targetPage);
        }

        // 關閉商品列表管理
        function closeProductListManager() {
            document.getElementById('productListModal').classList.remove('show');
        }

        // 載入商品列表供編輯（保留舊函數以兼容）
        function loadProductListForEdit() {
            filterProductList();
        }

        // 依路徑編輯商品
        function editProductByPath(brandKey, mainCat, subCat, index) {
            // 使用新結構：根據ID找商品
            const product = products.find(p => 
                p.brand === brandKey && 
                p.mainCategory === mainCat && 
                p.subCategory === subCat
            );
            
            if (!product) return;
            
            currentEditingProduct = product;
            currentEditingProductPath = { brand: brandKey, main: mainCat, sub: subCat, productId: product.id };
            
            // 關閉商品列表
            closeProductListManager();
            
            // 先初始化品牌選單
            const brandSelect = document.getElementById('newProductBrand');
            const brands = Object.keys(productData);
            let options = '<option value="">請選擇品牌</option>';
            options += brands.map(brand => `<option value="${brand}">${brand}</option>`).join('');
            brandSelect.innerHTML = options;
            
            // 打開編輯彈窗
            document.getElementById('addProductModal').classList.add('show');
            document.getElementById('productModalTitle').textContent = '編輯商品';
            
            // 填入現有資料
            document.getElementById('newProductBrand').value = brandKey;
            updateMainCategoryDropdown();
            document.getElementById('newProductMainCategory').value = mainCat;
            updateSubCategoryDropdown();
            document.getElementById('newProductSubCategory').value = subCat;
            document.getElementById('newProductName').value = product.name;
            document.getElementById('newProductSku').value = product.sku || '';
            document.getElementById('newProductPrice').value = product.price;
            document.getElementById('newProductStock').value = product.stock !== undefined ? product.stock : '';
            
            // 載入規格
            const container = document.getElementById('variantGroupsContainer');
            container.innerHTML = '';
            variantGroupCounter = 0;
            
            if (product.variants && Object.keys(product.variants).length > 0) {
                Object.entries(product.variants).forEach(([variantName, options]) => {
                    const groupId = variantGroupCounter++;
                    const groupHtml = `
                        <div class="variant-group-builder" id="variantGroup${groupId}">
                            <div class="variant-group-header">
                                <input type="text" value="${variantName}" id="variantGroupName${groupId}" />
                                <button class="remove-variant-group-btn" onclick="removeVariantGroup(${groupId})">刪除</button>
                            </div>
                            <div class="variant-options-builder" id="variantOptions${groupId}">
                                ${options.map(opt => `
                                    <div class="variant-option-builder">
                                        <input type="text" value="${opt}" />
                                        <button class="remove-option-btn" onclick="this.parentElement.remove()">×</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-option-btn" onclick="addVariantOption(${groupId})">➕ 新增選項</button>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', groupHtml);
                });
                
                // 生成規格貨號區域
                setTimeout(() => {
                    generateVariantCombinations();
                    
                    // 載入已有的規格貨號
                    if (product.variantSkus) {
                        Object.entries(product.variantSkus).forEach(([key, sku]) => {
                            const input = document.querySelector(`.variant-sku-input[data-key="${key}"]`);
                            if (input) {
                                input.value = sku;
                            }
                        });
                    }
                    
                    // 載入已有的規格庫存
                    if (product.variantStock) {
                        Object.entries(product.variantStock).forEach(([key, stock]) => {
                            const input = document.querySelector(`.variant-stock-input[data-key="${key}"]`);
                            if (input) {
                                input.value = stock;
                            }
                        });
                    }
                    
                    // 更新庫存總和顯示
                    updateTotalStockDisplay();
                }, 100);
            } else {
                container.innerHTML = '<div class="empty-variants">暫無規格，點擊上方「➕ 新增規格」按鈕來新增</div>';
                document.getElementById('variantSkuSection').style.display = 'none';
                document.getElementById('simplePriceSection').style.display = 'block';
                document.getElementById('totalPriceDisplay').style.display = 'none';
                document.getElementById('simpleStockSection').style.display = 'block';
                document.getElementById('totalStockDisplay').style.display = 'none';
            }
        }

        // 刪除商品
        function deleteProduct(index) {
            const product = productData[currentBrand][currentMainCategory][currentSubCategory][index];
            
            if (!confirm(`確定要刪除商品「${product.name}」嗎？`)) {
                return;
            }
            
            productData[currentBrand][currentMainCategory][currentSubCategory].splice(index, 1);
            showNotification('✅ 商品已刪除');
            saveDataToLocalStorage(); // 自動保存
            loadProductListForEdit();
            loadProducts();
        }
        
        // 依路徑刪除商品
        function deleteProductByPath(brandKey, mainCat, subCat, index) {
            // 使用新結構：找到對應商品
            const productsInCategory = products.filter(p => 
                p.brand === brandKey && 
                p.mainCategory === mainCat && 
                p.subCategory === subCat
            );
            
            if (!productsInCategory[index]) return;
            
            const product = productsInCategory[index];
            
            if (!confirm(`確定要刪除商品「${product.name}」嗎？`)) {
                return;
            }
            
            // 從products陣列中移除
            const productIndex = products.findIndex(p => p.id === product.id);
            if (productIndex !== -1) {
                products.splice(productIndex, 1);
            }
            
            showNotification('✅ 商品已刪除');
            saveDataToLocalStorage();
            filterProductList(); // 重新載入列表
            
            // 如果當前在銷售頁面有顯示，也要更新
            if (currentBrand === brandKey && currentMainCategory === mainCat && currentSubCategory === subCat) {
                loadProducts();
            }
        }

        // 依 ID 編輯商品
        function editProductById(productId) {
            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            currentEditingProduct = product;
            currentEditingProductPath = { 
                brand: product.brand, 
                main: product.mainCategory, 
                sub: product.subCategory, 
                productId: product.id 
            };
            
            // 關閉商品列表
            closeProductListManager();
            
            // 先初始化品牌選單
            const brandSelect = document.getElementById('newProductBrand');
            const brands = Object.keys(productData);
            let options = '<option value="">請選擇品牌</option>';
            options += brands.map(brand => `<option value="${brand}">${brand}</option>`).join('');
            brandSelect.innerHTML = options;
            
            // 打開編輯彈窗
            document.getElementById('addProductModal').classList.add('show');
            document.getElementById('productModalTitle').textContent = '編輯商品';
            
            // 填入現有資料
            document.getElementById('newProductBrand').value = product.brand;
            updateMainCategoryDropdown();
            document.getElementById('newProductMainCategory').value = product.mainCategory;
            updateSubCategoryDropdown();
            document.getElementById('newProductSubCategory').value = product.subCategory;
            document.getElementById('newProductName').value = product.name;
            document.getElementById('newProductSku').value = product.sku || '';
            document.getElementById('newProductPrice').value = product.price;
            document.getElementById('newProductStock').value = product.stock !== undefined ? product.stock : '';
            
            // 載入規格
            const container = document.getElementById('variantGroupsContainer');
            container.innerHTML = '';
            variantGroupCounter = 0;
            
            if (product.variants && Object.keys(product.variants).length > 0) {
                // 有規格時,先切換顯示狀態
                document.getElementById('simplePriceSection').style.display = 'none';
                document.getElementById('simpleStockSection').style.display = 'none';
                
                Object.entries(product.variants).forEach(([variantName, options]) => {
                    const groupId = variantGroupCounter++;
                    const groupHtml = `
                        <div class="variant-group-builder" id="variantGroup${groupId}">
                            <div class="variant-group-header">
                                <input type="text" value="${variantName}" id="variantGroupName${groupId}" />
                                <button class="remove-variant-group-btn" onclick="removeVariantGroup(${groupId})">刪除</button>
                            </div>
                            <div class="variant-options-builder" id="variantOptions${groupId}">
                                ${options.map(opt => `
                                    <div class="variant-option-builder">
                                        <input type="text" value="${opt}" />
                                        <button class="remove-option-btn" onclick="this.parentElement.remove()">×</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-option-btn" onclick="addVariantOption(${groupId})">➕ 新增選項</button>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', groupHtml);
                });
                
                // 使用 callback 替代 setTimeout
                generateVariantCombinations(() => {
                    // 載入已有的規格貨號
                    if (product.variantSkus) {
                        Object.entries(product.variantSkus).forEach(([key, sku]) => {
                            const input = document.querySelector(`.variant-sku-input[data-key="${key}"]`);
                            if (input) {
                                input.value = sku;
                            }
                        });
                    }
                    
                    // 載入已有的規格價格
                    if (product.variantPrices) {
                        Object.entries(product.variantPrices).forEach(([key, price]) => {
                            const input = document.querySelector(`.variant-price-input[data-key="${key}"]`);
                            if (input) {
                                input.value = price;
                            }
                        });
                    }
                    
                    // 載入已有的規格庫存
                    if (product.variantStock) {
                        Object.entries(product.variantStock).forEach(([key, stock]) => {
                            const input = document.querySelector(`.variant-stock-input[data-key="${key}"]`);
                            if (input) {
                                input.value = stock;
                            }
                        });
                    }
                    
                    // 更新價格區間和庫存總和顯示
                    updateTotalPriceDisplay();
                    updateTotalStockDisplay();
                    
                    // 切換顯示狀態
                    document.getElementById('variantSkuSection').style.display = 'block';
                    document.getElementById('totalPriceDisplay').style.display = 'block';
                    document.getElementById('totalStockDisplay').style.display = 'block';
                });
            } else {
                // 沒有規格時,切換顯示狀態
                container.innerHTML = '<div class="empty-variants">暫無規格，點擊上方「➕ 新增規格」按鈕來新增</div>';
                document.getElementById('variantSkuSection').style.display = 'none';
                document.getElementById('simplePriceSection').style.display = 'block';
                document.getElementById('totalPriceDisplay').style.display = 'none';
                document.getElementById('simpleStockSection').style.display = 'block';
                document.getElementById('totalStockDisplay').style.display = 'none';
            }
        }

        // 依 ID 刪除商品
        function deleteProductById(productId) {
            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            if (!confirm(`確定要刪除商品「${product.name}」嗎？`)) {
                return;
            }
            
            // 從 productData 中移除
            const brand = product.brand;
            const mainCat = product.mainCategory;
            const subCat = product.subCategory;
            
            if (productData[brand] && 
                productData[brand][mainCat] && 
                productData[brand][mainCat][subCat]) {
                
                const index = productData[brand][mainCat][subCat].findIndex(p => p.id == productId);
                if (index !== -1) {
                    productData[brand][mainCat][subCat].splice(index, 1);
                }
            }
            
            // 從 products 陣列中移除
            const productIndex = products.findIndex(p => p.id == productId);
            if (productIndex !== -1) {
                products.splice(productIndex, 1);
            }
            
            showNotification('✅ 商品已刪除');
            saveDataToLocalStorage();
            filterProductList(); // 重新載入列表
        }

        // 打開新增商品彈窗
        function openAddProductModal() {
            // 清空編輯狀態
            currentEditingProduct = null;
            currentEditingProductPath = null;
            
            // 設定標題為新增
            document.getElementById('productModalTitle').textContent = '新增商品';
            
            // 清空所有表單欄位
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductSku').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductStock').value = '';
            
            // 新增：動態生成品牌下拉選單
            const brandSelect = document.getElementById('newProductBrand');
            const brands = Object.keys(productData);
            let options = '<option value="">請選擇品牌</option>';
            options += brands.map(brand => `<option value="${brand}">${brand}</option>`).join('');
            brandSelect.innerHTML = options;
            
            // 清空分類選單
            updateMainCategoryDropdown();
            updateSubCategoryDropdown();
            
            // 清空規格區域
            document.getElementById('variantGroupsContainer').innerHTML = '<div class="empty-variants">暫無規格，點擊上方「➕ 新增規格」按鈕來新增</div>';
            variantGroupCounter = 0;
            
            // 隱藏規格貨號區域，顯示一般價格和庫存欄位
            document.getElementById('variantSkuSection').style.display = 'none';
            document.getElementById('simplePriceSection').style.display = 'block';
            document.getElementById('totalPriceDisplay').style.display = 'none';
            document.getElementById('simpleStockSection').style.display = 'block';
            document.getElementById('totalStockDisplay').style.display = 'none';
            
            // 顯示彈窗
            document.getElementById('addProductModal').classList.add('show');
            
            // 監聽品牌變更
            document.getElementById('newProductBrand').addEventListener('change', function() {
                updateMainCategoryDropdown();
                updateSubCategoryDropdown();
            });
        }

        // 關閉新增商品彈窗
        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('show');
            document.getElementById('productModalTitle').textContent = '新增商品';
            currentEditingProduct = null;
            currentEditingProductPath = null;
            // 清空表單
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductSku').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductStock').value = '';
            document.getElementById('variantGroupsContainer').innerHTML = '';
            // 重置顯示狀態
            document.getElementById('simplePriceSection').style.display = 'block';
            document.getElementById('totalPriceDisplay').style.display = 'none';
            document.getElementById('simpleStockSection').style.display = 'block';
            document.getElementById('totalStockDisplay').style.display = 'none';
        }

        // 更新大分類下拉選單
        function updateMainCategoryDropdown() {
            const brand = document.getElementById('newProductBrand').value;
            const select = document.getElementById('newProductMainCategory');
            
            // 新增：如果品牌未選擇，顯示提示
            if (!brand) {
                select.innerHTML = '<option value="">請先選擇品牌</option>';
                return;
            }
            
            // 從 categories 結構讀取大分類
            const mainCategories = categories.mainCategories[brand] || [];
            
            if (mainCategories.length === 0) {
                select.innerHTML = '<option value="">尚無大分類</option>';
            } else {
                select.innerHTML = '<option value="">請選擇</option>' + mainCategories.map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');
            }
        }

        // 更新子分類下拉選單
        function updateSubCategoryDropdown() {
            const brand = document.getElementById('newProductBrand').value;
            const mainCategory = document.getElementById('newProductMainCategory').value;
            const select = document.getElementById('newProductSubCategory');
            
            // 新增：如果品牌未選擇，顯示提示
            if (!brand) {
                select.innerHTML = '<option value="">請先選擇品牌</option>';
                return;
            }
            
            if (!mainCategory) {
                select.innerHTML = '<option value="">請先選擇大分類</option>';
                return;
            }
            
            // 從 categories 結構讀取小分類
            const subCategories = (categories.subCategories[brand]?.[mainCategory] || []).filter(cat => cat);
            
            if (subCategories.length === 0) {
                select.innerHTML = '<option value="">尚無小分類</option>';
            } else {
                select.innerHTML = '<option value="">請選擇</option>' + subCategories.map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');
            }
        }

        // 新增規格群組
        function addVariantGroup() {
            const container = document.getElementById('variantGroupsContainer');
            
            // 移除空白提示
            if (container.querySelector('.empty-variants')) {
                container.innerHTML = '';
            }
            
            const groupId = variantGroupCounter++;
            const groupHtml = `
                <div class="variant-group-builder" id="variantGroup${groupId}">
                    <div class="variant-group-header">
                        <input type="text" placeholder="規格名稱 (例如：配件顏色)" id="variantGroupName${groupId}" />
                        <button class="remove-variant-group-btn" onclick="removeVariantGroup(${groupId})">刪除</button>
                    </div>
                    <div class="variant-options-builder" id="variantOptions${groupId}">
                        <div class="variant-option-builder">
                            <input type="text" placeholder="選項1" />
                            <button class="remove-option-btn" onclick="this.parentElement.remove()">×</button>
                        </div>
                    </div>
                    <button class="add-option-btn" onclick="addVariantOption(${groupId})">➕ 新增選項</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', groupHtml);
        }

        // 移除規格群組
        function removeVariantGroup(groupId) {
            const group = document.getElementById(`variantGroup${groupId}`);
            if (group) {
                group.remove();
            }
            
            // 如果沒有規格群組了，顯示空白提示
            const container = document.getElementById('variantGroupsContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<div class="empty-variants">暫無規格，點擊上方「➕ 新增規格」按鈕來新增</div>';
            }
        }

        // 新增規格選項
        function addVariantOption(groupId) {
            const container = document.getElementById(`variantOptions${groupId}`);
            const optionHtml = `
                <div class="variant-option-builder">
                    <input type="text" placeholder="選項" />
                    <button class="remove-option-btn" onclick="this.parentElement.remove()">×</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        // 生成規格組合
        function generateVariantCombinations(callback) {
            const variantGroups = document.querySelectorAll('.variant-group-builder');
            
            if (variantGroups.length === 0) {
                document.getElementById('variantSkuSection').style.display = 'none';
                return;
            }
            
            // 收集所有規格及選項
            const variants = [];
            variantGroups.forEach(group => {
                const groupNameInput = group.querySelector('input[id^="variantGroupName"]');
                const groupName = groupNameInput.value.trim();
                
                if (groupName) {
                    const options = [];
                    const optionInputs = group.querySelectorAll('.variant-option-builder input');
                    
                    optionInputs.forEach(input => {
                        const optionValue = input.value.trim();
                        if (optionValue) {
                            options.push(optionValue);
                        }
                    });
                    
                    if (options.length > 0) {
                        variants.push({ name: groupName, options });
                    }
                }
            });
            
            if (variants.length === 0) {
                document.getElementById('variantSkuSection').style.display = 'none';
                return;
            }
            
            // 生成所有組合
            const combinations = generateCombinations(variants);
            
            // 顯示貨號輸入區
            document.getElementById('variantSkuSection').style.display = 'block';
            const container = document.getElementById('variantSkuList');
            
            // 保留已有的貨號、庫存和價格值
            const existingSkus = {};
            const existingStocks = {};
            const existingPrices = {};
            container.querySelectorAll('.variant-sku-input').forEach(input => {
                existingSkus[input.dataset.key] = input.value;
            });
            container.querySelectorAll('.variant-stock-input').forEach(input => {
                existingStocks[input.dataset.key] = input.value;
            });
            container.querySelectorAll('.variant-price-input').forEach(input => {
                existingPrices[input.dataset.key] = input.value;
            });
            
            container.innerHTML = combinations.map(combo => {
                const key = combo.values.join(',');
                const label = combo.labels.join(' + ');
                const existingSkuValue = existingSkus[key] || '';
                const existingStockValue = existingStocks[key] || '';
                const existingPriceValue = existingPrices[key] || '';
                
                return `
                    <div class="variant-sku-item">
                        <div class="variant-sku-label">${label}</div>
                        <input type="text" class="variant-sku-input" data-key="${key}" value="${existingSkuValue}" placeholder="貨號" />
                        <input type="number" class="variant-price-input" data-key="${key}" value="${existingPriceValue}" placeholder="價格" min="0" onchange="updateTotalPriceDisplay()" />
                        <input type="number" class="variant-stock-input" data-key="${key}" value="${existingStockValue}" placeholder="庫存" min="0" onchange="updateTotalStockDisplay()" />
                    </div>
                `;
            }).join('');
            
            // 顯示/隱藏價格和庫存欄位
            document.getElementById('simplePriceSection').style.display = 'none';
            document.getElementById('totalPriceDisplay').style.display = 'block';
            document.getElementById('simpleStockSection').style.display = 'none';
            document.getElementById('totalStockDisplay').style.display = 'block';
            
            // 計算並顯示價格區間和庫存總和
            updateTotalPriceDisplay();
            updateTotalStockDisplay();
            
            // 執行 callback
            if (callback) callback();
        }

        // 遞迴生成組合
        function generateCombinations(variants, current = [], index = 0) {
            if (index === variants.length) {
                return [{ 
                    values: current.map(c => c.value), 
                    labels: current.map(c => `${c.name}: ${c.value}`)
                }];
            }
            
            const results = [];
            const variant = variants[index];
            
            variant.options.forEach(option => {
                const newCurrent = [...current, { name: variant.name, value: option }];
                results.push(...generateCombinations(variants, newCurrent, index + 1));
            });
            
            return results;
        }

        // 更新庫存總和顯示
        function updateTotalStockDisplay() {
            const stockInputs = document.querySelectorAll('.variant-stock-input');
            let totalStock = 0;
            
            stockInputs.forEach(input => {
                const stock = parseInt(input.value) || 0;
                totalStock += stock;
            });
            
            const displayInput = document.getElementById('displayTotalStock');
            if (displayInput) {
                displayInput.value = `${totalStock} 件`;
            }
        }
        
        // 更新價格區間顯示
        function updateTotalPriceDisplay() {
            const priceInputs = document.querySelectorAll('#variantSkuList .variant-price-input');
            const prices = [];
            
            priceInputs.forEach(input => {
                const price = parseInt(input.value);
                if (!isNaN(price) && price >= 0) {
                    prices.push(price);
                }
            });
            
            const displayInput = document.getElementById('displayTotalPrice');
            if (displayInput) {
                if (prices.length === 0) {
                    displayInput.value = '待設定';
                } else {
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice === maxPrice) {
                        displayInput.value = `NT$ ${minPrice}`;
                    } else {
                        displayInput.value = `NT$ ${minPrice}-${maxPrice}`;
                    }
                }
            }
        }

        // 儲存新商品
        function saveNewProduct() {
            const brand = document.getElementById('newProductBrand').value;
            const mainCategory = document.getElementById('newProductMainCategory').value;
            const subCategory = document.getElementById('newProductSubCategory').value;
            const name = document.getElementById('newProductName').value.trim();
            const sku = document.getElementById('newProductSku').value.trim();
            const price = parseInt(document.getElementById('newProductPrice').value);

            // 新增：驗證品牌必填
            if (!brand) {
                alert('請選擇品牌');
                return;
            }

            // 驗證必填欄位
            if (!name) {
                alert('請輸入商品名稱');
                return;
            }
            
            // 驗證：如果填了小分類，必須先填大分類
            if (subCategory && !mainCategory) {
                alert('請先選擇大分類，才能選擇小分類');
                return;
            }
            
            // 檢查是否有設定規格價格
            const hasVariantPrices = document.querySelectorAll('.variant-price-input').length > 0 &&
                                     Array.from(document.querySelectorAll('.variant-price-input')).some(input => input.value && parseInt(input.value) > 0);
            
            // 如果沒有規格價格，則基礎價格必填
            if (!hasVariantPrices && (!price || price <= 0)) {
                alert('請輸入有效的價格（或設定規格價格）');
                return;
            }

            // 建立商品物件（使用新結構）
            const product = {
                brand,
                mainCategory: mainCategory || '',  // 允許空字串
                subCategory: subCategory || '',    // 允許空字串
                name,
                price,
                sku: sku || ''
            };
            
            // 收集無規格商品的庫存
            const simpleStock = parseInt(document.getElementById('newProductStock').value);
            if (!isNaN(simpleStock) && simpleStock >= 0) {
                product.stock = simpleStock;
            }

            // 收集規格資料
            const variantGroups = document.querySelectorAll('.variant-group-builder');
            if (variantGroups.length > 0) {
                const variants = {};
                let hasValidVariant = false;

                variantGroups.forEach(group => {
                    const groupNameInput = group.querySelector('input[id^="variantGroupName"]');
                    const groupName = groupNameInput.value.trim();
                    
                    if (groupName) {
                        const options = [];
                        const optionInputs = group.querySelectorAll('.variant-option-builder input');
                        
                        optionInputs.forEach(input => {
                            const optionValue = input.value.trim();
                            if (optionValue) {
                                options.push(optionValue);
                            }
                        });

                        if (options.length > 0) {
                            variants[groupName] = options;
                            hasValidVariant = true;
                        }
                    }
                });

                if (hasValidVariant) {
                    product.variants = variants;
                    
                    // 收集規格貨號
                    const variantSkus = {};
                    document.querySelectorAll('.variant-sku-input').forEach(input => {
                        const key = input.dataset.key;
                        const sku = input.value.trim();
                        if (sku) {
                            variantSkus[key] = sku;
                        }
                    });
                    
                    if (Object.keys(variantSkus).length > 0) {
                        product.variantSkus = variantSkus;
                    }
                    
                    // 收集規格庫存
                    const variantStock = {};
                    document.querySelectorAll('.variant-stock-input').forEach(input => {
                        const key = input.dataset.key;
                        const stock = parseInt(input.value);
                        if (!isNaN(stock) && stock >= 0) {
                            variantStock[key] = stock;
                        }
                    });
                    
                    if (Object.keys(variantStock).length > 0) {
                        product.variantStock = variantStock;
                    }
                    
                    // 收集規格價格
                    const variantPrices = {};
                    document.querySelectorAll('.variant-price-input').forEach(input => {
                        const key = input.dataset.key;
                        const price = parseInt(input.value);
                        if (!isNaN(price) && price >= 0) {
                            variantPrices[key] = price;
                        }
                    });
                    
                    if (Object.keys(variantPrices).length > 0) {
                        product.variantPrices = variantPrices;
                    }
                }
            }

            // 判斷是編輯還是新增
            if (currentEditingProductPath) {
                // 編輯模式：更新商品的id和資料
                product.id = currentEditingProductPath.productId || currentEditingProduct.id;
                
                // 更新 products 陣列
                const index = products.findIndex(p => p.id === product.id);
                if (index !== -1) {
                    products[index] = product;
                }
                
                // 更新 productData
                if (productData[brand] && 
                    productData[brand][mainCategory] && 
                    productData[brand][mainCategory][subCategory]) {
                    
                    const pdIndex = productData[brand][mainCategory][subCategory].findIndex(p => p.id === product.id);
                    if (pdIndex !== -1) {
                        productData[brand][mainCategory][subCategory][pdIndex] = product;
                    }
                }
                
                showNotification('✅ 商品更新成功！');
                
                currentEditingProduct = null;
                currentEditingProductPath = null;
            } else {
                // 新增模式：給予新ID並加入陣列
                product.id = nextProductId++;
                products.push(product);
                
                // 也加入 productData
                if (!productData[brand]) productData[brand] = {};
                if (!productData[brand][mainCategory]) productData[brand][mainCategory] = {};
                if (!productData[brand][mainCategory][subCategory]) {
                    productData[brand][mainCategory][subCategory] = [];
                }
                productData[brand][mainCategory][subCategory].push(product);
                
                showNotification('✅ 商品新增成功！');
            }

            closeAddProductModal();

            // 自動保存資料
            saveDataToLocalStorage();

            // 重新載入商品列表和分類
            loadCategories();
            loadSubCategories();
            loadProducts();
        }

        // 選擇商品（檢查是否有規格）
        function selectProduct(product) {
            if (product.variants && Object.keys(product.variants).length > 0) {
                // 有規格，打開規格選擇彈窗
                openVariantModal(product);
            } else {
                // 無規格，直接加入訂單
                addToOrder(product);
            }
        }

        // 打開規格選擇彈窗
        function openVariantModal(product) {
            currentSelectedProduct = product;
            selectedVariants = {};
            
            document.getElementById('variantProductName').textContent = product.name;
            document.getElementById('variantProductSku').textContent = product.sku || (product.variantSkus ? '請選擇規格' : '');
            document.getElementById('variantProductPrice').textContent = `NT$ ${product.price}`;
            
            const container = document.getElementById('variantGroups');
            container.innerHTML = Object.entries(product.variants).map(([variantName, options]) => `
                <div class="variant-group">
                    <div class="variant-label">${variantName}</div>
                    <div class="variant-options">
                        ${options.map(option => `
                            <div class="variant-option" onclick="selectVariant('${variantName}', '${option}')">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('variantModal').classList.add('show');
        }

        // 關閉規格選擇彈窗
        function closeVariantModal() {
            document.getElementById('variantModal').classList.remove('show');
            currentSelectedProduct = null;
            currentSelectedAddon = null;
            selectedVariants = {};
        }

        // 選擇規格選項
        function selectVariant(variantName, option) {
            selectedVariants[variantName] = option;
            
            // 更新選中狀態
            const variantGroups = document.querySelectorAll('.variant-group');
            variantGroups.forEach(group => {
                const label = group.querySelector('.variant-label').textContent;
                if (label === variantName) {
                    const options = group.querySelectorAll('.variant-option');
                    options.forEach(opt => {
                        if (opt.textContent.trim() === option) {
                            opt.classList.add('selected');
                        } else {
                            opt.classList.remove('selected');
                        }
                    });
                }
            });
            
            // 更新顯示的貨號
            updateVariantSku();
        }

        // 更新規格貨號顯示
        function updateVariantSku() {
            const confirmBtn = document.getElementById('variantConfirmBtn');
            
            if (!currentSelectedProduct.variantSkus) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = '加到訂單明細';
                confirmBtn.style.background = '';
                confirmBtn.style.cursor = '';
                return;
            }
            
            const requiredVariants = Object.keys(currentSelectedProduct.variants || {});
            const selectedVariantKeys = Object.keys(selectedVariants);
            
            if (requiredVariants.length === selectedVariantKeys.length) {
                // 所有規格都已選擇，生成組合key
                const variantKey = requiredVariants.map(key => selectedVariants[key]).join(',');
                const sku = currentSelectedProduct.variantSkus[variantKey];
                const stock = currentSelectedProduct.variantStock ? currentSelectedProduct.variantStock[variantKey] : null;
                const price = currentSelectedProduct.variantPrices ? currentSelectedProduct.variantPrices[variantKey] : null;
                
                if (sku) {
                    document.getElementById('variantProductSku').textContent = `貨號: ${sku}`;
                } else {
                    document.getElementById('variantProductSku').textContent = '此規格組合無貨號';
                }
                
                // 顯示價格
                const priceElement = document.getElementById('variantProductPrice');
                if (price !== null && price !== undefined) {
                    priceElement.textContent = `NT$ ${price}`;
                } else {
                    priceElement.textContent = `NT$ ${currentSelectedProduct.price}`;
                }
                
                // 顯示庫存並控制按鈕
                const stockElement = document.getElementById('variantProductStock');
                if (stock !== null && stock !== undefined) {
                    if (stock <= 0) {
                        stockElement.textContent = '庫存: 已售完';
                        stockElement.style.color = '#d32f2f';
                        // 按鈕變灰色不可點擊
                        confirmBtn.disabled = true;
                        confirmBtn.textContent = '無法加入';
                        confirmBtn.style.background = '#ccc';
                        confirmBtn.style.cursor = 'not-allowed';
                    } else if (stock <= 3) {
                        stockElement.textContent = `庫存: ${stock} 件（即將售完）`;
                        stockElement.style.color = '#f57c00';
                        // 按鈕可點擊
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = '加到訂單明細';
                        confirmBtn.style.background = '';
                        confirmBtn.style.cursor = '';
                    } else {
                        stockElement.textContent = `庫存: ${stock} 件`;
                        stockElement.style.color = '#388e3c';
                        // 按鈕可點擊
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = '加到訂單明細';
                        confirmBtn.style.background = '';
                        confirmBtn.style.cursor = '';
                    }
                } else {
                    stockElement.textContent = '';
                    // 沒有庫存資訊，預設可加入
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '加到訂單明細';
                    confirmBtn.style.background = '';
                    confirmBtn.style.cursor = '';
                }
            } else {
                document.getElementById('variantProductSku').textContent = '請選擇所有規格';
                document.getElementById('variantProductStock').textContent = '';
                // 未選完規格，按鈕可點擊但會提示
                confirmBtn.disabled = false;
                confirmBtn.textContent = '加到訂單明細';
                confirmBtn.style.background = '';
                confirmBtn.style.cursor = '';
            }
        }

        // 確認加入訂單
        function confirmAddToOrder() {
            // 判斷是商品還是加購項目
            const isAddon = currentSelectedAddon !== null;
            const item = isAddon ? currentSelectedAddon : currentSelectedProduct;
            
            if (!item) return;
            
            // 檢查是否所有規格都已選擇
            const requiredVariants = Object.keys(item.variants || {});
            const selectedVariantKeys = Object.keys(selectedVariants);
            
            if (requiredVariants.length > selectedVariantKeys.length) {
                alert('請選擇所有規格選項');
                return;
            }
            
            // 檢查該規格組合的庫存
            if (item.variantStock) {
                const variantKey = requiredVariants.map(key => selectedVariants[key]).join(',');
                const stock = item.variantStock[variantKey] || 0;
                
                if (stock <= 0) {
                    alert('此規格已售罄，無法加入訂單');
                    return;
                }
            }
            
            // 取得該規格組合的貨號和價格
            let variantSku = '';
            let variantPrice = item.price;
            if (item.variantSkus || item.variantPrices) {
                const variantKey = requiredVariants.map(key => selectedVariants[key]).join(',');
                variantSku = item.variantSkus ? (item.variantSkus[variantKey] || '') : '';
                
                // 使用規格價格（如果有設定）
                if (item.variantPrices && item.variantPrices[variantKey]) {
                    variantPrice = item.variantPrices[variantKey];
                }
            }
            
            if (isAddon) {
                // 加購項目：加入訂單
                const addonWithVariants = {
                    ...item,
                    selectedVariants: {...selectedVariants},
                    displayName: item.name + ' (' + Object.values(selectedVariants).join(', ') + ')',
                    sku: variantSku || item.sku,
                    price: variantPrice
                };
                addAddonToOrder(item.id, addonWithVariants);
            } else {
                // 商品：加入訂單
                const productWithVariants = {
                    ...item,
                    selectedVariants: {...selectedVariants},
                    displayName: item.name + ' (' + Object.values(selectedVariants).join(', ') + ')',
                    sku: variantSku || item.sku,
                    price: variantPrice
                };
                addToOrder(productWithVariants);
            }
            
            closeVariantModal();
        }

        function addToOrder(product) {
            // 如果有規格，需要比對規格是否相同
            let existingItem = null;
            if (product.selectedVariants) {
                existingItem = orderItems.find(item => 
                    item.name === product.name && 
                    !item.isDiscount &&
                    JSON.stringify(item.selectedVariants) === JSON.stringify(product.selectedVariants)
                );
            } else {
                existingItem = orderItems.find(item => 
                    item.name === product.name && 
                    !item.isDiscount &&
                    !item.selectedVariants
                );
            }
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                orderItems.push({ ...product, quantity: 1, isDiscount: false });
            }
            updateOrder();
        }

        function updateOrder() {
            const container = document.getElementById('orderList');
            
            // 分類：商品在前，加購項目，贈品，最後折扣
            const products = orderItems.filter(item => !item.isAddon && !item.isGift);
            const addons = orderItems.filter(item => item.isAddon);
            const gifts = orderItems.filter(item => item.isGift);
            const sortedItems = [...products, ...addons, ...gifts];
            const allItems = [...sortedItems, ...discounts];
            
            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-order">
                        <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;">🛍️</div>
                        <div>尚無商品，請選擇商品加入訂單</div>
                    </div>
                `;
            } else {
                container.innerHTML = allItems.map((item, index) => {
                    if (item.isDiscount) {
                        // 動態查找最新的折扣名稱
                        let displayName = item.name; // 使用備份名稱作為預設值
                        if (item.discountId) {
                            const latestDiscount = discountButtons.find(d => d.id === item.discountId);
                            if (latestDiscount) {
                                displayName = latestDiscount.name; // 使用最新名稱
                            }
                        }
                        
                        return `
                            <div class="order-item discount-item">
                                <div class="order-item-info">
                                    <div class="order-item-name">🎁 ${displayName}</div>
                                    <div class="order-item-price">${item.description}</div>
                                </div>
                                <div class="order-item-controls">
                                    <button class="delete-btn" onclick="removeDiscount(${index})">×</button>
                                </div>
                            </div>
                        `;
                    } else {
                        // 找到該項目在原始 orderItems 中的索引
                        const originalIndex = orderItems.indexOf(item);
                        
                        const displayName = item.displayName || item.name;
                        
                        // 贈品標記
                        if (item.isGift) {
                            const skuInfo = item.sku ? `<div style="font-size: 11px; color: #999;">貨號: ${item.sku}</div>` : '';
                            
                            return `
                                <div class="order-item" style="background: #f0f9ff;">
                                    <div class="order-item-info">
                                        <div class="order-item-name">
                                            <span style="color: #4CAF50; font-weight: 600;">【贈品】</span>${item.name}
                                        </div>
                                        ${skuInfo}
                                        <div style="font-size: 11px; color: #999;">${item.giftRuleName || ''}</div>
                                        <div class="order-item-price">NT$ 0</div>
                                    </div>
                                    <div class="order-item-controls">
                                        <span class="qty-display">x${item.quantity}</span>
                                        <button class="delete-btn" onclick="removeItem(${originalIndex})">×</button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        const addonLabel = item.isAddon ? '<span style="color: var(--highlight-color); font-weight: 600;">【加購】</span>' : '';
                        
                        // 處理規格顯示
                        let variantInfo = '';
                        if (item.selectedVariants && Object.keys(item.selectedVariants).length > 0) {
                            const variantText = Object.entries(item.selectedVariants)
                                .map(([key, value]) => `${key}: ${value}`)
                                .join(' | ');
                            variantInfo = `<div style="font-size: 11px; color: #999;">${variantText}</div>`;
                        }
                        
                        const skuInfo = item.sku ? `<div style="font-size: 11px; color: #999;">${item.sku}</div>` : '';
                        const brandInfo = (item.brandName || item.brand) ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">${item.brandName || item.brand}</div>` : '';
                        
                        return `
                            <div class="order-item">
                                <div class="order-item-info">
                                    <div class="order-item-name">${addonLabel}${item.name}</div>
                                    ${variantInfo}
                                    ${skuInfo}
                                    ${brandInfo}
                                    <div class="order-item-price">NT$ ${item.price}</div>
                                </div>
                                <div class="order-item-controls">
                                    <div class="qty-control">
                                        <button class="qty-btn" onclick="updateQuantity(${originalIndex}, -1)">−</button>
                                        <span class="qty-display">${item.quantity}</span>
                                        <button class="qty-btn" onclick="updateQuantity(${originalIndex}, 1)">+</button>
                                    </div>
                                    <button class="delete-btn" onclick="removeItem(${originalIndex})">×</button>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
            
            updateTotal();
            
            // 更新贈品按鈕狀態
            loadGiftButtons();
            
            // 更新按鈕狀態
            const checkoutBtn = document.getElementById('checkoutBtn');
            const printPreviewBtn = document.getElementById('printPreviewBtn');
            if (orderItems.length === 0) {
                checkoutBtn.disabled = true;
                printPreviewBtn.disabled = true;
            } else {
                checkoutBtn.disabled = false;
                printPreviewBtn.disabled = false;
            }
        }

        function updateQuantity(index, change) {
            orderItems[index].quantity += change;
            if (orderItems[index].quantity <= 0) {
                orderItems.splice(index, 1);
            }
            checkAndRemoveInvalidDiscounts();
            checkAndRemoveInvalidGifts();
            updateOrder();
        }

        function removeItem(index) {
            orderItems.splice(index, 1);
            checkAndRemoveInvalidDiscounts();
            checkAndRemoveInvalidGifts();
            updateOrder();
        }

        // 檢查並移除不符合條件的折扣
        function checkAndRemoveInvalidDiscounts() {
            // 計算當前一般商品數量(排除加購品和贈品)
            const totalItems = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + item.quantity, 0);
            
            // 計算一般商品金額(排除加購品和贈品)
            const productSubtotal = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // 計算訂單總額(排除贈品)
            const totalSubtotal = orderItems
                .filter(item => !item.isGift)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // 檢查每個折扣是否還符合條件
            discounts = discounts.filter(discount => {
                if (discount.type === 'buyNFixed') {
                    // 任選N件固定金額折扣:檢查商品數量是否足夠
                    if (totalItems < discount.count) {
                        return false;
                    }
                } else if (discount.type === 'buyNPercent') {
                    // 任選N件百分比折扣:檢查商品數量是否足夠
                    if (totalItems < discount.count) {
                        return false;
                    }
                } else if (discount.type === 'minAmountPercent') {
                    // 滿額百分比折扣:檢查商品金額是否達到最低門檻
                    if (productSubtotal < discount.minAmount) {
                        return false;
                    }
                } else if (discount.type === 'minAmountFixed') {
                    // 滿額固定金額折扣:檢查商品金額是否達到最低門檻
                    if (productSubtotal < discount.minAmount) {
                        return false;
                    }
                    // 同時檢查折扣金額是否超過訂單總額
                    if (discount.amount >= totalSubtotal) {
                        return false;
                    }
                } else if (discount.type === 'fixed') {
                    // 固定金額折扣:檢查折扣金額是否超過訂單總額
                    if (discount.amount >= totalSubtotal) {
                        return false;
                    }
                }
                return true; // 保留此折扣
            });
        }

        // 檢查並移除不符合條件的贈品
        function checkAndRemoveInvalidGifts() {
            // 計算一般商品金額(排除加購品和贈品)
            const productSubtotal = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // 計算一般商品件數(排除加購品和贈品)
            const productCount = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + item.quantity, 0);
            
            // 檢查每個贈品是否還符合條件
            orderItems = orderItems.filter(item => {
                if (!item.isGift) return true; // 保留非贈品
                
                const gift = giftRules.find(g => g.id === item.giftId);
                if (!gift) return false; // 贈品規則已刪除,移除贈品
                
                // 檢查條件
                if (gift.conditionType === 'minAmount') {
                    return productSubtotal >= gift.conditionValue;
                } else if (gift.conditionType === 'minItems') {
                    return productCount >= gift.conditionValue;
                }
                
                return true;
            });
        }

        // 百分比折扣
        function applyPercentDiscount(discountId, name, rate) {
            // 檢查是否已有折扣(互斥)
            if (discounts.length > 0) {
                alert('已有折扣套用,一次只能使用一個折扣!');
                return;
            }
            
            const existing = discounts.find(d => d.discountId === discountId);
            if (existing) {
                alert('此折扣已套用！');
                return;
            }
            discounts.push({ 
                discountId,
                name, 
                rate, 
                type: 'percent',
                description: `全單${(rate * 100).toFixed(0)}折`,
                isDiscount: true 
            });
            showNotification(`✅ 已套用折扣：${name}`);
            updateOrder();
        }

        // 固定金額折扣
        function applyFixedDiscount(discountId, name, amount) {
            // 檢查是否已有折扣(互斥)
            if (discounts.length > 0) {
                alert('已有折扣套用,一次只能使用一個折扣!');
                return;
            }
            
            const existing = discounts.find(d => d.discountId === discountId);
            if (existing) {
                alert('此折扣已套用！');
                return;
            }
            discounts.push({ 
                discountId,
                name, 
                amount, 
                type: 'fixed',
                description: `折扣 NT$ ${amount}`,
                isDiscount: true 
            });
            showNotification(`✅ 已套用折扣：${name}`);
            updateOrder();
        }

        // 任選N件折扣
        function applyBuyNDiscount(discountId, name, count, discount) {
            // 檢查是否已有折扣(互斥)
            if (discounts.length > 0) {
                alert('已有折扣套用,一次只能使用一個折扣!');
                return;
            }
            
            // 只計算一般商品數量,排除加購項目
            const totalItems = orderItems
                .filter(item => !item.isAddon)
                .reduce((sum, item) => sum + item.quantity, 0);
            
            if (totalItems < count) {
                alert(`需購買至少 ${count} 件商品才能使用此優惠！`);
                return;
            }

            const existing = discounts.find(d => d.discountId === discountId);
            if (existing) {
                alert('此折扣已套用！');
                return;
            }

            // 計算可套用幾次
            const times = Math.floor(totalItems / count);
            const actualDiscount = times * discount;

            discounts.push({ 
                discountId,
                name,
                amount: actualDiscount,
                type: 'buyN',
                count,
                discount,
                description: `買${count}件折${discount}元 (已套用${times}次)`,
                isDiscount: true 
            });
            showNotification(`✅ 已套用折扣：${name}`);
            updateOrder();
        }

        // 滿額百分比折扣
        function applyMinAmountPercentDiscount(discountId, name, minAmount, rate) {
            // 檢查是否已有折扣(互斥)
            if (discounts.length > 0) {
                alert('已有折扣套用,一次只能使用一個折扣!');
                return;
            }
            
            // 只計算一般商品金額,排除加購品和贈品
            const subtotal = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (subtotal < minAmount) {
                alert(`需消費滿 NT$ ${minAmount} 才能使用此折扣！`);
                return;
            }

            const existing = discounts.find(d => d.discountId === discountId);
            if (existing) {
                alert('此折扣已套用！');
                return;
            }
            
            discounts.push({ 
                discountId,
                name,
                rate,
                minAmount,
                type: 'minAmountPercent',
                description: `滿${minAmount}元享${(rate * 100).toFixed(0)}折`,
                isDiscount: true 
            });
            showNotification(`✅ 已套用折扣：${name}`);
            updateOrder();
        }

        // 滿額固定金額折扣
        function applyMinAmountFixedDiscount(discountId, name, minAmount, amount) {
            // 檢查是否已有折扣(互斥)
            if (discounts.length > 0) {
                alert('已有折扣套用,一次只能使用一個折扣!');
                return;
            }
            
            // 只計算一般商品金額,排除加購品和贈品
            const subtotal = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (subtotal < minAmount) {
                alert(`需消費滿 NT$ ${minAmount} 才能使用此折扣！`);
                return;
            }

            const existing = discounts.find(d => d.discountId === discountId);
            if (existing) {
                alert('此折扣已套用！');
                return;
            }
            
            discounts.push({ 
                discountId,
                name,
                amount,
                minAmount,
                type: 'minAmountFixed',
                description: `滿${minAmount}元折${amount}元`,
                isDiscount: true 
            });
            showNotification(`✅ 已套用折扣：${name}`);
            updateOrder();
        }

        // 任選N件百分比折扣
        function applyBuyNPercentDiscount(discountId, name, count, rate) {
            // 檢查是否已有折扣(互斥)
            if (discounts.length > 0) {
                alert('已有折扣套用,一次只能使用一個折扣!');
                return;
            }
            
            const totalItems = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + item.quantity, 0);
            
            if (totalItems < count) {
                alert(`需購買至少 ${count} 件商品才能使用此優惠！`);
                return;
            }

            const existing = discounts.find(d => d.discountId === discountId);
            if (existing) {
                alert('此折扣已套用！');
                return;
            }
            
            discounts.push({ 
                discountId,
                name,
                rate,
                count,
                type: 'buyNPercent',
                description: `任選${count}件享${(rate * 100).toFixed(0)}折`,
                isDiscount: true 
            });
            showNotification(`✅ 已套用折扣：${name}`);
            updateOrder();
        }

        // 任選N件固定金額折扣
        function applyBuyNFixedDiscount(discountId, name, count, discount) {
            // 檢查是否已有折扣(互斥)
            if (discounts.length > 0) {
                alert('已有折扣套用,一次只能使用一個折扣!');
                return;
            }
            
            const totalItems = orderItems
                .filter(item => !item.isAddon && !item.isGift)
                .reduce((sum, item) => sum + item.quantity, 0);
            
            if (totalItems < count) {
                alert(`需購買至少 ${count} 件商品才能使用此優惠！`);
                return;
            }

            const existing = discounts.find(d => d.discountId === discountId);
            if (existing) {
                alert('此折扣已套用！');
                return;
            }

            const times = Math.floor(totalItems / count);
            const actualDiscount = times * discount;

            discounts.push({ 
                discountId,
                name,
                amount: actualDiscount,
                type: 'buyNFixed',
                count,
                discount,
                description: `任選${count}件折${discount}元 (已套用${times}次)`,
                isDiscount: true 
            });
            showNotification(`✅ 已套用折扣：${name}`);
            updateOrder();
        }

        function removeDiscount(index) {
            const discountIndex = index - orderItems.length;
            discounts.splice(discountIndex, 1);
            updateOrder();
        }

        function updateTotal() {
            // 計算小計(排除贈品,因為贈品價格為0)
            let subtotal = orderItems
                .filter(item => !item.isGift)
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountTotal = 0;
            
            discounts.forEach(discount => {
                if (discount.type === 'percent') {
                    discountTotal += subtotal * (1 - discount.rate);
                } else {
                    discountTotal += discount.amount;
                }
            });
            
            const total = Math.max(0, subtotal - discountTotal);
            
            document.getElementById('subtotal').textContent = `NT$ ${subtotal}`;
            document.getElementById('discount').textContent = `- NT$ ${Math.round(discountTotal)}`;
            document.getElementById('total').textContent = `NT$ ${Math.round(total)}`;
            
            document.getElementById('checkoutBtn').disabled = orderItems.length === 0;
        }

        function clearOrder() {
            if (orderItems.length === 0 && discounts.length === 0) return;
            if (confirm('確定要清空所有訂單內容嗎？')) {
                orderItems = [];
                discounts = [];
                updateOrder();
            }
        }

        function checkout() {
            if (orderItems.length === 0) return;
            
            // 檢查是否已選擇銷售地點
            const orderInfo = getOrderInfo();
            if (!orderInfo.saleLocation) {
                alert('❗ 請先選擇銷售地點');
                // 自動展開訂單資訊區
                if (!orderInfoVisible) {
                    toggleOrderInfoForm();
                }
                document.getElementById('saleLocation').focus();
                return;
            }
            
            const totalElement = document.getElementById('total');
            if (!totalElement) return;
            
            const subtotal = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalValue = parseInt(totalElement.textContent.replace(/[^0-9]/g, ''));
            const discountAmount = Math.round(subtotal - totalValue);
            const total = subtotal - discountAmount;
            
            // 建立折扣快照(使用當時的最新名稱)
            const discountSnapshot = discounts.map(d => {
                let snapshotName = d.name; // 預設使用備份名稱
                if (d.discountId) {
                    const latestDiscount = discountButtons.find(btn => btn.id === d.discountId);
                    if (latestDiscount) {
                        snapshotName = latestDiscount.name; // 使用最新名稱
                    }
                }
                return {
                    name: snapshotName, // 儲存當時的名稱(快照)
                    type: d.type,
                    description: d.description,
                    amount: d.amount,
                    rate: d.rate
                };
            });
            
            // 扣除庫存
            orderItems.forEach(item => {
                // 只跳過折扣項目(贈品要扣庫存)
                if (item.isDiscount) return;
                
                // 處理贈品的庫存扣除
                if (item.isGift) {
                    // 贈品的庫存記錄在 giftRules 中
                    const giftRule = giftRules.find(rule => rule.id === item.giftRuleId);
                    if (giftRule && giftRule.giftStock !== undefined) {
                        giftRule.giftStock -= item.quantity;
                        // 確保庫存不會是負數
                        if (giftRule.giftStock < 0) {
                            giftRule.giftStock = 0;
                        }
                    }
                    return;
                }
                
                // 找到對應的商品或加購項目
                let targetItem = null;
                if (item.isAddon) {
                    // 加購項目
                    targetItem = addOnItems.find(addon => addon.id === item.id);
                } else {
                    // 一般商品
                    targetItem = products.find(p => p.id === item.id);
                }
                
                if (targetItem) {
                    // 如果有規格，扣除對應規格的庫存
                    if (item.selectedVariants && Object.keys(item.selectedVariants).length > 0) {
                        if (targetItem.variantStock) {
                            const variantKey = Object.keys(targetItem.variants || {})
                                .map(key => item.selectedVariants[key])
                                .join(',');
                            if (targetItem.variantStock[variantKey] !== undefined) {
                                targetItem.variantStock[variantKey] -= item.quantity;
                                // 確保庫存不會是負數
                                if (targetItem.variantStock[variantKey] < 0) {
                                    targetItem.variantStock[variantKey] = 0;
                                }
                            }
                        }
                    } else {
                        // 沒有規格，扣除一般庫存
                        if (targetItem.stock !== undefined) {
                            targetItem.stock -= item.quantity;
                            // 確保庫存不會是負數
                            if (targetItem.stock < 0) {
                                targetItem.stock = 0;
                            }
                            
                            // 同時更新 productData
                            if (!item.isAddon && targetItem.brand && targetItem.mainCategory !== undefined) {
                                const pdBrand = targetItem.brand;
                                const pdMainCat = targetItem.mainCategory;
                                const pdSubCat = targetItem.subCategory || '';
                                
                                if (productData[pdBrand] && 
                                    productData[pdBrand][pdMainCat] && 
                                    productData[pdBrand][pdMainCat][pdSubCat]) {
                                    
                                    const pdIndex = productData[pdBrand][pdMainCat][pdSubCat].findIndex(p => 
                                        p.name === targetItem.name && p.brand === targetItem.brand
                                    );
                                    if (pdIndex !== -1) {
                                        productData[pdBrand][pdMainCat][pdSubCat][pdIndex].stock = targetItem.stock;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            // 記錄銷售（包含訂單資訊）
            salesHistory.push({
                ...orderInfo,
                timestamp: new Date().toISOString(),
                timestampDisplay: new Date().toLocaleString('zh-TW'),
                items: JSON.parse(JSON.stringify(orderItems)),
                discounts: discountSnapshot, // 儲存折扣快照陣列
                discountName: discountSnapshot.map(d => d.name).join(', ') || '無',
                discountAmount: discountAmount,
                subtotal: subtotal,
                total: total
            });

            showNotification(`✅ 結帳完成！總金額：NT$ ${total}`);
            
            // 清空訂單和訂單資訊
            orderItems = [];
            discounts = [];
            clearOrderInfo();
            updateOrder();
            
            // 重新載入商品列表以顯示更新後的庫存
            loadProducts();
            
            // 自動保存
            saveDataToLocalStorage();
        }

        // === 列印預覽功能 ===
        
        // 打開列印預覽
        function openPrintPreview() {
            if (orderItems.length === 0) return;
            
            const orderInfo = getOrderInfo();
            
            // 分類：商品在前，加購項目在後，贈品最後
            const products = orderItems.filter(item => !item.isAddon && !item.isGift);
            const addons = orderItems.filter(item => item.isAddon);
            const gifts = orderItems.filter(item => item.isGift);
            const sortedItems = [...products, ...addons, ...gifts];
            
            const subtotal = sortedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalAmount = parseInt(document.getElementById('total').textContent.replace(/[^0-9]/g, ''));
            const discountAmount = subtotal - totalAmount;
            
            // 處理折扣,使用最新名稱
            const discountsWithLatestNames = discounts.map(d => {
                let displayName = d.name; // 預設使用備份名稱
                if (d.discountId) {
                    const latestDiscount = discountButtons.find(btn => btn.id === d.discountId);
                    if (latestDiscount) {
                        displayName = latestDiscount.name; // 使用最新名稱
                    }
                }
                return { ...d, name: displayName };
            });
            
            // 生成收據HTML
            const receiptHTML = generateReceiptHTML(orderInfo, sortedItems, discountsWithLatestNames, subtotal, discountAmount, totalAmount);
            
            document.getElementById('printPreviewContent').innerHTML = receiptHTML;
            document.getElementById('printPreviewModal').classList.add('show');
        }
        
        // 查看歷史訂單的收據
        function viewReceipt(saleIndex) {
            const sale = salesHistory[saleIndex];
            if (!sale) {
                showNotification('❌ 找不到訂單資料');
                return;
            }
            
            // 準備訂單資訊
            const orderInfo = {
                orderNumber: sale.orderNumber || '無',
                orderDate: sale.timestampDisplay || new Date(sale.timestamp).toLocaleString('zh-TW'),
                saleLocation: sale.saleLocation || '',
                salesPerson: sale.salesPerson || '',
                memberAccount: sale.memberAccount || '',
                memberName: sale.memberName || '',
                memberPhone: sale.memberPhone || '',
                memberEmail: sale.memberEmail || '',
                orderNote: sale.orderNote || ''
            };
            
            // 分類：商品在前，加購項目在後，贈品最後
            const products = sale.items.filter(item => !item.isAddon && !item.isGift);
            const addons = sale.items.filter(item => item.isAddon);
            const gifts = sale.items.filter(item => item.isGift);
            const sortedItems = [...products, ...addons, ...gifts];
            
            // 計算金額
            const subtotal = sortedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalAmount = sale.total || 0;
            const discountAmount = sale.discountAmount || 0;
            
            // 準備折扣資訊（如果有的話）
            const discountList = [];
            if (sale.discountName && discountAmount > 0) {
                discountList.push({
                    name: sale.discountName,
                    amount: discountAmount
                });
            }
            
            // 生成收據HTML
            const receiptHTML = generateReceiptHTML(orderInfo, sortedItems, discountList, subtotal, discountAmount, totalAmount);
            
            document.getElementById('printPreviewContent').innerHTML = receiptHTML;
            document.getElementById('printPreviewModal').classList.add('show');
        }


        // 關閉列印預覽
        function closePrintPreview() {
            document.getElementById('printPreviewModal').classList.remove('show');
        }

        // 生成收據HTML
        function generateReceiptHTML(orderInfo, items, discountList, subtotal, discountAmount, total) {
            const now = new Date();
            const dateStr = orderInfo.orderDate || now.toLocaleString('zh-TW');
            
            // 組合店家資訊行（只顯示內容，不顯示欄位名稱）
            let shopInfoLines = [];
            shopInfoLines.push(`${orderInfo.saleLocation || '未指定'}`);
            
            if (systemSettings.showTaxId && systemSettings.taxId) {
                shopInfoLines.push(`${systemSettings.taxId}`);
            }
            if (systemSettings.showPhone && systemSettings.phone) {
                shopInfoLines.push(`${systemSettings.phone}`);
            }
            if (systemSettings.showAddress && systemSettings.address) {
                shopInfoLines.push(`${systemSettings.address}`);
            }
            if (systemSettings.showWebsite && systemSettings.website) {
                shopInfoLines.push(`${systemSettings.website}`);
            }
            
            // 加入社群連結（只顯示內容）
            if (systemSettings.showSocial && systemSettings.socialLinks && systemSettings.socialLinks.length > 0) {
                systemSettings.socialLinks.forEach(link => {
                    shopInfoLines.push(`${link.value}`);
                });
            }
            
            const shopInfoHTML = shopInfoLines.join('<br>');
            
            return `
                <div class="receipt-header">
                    <div class="receipt-title">${systemSettings.shopName || 'TimuAnchi 銷售系統'}</div>
                    <div class="receipt-shop-info">
                        ${shopInfoHTML}
                    </div>
                </div>

                <div class="receipt-section">
                    <div class="receipt-section-title">訂單資訊</div>
                    <div class="receipt-info-row">
                        <span class="receipt-info-label">訂單編號：</span>
                        <span class="receipt-info-value">${orderInfo.orderNumber || '未生成'}</span>
                    </div>
                    <div class="receipt-info-row">
                        <span class="receipt-info-label">交易時間：</span>
                        <span class="receipt-info-value">${dateStr}</span>
                    </div>
                    ${orderInfo.salesPerson ? `
                    <div class="receipt-info-row">
                        <span class="receipt-info-label">服務人員：</span>
                        <span class="receipt-info-value">${orderInfo.salesPerson}</span>
                    </div>
                    ` : ''}
                </div>

                ${orderInfo.memberAccount || orderInfo.memberName || orderInfo.memberPhone || orderInfo.memberEmail ? `
                <div class="receipt-section">
                    <div class="receipt-section-title">顧客資訊</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0 16px; font-size: 10px;">
                        <div class="receipt-info-row">
                            <span class="receipt-info-label">會員帳號：</span>
                            <span class="receipt-info-value">${orderInfo.memberAccount || ''}</span>
                        </div>
                        <div class="receipt-info-row">
                            <span class="receipt-info-label">會員名稱：</span>
                            <span class="receipt-info-value">${orderInfo.memberName || ''}</span>
                        </div>
                        <div class="receipt-info-row">
                            <span class="receipt-info-label">聯絡電話：</span>
                            <span class="receipt-info-value">${orderInfo.memberPhone || ''}</span>
                        </div>
                        <div class="receipt-info-row">
                            <span class="receipt-info-label">電子信箱：</span>
                            <span class="receipt-info-value">${orderInfo.memberEmail || ''}</span>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div class="receipt-items">
                    <div class="receipt-item" style="font-weight: bold; border-bottom: 1px solid #000;">
                        <div class="receipt-item-name">訂單明細</div>
                        <div class="receipt-item-qty">數量</div>
                        <div class="receipt-item-price">小計</div>
                    </div>
                    ${items.map(item => {
                        const itemTotal = item.price * item.quantity;
                        
                        // 贈品標記
                        if (item.isGift) {
                            return `
                            <div class="receipt-item" style="background: #fff; font-size: 12px;">
                                <div class="receipt-item-name">
                                    <span style="font-weight: 600;">【贈品】</span>${item.name}
                                    ${item.sku ? `<br><span style="font-size: 10px; color: #000;">貨號: ${item.sku}</span>` : ''}
                                    <br><span style="font-size: 10px; color: #000;">${item.giftRuleName || ''}</span>
                                </div>
                                <div class="receipt-item-qty">x ${item.quantity}</div>
                                <div class="receipt-item-price">NT$ 0</div>
                            </div>
                            `;
                        }
                        
                        const addonLabel = item.isAddon ? '<span style="font-weight: 600;">【加購】</span>' : '';
                        
                        // 處理規格顯示
                        let variantInfo = '';
                        if (item.selectedVariants && Object.keys(item.selectedVariants).length > 0) {
                            const variantText = Object.entries(item.selectedVariants)
                                .map(([key, value]) => `${key}: ${value}`)
                                .join(' | ');
                            variantInfo = `<br><span style="font-size: 10px; color: #000;">${variantText}</span>`;
                        }
                        
                        return `
                        <div class="receipt-item" style="font-size: 12px;">
                            <div class="receipt-item-name">
                                ${addonLabel}${item.name}
                                ${variantInfo}
                                ${item.sku ? `<br><span style="font-size: 10px; color: #000;">貨號: ${item.sku}</span>` : ''}
                                ${(item.brandName || item.brand) ? `<br><span style="font-size: 10px; color: #000;">${item.brandName || item.brand}</span>` : ''}
                                <br><span style="font-size: 10px; color: #000;">單價: NT$ ${item.price}</span>
                            </div>
                            <div class="receipt-item-qty">x ${item.quantity}</div>
                            <div class="receipt-item-price">NT$ ${itemTotal}</div>
                        </div>
                        `;
                    }).join('')}
                </div>

                <div class="receipt-totals">
                    <div class="receipt-total-row" style="font-size: 12px;">
                        <span>小計</span>
                        <span>NT$ ${subtotal}</span>
                    </div>
                    ${discountAmount > 0 ? `
                    <div class="receipt-total-row" style="font-size: 12px;">
                        <span>${discountList.length > 0 ? discountList.map(d => d.name).join(', ') : '折扣'}</span>
                        <span>- NT$ ${discountAmount}</span>
                    </div>
                    ` : ''}
                    <div class="receipt-total-row final">
                        <span>總計</span>
                        <span>NT$ ${total}</span>
                    </div>
                </div>

                <div class="receipt-section" style="margin-top: 16px;">
                    <div class="receipt-info-row">
                        <span class="receipt-info-label">訂單備註：</span>
                        <span class="receipt-info-value">${orderInfo.orderNote || ''}</span>
                    </div>
                </div>

                <div class="receipt-footer">
                    ${systemSettings.footerText.replace(/\n/g, '<br>')}
                </div>
            `;
        }

        // 列印收據
        function printReceipt() {
            window.print();
        }
        
        // 下載 PDF
        function downloadPDF() {
            const element = document.getElementById('printPreviewContent');
            
            // 取得訂單編號作為檔名
            const orderNumber = element.querySelector('.receipt-info-value')?.textContent || '收據';
            const filename = `收據_${orderNumber}.pdf`;
            
            // 設定選項 - 使用最簡單的設定來保持文字大小一致
            const opt = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { 
                    scale: 1,  // 使用 1:1 比例
                    useCORS: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                }
            };
            
            // 生成並下載 PDF
            html2pdf().set(opt).from(element).save();
        }

        // === 加購項目功能 ===
        
        // 載入加購項目卡片
        function loadAddonItems() {
            const container = document.getElementById('addonGrid');
            
            if (addOnItems.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #999; font-size: 13px;">尚無加購項目，請點擊管理新增</div>';
                return;
            }
            
            container.innerHTML = addOnItems.map(item => {
                // 判斷是否有規格
                const hasVariants = item.variants && Object.keys(item.variants).length > 0;
                const variantInfo = hasVariants ? '<div class="product-variants">有多規格</div>' : '';
                const skuInfo = item.sku ? `<div class="product-sku">${item.sku}</div>` : '';
                
                // 計算價格顯示
                let priceDisplay = '';
                if (item.variantPrices && Object.keys(item.variantPrices).length > 0) {
                    const prices = Object.values(item.variantPrices);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice !== maxPrice) {
                        priceDisplay = `NT$ ${minPrice}-${maxPrice}`;
                    } else {
                        priceDisplay = `NT$ ${minPrice}`;
                    }
                } else {
                    priceDisplay = `NT$ ${item.price}`;
                }
                
                // 計算庫存總和
                let totalStock = 0;
                if (hasVariants && item.variantStock) {
                    totalStock = Object.values(item.variantStock).reduce((sum, stock) => sum + stock, 0);
                } else if (item.stock !== undefined && item.stock !== null) {
                    totalStock = item.stock;
                }
                
                // 庫存顯示和顏色
                let stockInfo = '';
                if (totalStock !== undefined && totalStock !== null) {
                    let stockColor = '#388e3c';
                    if (totalStock <= 0) {
                        stockColor = '#d32f2f';
                    } else if (totalStock <= 5) {
                        stockColor = '#f57c00';
                    }
                    stockInfo = `<div class="product-stock" style="color: ${stockColor};">庫存: ${totalStock}</div>`;
                }
                
                // 檢查是否售罄
                const isSoldOut = totalStock <= 0;
                const cardClass = isSoldOut ? 'addon-card sold-out' : 'addon-card';
                const clickEvent = isSoldOut ? 'onclick="alert(\'此項目已售罄\')"' : (hasVariants ? `onclick='openAddonVariantSelector("${item.id}")'` : `onclick='addAddonToOrder("${item.id}")'`);
                const soldOutLabel = isSoldOut ? '<div class="sold-out-label">售罄</div>' : '';
                
                return `
                    <div class="${cardClass}" ${clickEvent} style="position: relative;">
                        ${soldOutLabel}
                        <div class="addon-card-name">${item.name}</div>
                        ${skuInfo}
                        <div class="addon-card-price">${priceDisplay}</div>
                        ${stockInfo}
                        ${variantInfo}
                    </div>
                `;
            }).join('');
        }

        // 打開加購項目規格選擇器
        function openAddonVariantSelector(addonId) {
            const addon = addOnItems.find(item => item.id === addonId);
            if (!addon || !addon.variants) return;
            
            currentSelectedAddon = addon;
            selectedVariants = {};
            
            document.getElementById('variantProductName').textContent = addon.name;
            document.getElementById('variantProductSku').textContent = addon.sku || '';
            document.getElementById('variantProductPrice').textContent = `NT$ ${addon.price}`;
            document.getElementById('variantProductStock').textContent = '';
            
            const container = document.getElementById('variantGroups');
            container.innerHTML = Object.entries(addon.variants).map(([variantName, options]) => `
                <div class="variant-group">
                    <div class="variant-label">${variantName}</div>
                    <div class="variant-options">
                        ${options.map(option => `
                            <div class="variant-option" onclick="selectAddonVariant('${variantName}', '${option}')">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('variantModal').classList.add('show');
        }

        // 選擇加購項目規格
        function selectAddonVariant(variantName, option) {
            selectedVariants[variantName] = option;
            
            // 更新選中狀態
            const variantGroups = document.querySelectorAll('.variant-group');
            variantGroups.forEach(group => {
                const label = group.querySelector('.variant-label').textContent;
                if (label === variantName) {
                    const options = group.querySelectorAll('.variant-option');
                    options.forEach(opt => {
                        if (opt.textContent.trim() === option) {
                            opt.classList.add('selected');
                        } else {
                            opt.classList.remove('selected');
                        }
                    });
                }
            });
            
            // 更新價格和庫存顯示
            updateAddonVariantDisplay();
        }

        // 更新加購項目規格顯示
        function updateAddonVariantDisplay() {
            const confirmBtn = document.getElementById('variantConfirmBtn');
            
            if (!currentSelectedAddon.variants) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = '加到訂單明細';
                confirmBtn.style.background = '';
                confirmBtn.style.cursor = '';
                return;
            }
            
            const requiredVariants = Object.keys(currentSelectedAddon.variants);
            const selectedVariantKeys = Object.keys(selectedVariants);
            
            if (requiredVariants.length === selectedVariantKeys.length) {
                // 所有規格都已選擇，生成組合key
                const variantKey = requiredVariants.map(key => selectedVariants[key]).join(',');
                const sku = currentSelectedAddon.variantSkus ? currentSelectedAddon.variantSkus[variantKey] : null;
                const price = currentSelectedAddon.variantPrices ? currentSelectedAddon.variantPrices[variantKey] : null;
                const stock = currentSelectedAddon.variantStock ? currentSelectedAddon.variantStock[variantKey] : null;
                
                // 顯示貨號
                const skuElement = document.getElementById('variantProductSku');
                if (sku) {
                    skuElement.textContent = `貨號: ${sku}`;
                } else if (currentSelectedAddon.sku) {
                    skuElement.textContent = currentSelectedAddon.sku;
                } else {
                    skuElement.textContent = '此規格組合無貨號';
                }
                
                // 顯示價格
                const priceElement = document.getElementById('variantProductPrice');
                if (price !== null && price !== undefined) {
                    priceElement.textContent = `NT$ ${price}`;
                } else {
                    priceElement.textContent = `NT$ ${currentSelectedAddon.price}`;
                }
                
                // 顯示庫存並控制按鈕
                const stockElement = document.getElementById('variantProductStock');
                if (stock !== null && stock !== undefined) {
                    if (stock <= 0) {
                        stockElement.textContent = '庫存：已售罄';
                        stockElement.style.color = '#d32f2f';
                        // 按鈕變灰色不可點擊
                        confirmBtn.disabled = true;
                        confirmBtn.textContent = '無法加入';
                        confirmBtn.style.background = '#ccc';
                        confirmBtn.style.cursor = 'not-allowed';
                    } else if (stock <= 5) {
                        stockElement.textContent = `庫存：${stock} 件（即將售罄）`;
                        stockElement.style.color = '#f57c00';
                        // 按鈕可點擊
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = '加到訂單明細';
                        confirmBtn.style.background = '';
                        confirmBtn.style.cursor = '';
                    } else {
                        stockElement.textContent = `庫存：${stock} 件`;
                        stockElement.style.color = '#388e3c';
                        // 按鈕可點擊
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = '加到訂單明細';
                        confirmBtn.style.background = '';
                        confirmBtn.style.cursor = '';
                    }
                } else {
                    stockElement.textContent = '';
                    // 沒有庫存資訊，預設可加入
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '加到訂單明細';
                    confirmBtn.style.background = '';
                    confirmBtn.style.cursor = '';
                }
            } else {
                // 還沒選擇完所有規格
                document.getElementById('variantProductSku').textContent = '請選擇所有規格';
                document.getElementById('variantProductStock').textContent = '';
                // 未選完規格，按鈕可點擊但會提示
                confirmBtn.disabled = false;
                confirmBtn.textContent = '加到訂單明細';
                confirmBtn.style.background = '';
                confirmBtn.style.cursor = '';
            }
        }

        // 將加購項目加入訂單
        function addAddonToOrder(addonId, addonWithVariants = null) {
            const addon = addonWithVariants || addOnItems.find(item => item.id === addonId);
            if (!addon) return;
            
            // 如果有規格，需要比對規格是否相同
            let existingIndex = -1;
            if (addon.selectedVariants) {
                existingIndex = orderItems.findIndex(item => 
                    item.id === addonId && 
                    item.isAddon &&
                    JSON.stringify(item.selectedVariants) === JSON.stringify(addon.selectedVariants)
                );
            } else {
                existingIndex = orderItems.findIndex(item => 
                    item.id === addonId && 
                    item.isAddon &&
                    !item.selectedVariants
                );
            }
            
            if (existingIndex > -1) {
                // 已存在，增加數量
                orderItems[existingIndex].quantity++;
            } else {
                // 新增
                orderItems.push({
                    id: addon.id,
                    name: addon.name,
                    displayName: addon.displayName || addon.name,
                    selectedVariants: addon.selectedVariants || null,
                    sku: addon.sku || '',
                    price: addon.price,
                    quantity: 1,
                    isAddon: true // 標記為加購項目
                });
            }
            
            updateOrder();
            saveDataToLocalStorage();
            showNotification(`✅ 已加入：${addon.displayName || addon.name}`);
        }

        // 打開加購項目管理
        function openAddonManager() {
            loadAddonList();
            document.getElementById('addonModal').classList.add('show');
        }

        // 關閉加購項目管理
        function closeAddonManager() {
            document.getElementById('addonModal').classList.remove('show');
        }

        // 打開新增加購項目彈窗
        function openAddAddonModal() {
            // 重置編輯狀態
            currentEditingAddonIndex = null;
            document.getElementById('addonModalTitle').textContent = '新增加購項目';
            
            // 清空表單
            document.getElementById('newAddonName').value = '';
            document.getElementById('newAddonSku').value = '';
            document.getElementById('newAddonPrice').value = '';
            document.getElementById('newAddonStock').value = '';
            
            // 清空規格容器和組合列表
            document.getElementById('addonVariantGroupsContainer').innerHTML = '';
            document.getElementById('addonVariantSkuList').innerHTML = '';
            document.getElementById('addonVariantSkuSection').style.display = 'none';
            
            // 重置價格和庫存顯示狀態
            document.getElementById('addonSimplePriceSection').style.display = 'block';
            document.getElementById('addonTotalPriceDisplay').style.display = 'none';
            document.getElementById('addonSimpleStockSection').style.display = 'block';
            document.getElementById('addonTotalStockDisplay').style.display = 'none';
            
            document.getElementById('addAddonModal').classList.add('show');
        }

        // 關閉新增加購項目彈窗
        function closeAddAddonModal() {
            document.getElementById('addAddonModal').classList.remove('show');
            currentEditingAddonIndex = null;
        }

        // 編輯加購項目
        function editAddon(index) {
            const addon = addOnItems[index];
            currentEditingAddonIndex = index;
            
            // 修改標題
            document.getElementById('addonModalTitle').textContent = '編輯加購項目';
            
            // 填入基本資料
            document.getElementById('newAddonName').value = addon.name || '';
            document.getElementById('newAddonSku').value = addon.sku || '';
            document.getElementById('newAddonPrice').value = addon.price || '';
            document.getElementById('newAddonStock').value = addon.stock !== undefined ? addon.stock : '';
            
            // 清空規格容器和組合列表
            document.getElementById('addonVariantGroupsContainer').innerHTML = '';
            document.getElementById('addonVariantSkuList').innerHTML = '';
            document.getElementById('addonVariantSkuSection').style.display = 'none';
            
            // 重置價格和庫存顯示狀態
            document.getElementById('addonSimplePriceSection').style.display = 'block';
            document.getElementById('addonTotalPriceDisplay').style.display = 'none';
            document.getElementById('addonSimpleStockSection').style.display = 'block';
            document.getElementById('addonTotalStockDisplay').style.display = 'none';
            
            // 載入規格資料
            if (addon.variants && Object.keys(addon.variants).length > 0) {
                // 重建規格群組
                Object.entries(addon.variants).forEach(([variantName, options]) => {
                    const groupId = addonVariantGroupCounter++;
                    const container = document.getElementById('addonVariantGroupsContainer');
                    
                    const groupHtml = `
                        <div class="variant-group-builder" id="addonVariantGroup${groupId}">
                            <div class="variant-group-header">
                                <input type="text" placeholder="規格名稱 (例如：尺寸)" id="addonVariantGroupName${groupId}" value="${variantName}" />
                                <button class="remove-variant-group-btn" onclick="removeAddonVariantGroup(${groupId})">刪除</button>
                            </div>
                            <div class="variant-options-builder" id="addonVariantOptions${groupId}">
                                ${options.map(option => `
                                    <div class="variant-option-builder">
                                        <input type="text" placeholder="選項" value="${option}" />
                                        <button class="remove-option-btn" onclick="this.parentElement.remove()">×</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-option-btn" onclick="addAddonVariantOption(${groupId})">➕ 新增選項</button>
                        </div>
                    `;
                    
                    container.insertAdjacentHTML('beforeend', groupHtml);
                });
                
                // 自動產生規格組合並填入資料
                generateAddonVariantCombinations();
                
                // 填入規格貨號、價格、庫存
                if (addon.variantSkus || addon.variantPrices || addon.variantStock) {
                    setTimeout(() => {
                        document.querySelectorAll('#addonVariantSkuList .variant-sku-input').forEach(input => {
                            const key = input.dataset.key;
                            if (addon.variantSkus && addon.variantSkus[key]) {
                                input.value = addon.variantSkus[key];
                            }
                        });
                        
                        document.querySelectorAll('#addonVariantSkuList .variant-price-input').forEach(input => {
                            const key = input.dataset.key;
                            if (addon.variantPrices && addon.variantPrices[key] !== undefined) {
                                input.value = addon.variantPrices[key];
                            }
                        });
                        
                        document.querySelectorAll('#addonVariantSkuList .variant-stock-input').forEach(input => {
                            const key = input.dataset.key;
                            if (addon.variantStock && addon.variantStock[key] !== undefined) {
                                input.value = addon.variantStock[key];
                            }
                        });
                        
                        // 填入資料後，更新價格區間和庫存總和
                        updateAddonTotalPriceDisplay();
                        updateAddonTotalStockDisplay();
                    }, 100);
                }
            }
            
            // 關閉編輯彈窗，打開新增/編輯彈窗
            closeAddonManager();
            document.getElementById('addAddonModal').classList.add('show');
        }

        // 新增加購項目規格群組
        function addAddonVariantGroup() {
            const container = document.getElementById('addonVariantGroupsContainer');
            
            const groupId = addonVariantGroupCounter++;
            const groupHtml = `
                <div class="variant-group-builder" id="addonVariantGroup${groupId}">
                    <div class="variant-group-header">
                        <input type="text" placeholder="規格名稱 (例如：尺寸)" id="addonVariantGroupName${groupId}" />
                        <button class="remove-variant-group-btn" onclick="removeAddonVariantGroup(${groupId})">刪除</button>
                    </div>
                    <div class="variant-options-builder" id="addonVariantOptions${groupId}">
                        <div class="variant-option-builder">
                            <input type="text" placeholder="選項1" />
                            <button class="remove-option-btn" onclick="this.parentElement.remove()">×</button>
                        </div>
                    </div>
                    <button class="add-option-btn" onclick="addAddonVariantOption(${groupId})">➕ 新增選項</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', groupHtml);
        }

        // 移除加購項目規格群組
        function removeAddonVariantGroup(groupId) {
            const group = document.getElementById(`addonVariantGroup${groupId}`);
            if (group) {
                group.remove();
            }
        }

        // 新增加購項目規格選項
        function addAddonVariantOption(groupId) {
            const container = document.getElementById(`addonVariantOptions${groupId}`);
            const optionHtml = `
                <div class="variant-option-builder">
                    <input type="text" placeholder="選項" />
                    <button class="remove-option-btn" onclick="this.parentElement.remove()">×</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        // 產生加購項目規格組合
        function generateAddonVariantCombinations() {
            const variantGroups = document.querySelectorAll('#addonVariantGroupsContainer .variant-group-builder');
            
            if (variantGroups.length === 0) {
                document.getElementById('addonVariantSkuSection').style.display = 'none';
                return;
            }
            
            // 收集所有規格及選項
            const variants = [];
            variantGroups.forEach(group => {
                const groupNameInput = group.querySelector('input[id^="addonVariantGroupName"]');
                const groupName = groupNameInput.value.trim();
                
                if (groupName) {
                    const options = [];
                    const optionInputs = group.querySelectorAll('.variant-option-builder input');
                    
                    optionInputs.forEach(input => {
                        const optionValue = input.value.trim();
                        if (optionValue) {
                            options.push(optionValue);
                        }
                    });
                    
                    if (options.length > 0) {
                        variants.push({ name: groupName, options });
                    }
                }
            });
            
            if (variants.length === 0) {
                document.getElementById('addonVariantSkuSection').style.display = 'none';
                return;
            }
            
            // 生成所有組合
            const combinations = generateCombinations(variants);
            
            // 顯示貨號輸入區
            document.getElementById('addonVariantSkuSection').style.display = 'block';
            const container = document.getElementById('addonVariantSkuList');
            
            // 保留已有的貨號、庫存和價格值
            const existingSkus = {};
            const existingStocks = {};
            const existingPrices = {};
            container.querySelectorAll('.variant-sku-input').forEach(input => {
                existingSkus[input.dataset.key] = input.value;
            });
            container.querySelectorAll('.variant-stock-input').forEach(input => {
                existingStocks[input.dataset.key] = input.value;
            });
            container.querySelectorAll('.variant-price-input').forEach(input => {
                existingPrices[input.dataset.key] = input.value;
            });
            
            container.innerHTML = combinations.map(combo => {
                const key = combo.values.join(',');
                const label = combo.labels.join(' + ');
                const existingSkuValue = existingSkus[key] || '';
                const existingStockValue = existingStocks[key] || '';
                const existingPriceValue = existingPrices[key] || '';
                
                return `
                    <div class="variant-sku-item">
                        <div class="variant-sku-label">${label}</div>
                        <input type="text" class="variant-sku-input" data-key="${key}" value="${existingSkuValue}" placeholder="貨號" />
                        <input type="number" class="variant-price-input" data-key="${key}" value="${existingPriceValue}" placeholder="價格" min="0" onchange="updateAddonTotalPriceDisplay()" />
                        <input type="number" class="variant-stock-input" data-key="${key}" value="${existingStockValue}" placeholder="庫存" min="0" onchange="updateAddonTotalStockDisplay()" />
                    </div>
                `;
            }).join('');
            
            // 顯示/隱藏價格和庫存欄位
            document.getElementById('addonSimplePriceSection').style.display = 'none';
            document.getElementById('addonTotalPriceDisplay').style.display = 'block';
            document.getElementById('addonSimpleStockSection').style.display = 'none';
            document.getElementById('addonTotalStockDisplay').style.display = 'block';
            
            // 計算並顯示價格區間和庫存總和
            updateAddonTotalPriceDisplay();
            updateAddonTotalStockDisplay();
        }

        // 更新加購項目價格區間顯示
        function updateAddonTotalPriceDisplay() {
            const priceInputs = document.querySelectorAll('#addonVariantSkuList .variant-price-input');
            const prices = [];
            
            priceInputs.forEach(input => {
                const price = parseInt(input.value);
                if (!isNaN(price) && price >= 0) {
                    prices.push(price);
                }
            });
            
            const displayInput = document.getElementById('addonDisplayTotalPrice');
            if (displayInput) {
                if (prices.length === 0) {
                    displayInput.value = '待設定';
                } else {
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice === maxPrice) {
                        displayInput.value = `NT$ ${minPrice}`;
                    } else {
                        displayInput.value = `NT$ ${minPrice}-${maxPrice}`;
                    }
                }
            }
        }

        // 更新加購項目庫存總和顯示
        function updateAddonTotalStockDisplay() {
            const stockInputs = document.querySelectorAll('#addonVariantSkuList .variant-stock-input');
            let totalStock = 0;
            
            stockInputs.forEach(input => {
                const stock = parseInt(input.value) || 0;
                totalStock += stock;
            });
            
            const displayInput = document.getElementById('addonDisplayTotalStock');
            if (displayInput) {
                displayInput.value = `${totalStock} 件`;
            }
        }

        // 儲存新加購項目
        function saveNewAddon() {
            const name = document.getElementById('newAddonName').value.trim();
            const sku = document.getElementById('newAddonSku').value.trim();
            const price = parseInt(document.getElementById('newAddonPrice').value);
            const stock = parseInt(document.getElementById('newAddonStock').value);
            
            // 驗證必填欄位
            if (!name) {
                alert('請輸入項目名稱');
                return;
            }
            
            // 檢查是否有規格
            const hasVariants = document.querySelectorAll('#addonVariantGroupsContainer .variant-group-builder').length > 0 &&
                                document.getElementById('addonVariantSkuSection').style.display !== 'none';
            
            // 如果沒有規格，基礎價格必填
            if (!hasVariants && (isNaN(price) || price < 0)) {
                alert('請輸入有效的價格');
                return;
            }
            
            // 建立加購項目物件
            const addonData = {
                name: name,
                price: hasVariants ? 0 : price,  // 有規格時基礎價格設為 0
                type: 'custom'
            };
            
            // 加入選填欄位
            if (sku) {
                addonData.sku = sku;
            }
            
            if (!isNaN(stock) && stock >= 0) {
                addonData.stock = stock;
            }
            
            // 收集規格資料
            const variantGroups = document.querySelectorAll('#addonVariantGroupsContainer .variant-group-builder');
            if (variantGroups.length > 0) {
                const variants = {};
                let hasValidVariant = false;

                variantGroups.forEach(group => {
                    const groupNameInput = group.querySelector('input[id^="addonVariantGroupName"]');
                    const groupName = groupNameInput.value.trim();
                    
                    if (groupName) {
                        const options = [];
                        const optionInputs = group.querySelectorAll('.variant-option-builder input');
                        
                        optionInputs.forEach(input => {
                            const optionValue = input.value.trim();
                            if (optionValue) {
                                options.push(optionValue);
                            }
                        });

                        if (options.length > 0) {
                            variants[groupName] = options;
                            hasValidVariant = true;
                        }
                    }
                });

                if (hasValidVariant) {
                    addonData.variants = variants;
                    
                    // 收集規格貨號
                    const variantSkus = {};
                    document.querySelectorAll('#addonVariantSkuList .variant-sku-input').forEach(input => {
                        const key = input.dataset.key;
                        const sku = input.value.trim();
                        if (sku) {
                            variantSkus[key] = sku;
                        }
                    });
                    
                    if (Object.keys(variantSkus).length > 0) {
                        addonData.variantSkus = variantSkus;
                    }
                    
                    // 收集規格庫存
                    const variantStock = {};
                    document.querySelectorAll('#addonVariantSkuList .variant-stock-input').forEach(input => {
                        const key = input.dataset.key;
                        const stock = parseInt(input.value);
                        if (!isNaN(stock) && stock >= 0) {
                            variantStock[key] = stock;
                        }
                    });
                    
                    if (Object.keys(variantStock).length > 0) {
                        addonData.variantStock = variantStock;
                    }
                    
                    // 收集規格價格並驗證必填
                    const variantPrices = {};
                    const priceInputs = document.querySelectorAll('#addonVariantSkuList .variant-price-input');
                    let allPricesFilled = true;
                    
                    priceInputs.forEach(input => {
                        const key = input.dataset.key;
                        const price = parseInt(input.value);
                        if (!isNaN(price) && price >= 0) {
                            variantPrices[key] = price;
                        } else {
                            allPricesFilled = false;
                        }
                    });
                    
                    // 驗證：有規格時，所有規格價格必填
                    if (priceInputs.length > 0 && !allPricesFilled) {
                        alert('請填寫所有規格的價格');
                        return;
                    }
                    
                    if (Object.keys(variantPrices).length > 0) {
                        addonData.variantPrices = variantPrices;
                    }
                }
            }
            
            // 判斷是新增還是編輯
            if (currentEditingAddonIndex !== null) {
                // 編輯模式：保留原有 ID，更新資料
                addonData.id = addOnItems[currentEditingAddonIndex].id;
                addOnItems[currentEditingAddonIndex] = addonData;
                showNotification('✅ 加購項目已更新');
            } else {
                // 新增模式：生成新 ID
                addonData.id = 'addon_' + Date.now();
                addOnItems.push(addonData);
                showNotification('✅ 加購項目已新增');
            }
            
            // 儲存到 localStorage
            saveDataToLocalStorage();
            
            // 重新載入加購項目
            loadAddonItems();
            
            // 關閉彈窗
            closeAddAddonModal();
        }

        // 載入加購項目列表
        function loadAddonList() {
            const container = document.getElementById('addonList');
            
            if (addOnItems.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">尚無加購項目</div>';
                return;
            }
            
            container.innerHTML = addOnItems.map((item, index) => {
                // 判斷是否有規格
                const hasVariants = item.variants && Object.keys(item.variants).length > 0;
                
                // 計算價格顯示
                let priceDisplay = '';
                if (item.variantPrices && Object.keys(item.variantPrices).length > 0) {
                    const prices = Object.values(item.variantPrices);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    if (minPrice !== maxPrice) {
                        priceDisplay = `NT$ ${minPrice}-${maxPrice}`;
                    } else {
                        priceDisplay = `NT$ ${minPrice}`;
                    }
                } else {
                    priceDisplay = `NT$ ${item.price}`;
                }
                
                // 計算庫存總和
                let totalStock = 0;
                if (hasVariants && item.variantStock) {
                    totalStock = Object.values(item.variantStock).reduce((sum, stock) => sum + stock, 0);
                } else if (item.stock !== undefined && item.stock !== null) {
                    totalStock = item.stock;
                }
                
                const stockColor = totalStock <= 0 ? '#d32f2f' : totalStock <= 5 ? '#f57c00' : '#388e3c';
                
                return `
                    <div class="discount-item-manage">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${item.name}</div>
                            ${item.sku ? `<div style="font-size: 12px; color: #999;">${item.sku}</div>` : ''}
                            <div style="font-size: 13px; color: #666; margin-top: 2px;">${priceDisplay}</div>
                            <div style="font-size: 12px; color: ${stockColor}; margin-top: 2px;">庫存: ${totalStock}</div>
                            ${hasVariants ? '<div style="font-size: 11px; color: #999; margin-top: 2px;">有多規格</div>' : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="file-btn" onclick="editAddon(${index})">編輯</button>
                            <button class="remove-btn" onclick="removeAddon(${index})">刪除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 新增加購項目
        function addNewAddon() {
            const name = document.getElementById('addonName').value.trim();
            const price = parseInt(document.getElementById('addonPrice').value);
            
            if (!name) {
                alert('請輸入項目名稱');
                return;
            }
            
            if (isNaN(price) || price < 0) {
                alert('請輸入有效的價格');
                return;
            }
            
            // 生成新ID
            const newId = 'addon_' + Date.now();
            
            addOnItems.push({
                id: newId,
                name: name,
                price: price,
                type: 'custom'
            });
            
            // 清空表單
            document.getElementById('addonName').value = '';
            document.getElementById('addonPrice').value = '';
            
            loadAddonList();
            loadAddonItems();
            saveDataToLocalStorage();
            showNotification('✅ 加購項目已新增');
        }

        // 刪除加購項目
        function removeAddon(index) {
            if (confirm(`確定要刪除「${addOnItems[index].name}」嗎？`)) {
                addOnItems.splice(index, 1);
                loadAddonList();
                loadAddonItems();
                saveDataToLocalStorage();
                showNotification('✅ 加購項目已刪除');
            }
        }


        // 清除銷售記錄
        // 取消訂單(回加庫存)
        function cancelSalesOrder(index) {
            const sale = salesHistory[index];
            const orderNumber = sale.orderNumber || '無編號';
            
            if (sale.status === 'cancelled') {
                alert('此訂單已經取消過了');
                return;
            }
            
            if (!confirm(`確定要取消訂單 ${orderNumber} 嗎？\n\n取消後將：\n• 回復所有商品庫存\n• 訂單標記為「已取消」狀態\n• 保留訂單記錄但不計入統計\n\n此操作無法復原！`)) {
                return;
            }
            
            // 回加庫存
            sale.items.forEach(item => {
                // 只跳過折扣項目
                if (item.isDiscount) return;
                
                // 處理贈品的庫存回加
                if (item.isGift) {
                    const giftRule = giftRules.find(rule => rule.id === item.giftRuleId);
                    if (giftRule && giftRule.giftStock !== undefined) {
                        giftRule.giftStock += item.quantity;
                    }
                    return;
                }
                
                // 找到對應的商品或加購項目
                let targetItem = null;
                if (item.isAddon) {
                    // 加購項目
                    targetItem = addOnItems.find(addon => addon.id === item.id);
                } else {
                    // 一般商品
                    targetItem = products.find(p => p.id === item.id);
                }
                
                if (targetItem) {
                    // 如果有規格，回加對應規格的庫存
                    if (item.selectedVariants && Object.keys(item.selectedVariants).length > 0) {
                        if (targetItem.variantStock) {
                            const variantKey = Object.keys(targetItem.variants || {})
                                .map(key => item.selectedVariants[key])
                                .join(',');
                            if (targetItem.variantStock[variantKey] !== undefined) {
                                targetItem.variantStock[variantKey] += item.quantity;
                            }
                        }
                    } else {
                        // 沒有規格，回加一般庫存
                        if (targetItem.stock !== undefined) {
                            targetItem.stock += item.quantity;
                            
                            // 同時更新 productData
                            if (!item.isAddon && targetItem.brand && targetItem.mainCategory !== undefined) {
                                const pdBrand = targetItem.brand;
                                const pdMainCat = targetItem.mainCategory;
                                const pdSubCat = targetItem.subCategory || '';
                                
                                if (productData[pdBrand] && 
                                    productData[pdBrand][pdMainCat] && 
                                    productData[pdBrand][pdMainCat][pdSubCat]) {
                                    
                                    const pdIndex = productData[pdBrand][pdMainCat][pdSubCat].findIndex(p => 
                                        p.name === targetItem.name && p.brand === targetItem.brand
                                    );
                                    if (pdIndex !== -1) {
                                        productData[pdBrand][pdMainCat][pdSubCat][pdIndex].stock = targetItem.stock;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            // 標記訂單為已取消
            sale.status = 'cancelled';
            sale.cancelledAt = new Date().toISOString();
            sale.cancelledAtDisplay = new Date().toLocaleString('zh-TW');
            
            saveDataToLocalStorage();
            loadProducts(); // 重新載入商品列表以顯示更新後的庫存
            filterByTime(currentTimeFilter); // 重新套用當前篩選
            showNotification('✅ 訂單已取消，庫存已回復');
        }

        // 刪除訂單記錄(不影響庫存)
        function deleteSalesRecord(index) {
            const sale = salesHistory[index];
            const orderNumber = sale.orderNumber || '無編號';
            const statusText = sale.status === 'cancelled' ? '(已取消)' : '';
            
            if (confirm(`確定要刪除訂單 ${orderNumber} ${statusText}嗎？\n\n⚠️ 注意：刪除記錄不會影響庫存\n此操作無法復原！`)) {
                salesHistory.splice(index, 1);
                saveDataToLocalStorage();
                filterByTime(currentTimeFilter); // 重新套用當前篩選
                showNotification('✅ 訂單記錄已刪除');
            }
        }

        // 切換訂單詳情顯示（在Tab頁面中使用）
        function toggleSalesDetail(index) {
            const detailElement = document.getElementById(`salesDetail_${index}`);
            const isVisible = detailElement.style.display !== 'none';
            
            // 切換顯示/隱藏
            detailElement.style.display = isVisible ? 'none' : 'block';
            
            // 更新箭頭方向
            const allHeaders = document.querySelectorAll('.sales-record-order-number span:last-child');
            const reversedIndex = salesHistory.length - 1 - index;
            if (allHeaders[reversedIndex]) {
                allHeaders[reversedIndex].textContent = isVisible ? '▼' : '▲';
            }
        }

        // === 系統設定功能 ===
        
        // 社群平台選項
        const socialPlatforms = [
            { value: 'instagram', label: 'Instagram', icon: '📷' },
            { value: 'facebook', label: 'Facebook', icon: '👥' },
            { value: 'line', label: 'LINE', icon: '💬' },
            { value: 'youtube', label: 'YouTube', icon: '📺' },
            { value: 'tiktok', label: 'TikTok', icon: '🎵' },
            { value: 'twitter', label: 'Twitter/X', icon: '🐦' },
            { value: 'threads', label: 'Threads', icon: '🧵' },
            { value: 'whatsapp', label: 'WhatsApp', icon: '📱' },
            { value: 'telegram', label: 'Telegram', icon: '✈️' },
            { value: 'email', label: 'Email', icon: '📧' },
            { value: 'other', label: '其他', icon: '🔗' }
        ];
        
        // 打開系統設定
        function openSystemSettings() {
            // 載入當前設定到表單
            document.getElementById('setting_shopName').value = systemSettings.shopName || '';  // 改為空字串
            document.getElementById('setting_taxId').value = systemSettings.taxId || '';
            document.getElementById('setting_phone').value = systemSettings.phone || '';
            document.getElementById('setting_address').value = systemSettings.address || '';
            document.getElementById('setting_website').value = systemSettings.website || '';
            document.getElementById('setting_showTaxId').checked = systemSettings.showTaxId !== false;
            document.getElementById('setting_showPhone').checked = systemSettings.showPhone !== false;
            document.getElementById('setting_showAddress').checked = systemSettings.showAddress !== false;
            document.getElementById('setting_showWebsite').checked = systemSettings.showWebsite !== false;
            document.getElementById('setting_showSocial').checked = systemSettings.showSocial !== false;
            document.getElementById('setting_footerText').value = systemSettings.footerText || '感謝您的購買！\n歡迎再次光臨';
            
            // 載入社群連結
            loadSocialLinks();
            
            document.getElementById('systemSettingsModal').classList.add('show');
        }

        // 載入社群連結列表
        function loadSocialLinks() {
            const container = document.getElementById('socialLinksList');
            
            if (!systemSettings.socialLinks || systemSettings.socialLinks.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: #999; font-size: 13px;">尚未新增社群連結，點擊下方按鈕新增</div>';
                return;
            }
            
            container.innerHTML = systemSettings.socialLinks.map((link, index) => {
                const platformOptions = socialPlatforms.map(p => 
                    `<option value="${p.value}" ${link.platform === p.value ? 'selected' : ''}>${p.icon} ${p.label}</option>`
                ).join('');
                
                return `
                    <div class="social-link-item">
                        <select class="social-platform" data-index="${index}">${platformOptions}</select>
                        <input type="text" class="social-value" data-index="${index}" value="${link.value}" placeholder="請輸入帳號或連結" />
                        <button onclick="removeSocialLink(${index})">刪除</button>
                    </div>
                `;
            }).join('');
        }

        // 新增社群連結輸入框
        function addSocialLinkInput() {
            if (!systemSettings.socialLinks) {
                systemSettings.socialLinks = [];
            }
            
            systemSettings.socialLinks.push({
                platform: 'instagram',
                value: ''
            });
            
            loadSocialLinks();
        }

        // 刪除社群連結
        function removeSocialLink(index) {
            systemSettings.socialLinks.splice(index, 1);
            loadSocialLinks();
        }

        // 關閉系統設定
        function closeSystemSettings() {
            document.getElementById('systemSettingsModal').classList.remove('show');
        }

        // 儲存系統設定
        function saveSystemSettings() {
            // 收集社群連結
            const socialLinksData = [];
            const platformSelects = document.querySelectorAll('.social-platform');
            const valueInputs = document.querySelectorAll('.social-value');
            
            platformSelects.forEach((select, index) => {
                const value = valueInputs[index].value.trim();
                if (value) { // 只保存有填寫的
                    socialLinksData.push({
                        platform: select.value,
                        value: value
                    });
                }
            });
            
            systemSettings = {
                shopName: document.getElementById('setting_shopName').value.trim() || '',  // 改為空字串
                taxId: document.getElementById('setting_taxId').value.trim(),
                phone: document.getElementById('setting_phone').value.trim(),
                address: document.getElementById('setting_address').value.trim(),
                website: document.getElementById('setting_website').value.trim(),
                socialLinks: socialLinksData,
                showTaxId: document.getElementById('setting_showTaxId').checked,
                showPhone: document.getElementById('setting_showPhone').checked,
                showAddress: document.getElementById('setting_showAddress').checked,
                showWebsite: document.getElementById('setting_showWebsite').checked,
                showSocial: document.getElementById('setting_showSocial').checked,
                footerText: document.getElementById('setting_footerText').value
            };
            
            saveDataToLocalStorage();
            updateSystemTitle();  // 更新標題
            showNotification('✅ 設定已儲存');
            closeSystemSettings();
        }

        init();
    </script>
</body>
</html>